= Microsoft Azure Administrator Associate AZ-104
Thomas SCHWENDER <icon:github[] https://github.com/Ardemius/[GitHub] / icon:twitter[role="aqua"] https://twitter.com/thomasschwender[@thomasschwender]>
// Handling GitHub admonition blocks icons
ifndef::env-github[:icons: font]
ifdef::env-github[]
:status:
:outfilesuffix: .adoc
:caution-caption: :fire:
:important-caption: :exclamation:
:note-caption: :paperclip:
:tip-caption: :bulb:
:warning-caption: :warning:
endif::[]
:imagesdir: ./images
:resourcesdir: ./resources
:source-highlighter: highlightjs
:highlightjs-languages: asciidoc
// We must enable experimental attribute to display Keyboard, button, and menu macros
:experimental:
// Next 2 ones are to handle line breaks in some particular elements (list, footnotes, etc.)
:lb: pass:[<br> +]
:sb: pass:[<br>]
// check https://github.com/Ardemius/personal-wiki/wiki/AsciiDoctor-tips for tips on table of content in GitHub
:toc: macro
:toclevels: 4
// To number the sections of the table of contents
//:sectnums:
// Add an anchor with hyperlink before the section title
:sectanchors:
// To turn off figure caption labels and numbers
:figure-caption!:
// Same for examples
//:example-caption!:
// To turn off ALL captions
// :caption:

toc::[]

== Examen et ressources de préparation

Microsoft AZ-104 examen : https://learn.microsoft.com/en-us/certifications/exams/az-104/

Exam plan : 

    * Manage Azure identities and governance (20-25%)
    * Implement and manage storage (15-20%)
    * Deploy and manage Azure compute resources (20-25%)
    * Implement and manage virtual networking (15-20%)
    * Monitor and maintain Azure resources (10-15%)

Déroulement de la certification :

    * Exam Duration 120 mins
    * Number of Questions 40-60 Questions
    * Pass Score 700 (on a scale of 1-1000)

Description précise des connaissances à posséder pour la certification par Microsoft : +
https://query.prod.cms.rt.microsoft.com/cms/api/am/binary/RE4pCWy

[NOTE]
==== 
Pour plus d'informations sur la certification AZ-104 (nombre de questions, passing score, etc.), voir la description faite par *testprep training* : +
https://www.testpreptraining.com/microsoft-azure-administrator-associate-az-104

Le site propose également un *AZ-104 Online Tutorial* : https://www.testpreptraining.com/tutorial/exam-az-104-microsoft-azure-administrator-associate/
====

[NOTE]
====
Pour un *poster des certifications Microsoft*, très régulièrement mis à jour, voir https://aka.ms/certificationsposter
====

== Cours de PHILIT sur les certifications AZ-104 et l'AZ-305

* De mon côté, je vais commencer par suivre les cours en ligne de PHILIT : https://www.youtube.com/playlist?list=PLxf9spw2semSHqq8XvRaiT9HNWzO054MT +
-> Il s'agit en fait de Philippe PAIOLA (philippe.paiola (symbol goes here) gmail.com)
    ** Philippe a été formateur Microsoft

[TIP]
====
Philippe fait partie du Club Azure Insiders et poste régulièrement sur le Teams associé 😉

-> Et pour ce que j'en vois, Philippe doit maintenant faire partie de Microsoft, il a une adresse interne : philippe.paiola (symbol goes here) microsoft.com
====

Ressources conseillées par PHILIT pour se préparer à la certification : 

    * La *documentation Microsoft Learn* : https://docs.microsoft.com/fr-FR/learn/certifications/roles/administrator
        ** Parcours de formation Microsoft Learn AZ-104 Microsoft Azure Administrator : +
        https://learn.microsoft.com/fr-FR/credentials/certifications/exams/az-104/

    * Le blog de Thomas MAURER : https://www.thomasmaurer.ch/2020/03/az-104-study-guide-azure-administrator/

=== AZ-104 EP01 : Azure AD (AAD) & VNet

URL vidéo PHILIT : https://www.youtube.com/watch?v=JoGL_Q7ihG8&list=PLxf9spw2semSHqq8XvRaiT9HNWzO054MT&index=1

==== Identité et ADD

* les identités sont stockées dans l'*Azure Active Directory* (*AAD*) : ce service va permettre de gérer nos identités Cloud

* 3 formes d'identité : 

    ** *Identité membre* (ou Cloud Native) : elle est issue de notre instance de l'AAD 
        
        *** Rappel : *instance de l'AAD = tenant*.

            **** 1 *tenant* est une *instance de l'AAD* qui est dédiée à un client.
            **** Chaque client de Microsoft a 1 tenant qui lui est dédié et qui est unique. +
            -> 2 clients ne peuvent pas avoir le même tenant
            **** Ce tenant est souvent représenté par un nom de domaine qui correspond souvent au nom du client. +
            Exemple : "laposte.onmicrosoft.com" ou "toto.onmicrosoft.com"
        
        *** Donc, l'identité va être de type "user@toto.onmicrosoft.com"

    ** *Identité synchronisée* : elle est issue de votre AD on-premises (ce dernier est souvent représenté par un triangle)
        *** cet AD on-premises est bien souvent au nom de la société : toto.com
        *** cet AD va contenir : 
            **** des DC : Domain Controller / contrôleurs de domaines
                ***** un DC est une version server de notre système d'exploitation (OS). +
                Donc Windows server 2016 / 2019 peut devenir un contrôleur de domaine en ajoutant le rôle.
            **** des groupes
            **** des ordinateurs

        *** un utilisateur va ici être "user@toto.com"
            **** donc cela peut être notre email professionnel

        *** On se retrouve avec un Domain Active Directory qui va avoir plusieurs DC
            
            **** On va créer une VM sur l'AD, et sur cette VM on va installer le produit *AAD Connect* (Azure AD Connect). +
            Le but de AAD Connect va être de se connecter à mon DC, de récupérer la liste des users et des groupes, et de transférer ces users et groupes dans votre tenant AAD. +
            image:AZ-104_AAD-VNet_01.jpg[]

            **** Et pour permettre que ces identités on-premises soient bien synchronisées sur l'AAD, je vais aller dans le portail Azure, dans l'AAD, et dans *Custom domain names* je vais rajouter le nom de domaine "toto.com" (le nom de domain venant du on-premises)

    ** *Identité Guest* : un "invité" est un utilisateur qui vient d'un autre tenant
        *** "qui vient d'un autre tenant" : attention à cette expression, d'après mes recherches, cela *peut tout simplement être un utilisateur externe* qui n'a encore aucun compte sur un AD ou AAD.
        *** Exemple d'un prestataire d'ESN qui va être embauché pour travailler avec le tenant de la société toto.com. +
        Pour que cela se fasse, il va avoir besoin d'une *invitation* : une personne chez toto.com va devoir inviter l'utilisateur à se joindre au tenant de toto.onmicrosoft.com, ce qui va lui permettre d'avoir accès à un abonnement (subscription)

.Pour résumer sur les identités
[NOTE]
====
* Le *tenant* est la *représentation des identités d'une entreprise dans le Cloud Azure*
* Ce tenant est livré en "xxx.onmicrosoft.com"
* Dans ce tenant, on va retrouver 3 types d'identités : membre / identité synchronisée / Guest


* Un tenant va toujours être rattaché à 1 ou plusieurs abonnements / subscriptions
    ** L'abonnement / subscription est ce qui va contenir nos ressources Cloud : VMs, BDDs, storage account, IA, etc.
    ** Cet abonnement / subscription est une frontière d'administration et de facturation des ressources Cloud de la société
    ** Pour *accéder à ces ressources*, on va avoir besoin d'un *système d'identités*, et ce dernier c'est le *tenant Azure Active Directory*
* Un abonnement / subscription Azure a toujours une référence à un tenant.
* Et ce tenant contient des identités qui permettront, via l'Access Control (IAM) de donner des droits à des utilisateurs ou à des groupes.
* Et ces utilisateurs sont soit membre (cloud natif), soit synchronisé, soit invité (guest).
====

WARNING: Un utilisateur qui est dans mon tenant n'a, par défaut, aucun accès sur mes ressources Azure

.Tenant vs Directory vs Domain in AAD
[NOTE]
====
FAIRE VRAIMENT TRES ATTENTION, on trouve souvent de très mauvaises explications des relations entre ces 3 concepts, surtout entre tenant et directory. +
-> Certaines sont mêmes tout simplement fausses, alors même qu'elles sont données par un IT de Microsoft... 😓

Néanmoins, voici un post de 2020/08 d'un IT de Microsoft sur les forums tech de Microsoft qui répond bien et précisément à la question : +
https://techcommunity.microsoft.com/t5/azure/relationship-between-azure-active-directory-and-directory-tenant/m-p/1607755/highlight/true#M5873 

--
I understand your confusion. I agree there are several "terms" in Azure that seem to overlap or could be synonyms. In addition, you might see these terms used inconsistently in the Portal UI or documentation.

I always try to approach it from the practical point of view, for example:

    * Can I create a new Azure AD tenant and if yes, how is it related to my existing environment?
    * Can I create several directories under that tenant?
    * Can I have several domains under my tenant?

I like to use this article written for AAD developers as a reference: https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-create-new-tenant#use-an-...

I saw some confusing or even wrong replies in the "linked" topic like someone claiming you can have several directories under one AAD tenant.

I see it this way : *Azure AD tenant = directory*, and *there is a strict 1:1 relationship between them* (you cannot create several directories under a tenant). Each tenant has it's globally unique '*tenant ID*' (in some places in the Portal referred as '*directory ID*', but *the ID is the same*)

*When you use 'Switch directories'* option in the Portal, *you are authenticating to a different AAD tenant* (your account was invited as a guest there via Azure AD B2B Collaboration), so you will see different subscriptions and resources, and have different permissions, when you do so. Since most organizations have one production tenant (but some like ISVs can have more), you are switching to a different "company". That's how I see it.

You can, however, have several domains under one tenant / directory. You always get a default one {something}.onmicrosoft.com, but you can onboard custom domains (like contoso.com) upon proving you own that domain.
--

-> J'ai demandé des précisions à Microsoft sur ce point via les Q&A de Microsoft Learn : +
https://learn.microsoft.com/en-us/answers/questions/1457968/help-me-to-understand-the-concepts-of-tenant-direc
====

* Création d'un *custom role*
    ** le *scope* est vraiment la *portée* du rôle
    ** le rôle est représenté par un fichier JSON

[WARNING]
====
La maintenance d'un *custom role* est réputée compliquée. +
-> Contrairement à un *built-in role*, les custom role ne sont PAS mis à jour automatiquement lors des mises à jour des services.
====

* Les utilisateurs d'un tenant peuvent avoir des rôles RBAC sur les ressources Azure *ET* sur le tenant lui-même. +
Donc au final sur *Azure*, il y a *2 types de rôles* : ceux *sur le tenant*, et ceux *sur vos ressources Azure* : 

    ** *rôles dit "RBAC"* -> rôles sur vos ressources Azure

    ** *rôles sur le tenant* -> rôles qui vous permettent de gérer vos identités
        *** exemple : "Billing administrator" pour gérer la facturation des logiciels, des licences que vous avez installés sur votre tenant

NOTE: On peut ajouter des licences à un tenant pour lui ajouter des fonctionnalités supplémentaires

* L'*Azure Active Directory* sert également à la *publication de vos applications*.
    ** voir https://myapps.microsoft.com/[] pour visualiser les applications publiées sur votre tenant

* Les *applications publiées dans le tenant*, pour qu'elles fonctionnent et soient trustées par le tenant et vos utilisateurs, *doivent être inscrites dans le tenant*.
    ** Pour ce faire, on passe par le Portail Azure, "Azure AD / Enterprise applications / All applications", puis "create your own application"
    ** Pour cette inscription dans le tenant, Azure va créer un *compte de service* qui représente cette application, ce dernier est appelé *service principal*.
        *** Le service principal est un compte d'application qui représente votre application dans le tenant.
        *** Le service principal est un compte managé par Microsoft : il a une durée de vie, un certificat associé, et va permettre, quand vous publiez une application, de la rendre disponible à vos utilisateurs.

* Auparavant, pour *accéder à un AD on-premises*, on utilisait le protocole *LDAP*. +
Et pour *s'authentifier à cet AD on-premises*, il y avait 2 moyens : 
    ** utiliser le protocole *Kerberos*
    ** utiliser le protocole *NTLM* (un vieux protocol d'authentification apparu avec Windows NT ou Windows 2000)

    ** -> Ces 2 méthodes d'authentification permettaient via des requêtes LDAP d'accéder à votre AD on-premises.

* Aucun de ces protocols, LDAP, Kerberos ou NTLM n'est utilisé dans l'Azure AD.
* Pour pouvoir accéder à l'Azure AD, pour pouvoir vous y connecter, vous allez au préalable passer par du HTTPS. +
Puis, une fois connecté, vous allez pouvoir utiliser l'un des protocoles suivants pour pouvoir interroger l'Azure AD :  
    ** SAML
    ** WS Federation
    ** OAuth 2.0 et OpenID Connect

* Je vais également pouvoir déléguer l'authentification de mes utilisateurs à des tiers comme Google, Facebook, ou utiliser le protocole SAML / WS-fed
    ** Pour faire, aller dans son tenant, dans "external identities" puis "all identity providers"
* Donc il ne faut pas croire que le tenant AAD va permettre de gérer tous les cas de figures, on peut *déléguer l'authentification de certains types d'utilisateurs pour certaines applications à des fournisseurs d'identités externes*.
    ** C'est très utile lors de la création d'une *web app* qui a *par défaut* un *accès anonyme* : n'importe qui connaissant son IP publique ou son nom de domaine peut y accéder. Avec ce système, on va pouvoir rajouter une surcouche d'authentification à la web app pour lui permettre d'être authentifiée par des utilisateurs particuliers

* *DEMO* de la création de cette *surcouche d'authentification pour une Web app* : https://youtu.be/JoGL_Q7ihG8?t=3069[] 
+
video::JoGL_Q7ihG8?t=3069[youtube, width=800, height=600]

    ** Pour ce faire, on va utiliser un service principal qui va représenter cette web app dans l'Azure AD
    ** Création d'une *web app* : 1 à 2 min et *par défaut elle va avoir un accès public*

.Rappel sur les web apps
[NOTE]
====
Une web app est un service web (une application web ou un site web) qui est hébergé ET managé par Microsoft. +
La logique est de ne PAS avoir à gérer le système d'exploitation. +
On peut faire du SSH dessus ou utiliser des commandes PowerShell, mais cela a lieu dans un environnement très cloisonné et très fermé.

Et comme tout service Azure PaaS, *par défaut*, la *web app* a une *IP publique* et un *nom de domaine* qui lui sont associés.
====

    ** Pour "casser" cette logique d'accès anonyme à la web app, dans la web app, dans "authentication", je vais rajouter un fournisseur d'identité ("add identity provider") : je veux que ceux qui accèdent à ma web app aient un compte dans mon tenant.
    ** Et je vais choisir "require authentication" plutôt que "allow unauthenticated access"

==== VNet, subnet, NIC, NSG

.VNet, subnet, NIC, VM, NSG
image:AZ-104_AAD-VNet_02.jpg[]

* VNet = espace d'adressage, voir RFC 1918 "Adress Allocation for Private Internets" : https://datatracker.ietf.org/doc/html/rfc1918[]
    ** Cette RFC définit 3 espaces d'adressage (plages d'adresses) qui ne sont pas accessibles directement depuis Internet, des adressages dits *"non routables"* ; aucun serveur sur Internet ne peut utiliser ces adresses, qu'on appelle également des *adresses IP privées* : 
        *** 192.168
        *** 10.0
        *** 172.16
    ** Par défaut, 2 VNets (par exemple, un en 192.168 et un en 10.0) ne peuvent PAS communiquer ensemble. +
    Les subnets de ces VNets ne pourront pas communiquer ensemble.

* Un même VNet peut contenir ces 3 espaces d'adressage, il n'est PAS limité à 1 seul

* Un VNet va être compartimenté en 1 ou plusieurs *subnets* (sous-réseaux), comme un pizza que l'on couperait en morceaux avant de la manger
    ** *On ne peut PAS prendre les 3 premières IP d'un subnet*, car réservées par Microsoft à la gestion DNS et la gestion des passerelles. +
    Toute la couche réseau et toute la couche IPAM dans Azure est dévolu à Microsoft
        *** Exemple : si mon subnet est en 10.0.0.0/24, je ne pourrais pas utiliser les IP 10.0.0.1, 10.0.0.2, 10.0.0.3. +
        Donc, ma NIC, si c'est la 1ere du subnet, sera en 10.0.0.4
    ** Dans les faits, les IPs 0 et 255 sont également réservées par Microsoft : 
        *** la *"0"* (10.0.0.0 dans l'exemple précédent) est l'*adresse de réseau* : c'est l'adresse IP de base du subnet qui est utilisée pour l'identifier.
        *** la *"255"* est l'IP de broadcast (Network broadcast address) : elle est utilisée pour envoyer des paquets à tous les appareils du sous-réseau
    
* A tout moment, *on peut changer l'espace d'adressage d'un VNet*
    ** mais on ne peut pas réduire la taille d'un VNet en-dessous de la taille d'un de ses subnets
* On ne peut modifier la taille d'un subnet qu'AVANT de lui avoir ajouté une ressource (comme une NIC), cela devient impossible après
    ** et la modification d'un subnet ne peut se faire qu'en respectant la limite de taille du VNet

* Dans un Subnet, on va souvent retrouver une *NIC* (*Network Interface Card*). +
Une NIC est une carte réseau qui va contenir : 
    ** *obligatoirement* une *IP privée*
        *** Les adressages IP privés sur Azure sont toujours *gratuites*
    ** *facultativement* une *IP publique*
        *** Les adressages IP publiques sont payantes (de l'ordre de 1€ par mois à vérifier)

    ** ces 2 IPs peuvent être : 
        *** *dynamique* : elle risque de changer à chaque redémarrage de la VM
        *** *statique*

* Cette NIC va souvent être associée à une VM, et une VM doit TOUJOURS avoir une NIC : *une VM Azure sans NIC, cela n'existe pas*
    ** Donc une VM dans Azure a toujours une IP privée, mais pas systématiquement une IP publique

TIP: Donc, cf explication précédente, si on trouve une NIC dans un subnet, on ne peut donc plus modifier la taille de ce subnet

* Les *subnets* peuvent *par défaut communiquer en entrant et en sortant entre eux*.
    ** Ces communications sont autorisées pour 2 raisons : 

        *** les routes sont automatiquement propagées dans les subnets via un système appelé les *system routes* +
        Les system routes : possibilité offerte par Azure de gérer les nouveaux subnets qui seraient créés dans votre VNet de façon à leur permettre de communiquer avec les autres subnets (propagation des routes automatisée)
            **** ⚠️ Attention ! Les system routes gèrent *les subnet d'un MEME VNet*.
            **** Voir la doc Microsoft sur les system routes : https://learn.microsoft.com/en-us/azure/virtual-network/virtual-networks-udr-overview#system-routes
            **** Donc il y a des routes qui sont automatiquement gérées par Azure et que l'on ne peut PAS modifier

        *** Entre les subnets, il n'y a PAS de firewall. Donc, si on veut filtrer les flux, il va falloir ajouter un *NSG* (*Network Security Group*)
            **** *Le NSG est un firewall* qui va servir à filtrer les flux entrants et sortants.

        *** Le NSG peut être attribué à une *NIC ET / OU à un subnet* (ou à plusieurs subnets) : 
            **** *attribué à une NIC* : dans ce cas il va protéger l'IP privée et l'IP publique de votre VM
            **** *attribué à un subnet* : il va alors filtrer les communications entre les différents subnets et entre les subnets et les réseaux distants (que ce soit Internet, ou une liaison VPN, ou une ExpressRoute)
            **** En l'absence de NSG associée à la carte réseau / NIC de ma VM, cette dernière devra être protégée par le firewall de l'OS (Windows avec les pare-feu fonctions avancées, ou Linux avec IPTables)
        
        *** Seule limitation du NSG : il doit être dans la même région que les ressources à protéger. +
        Pour un VNet en North Europe, il faut obligatoirement créer un NSG en North Europe pour le protéger

* Dans la section "Virtual Network" du portal Azure, il est possible de faire *générer un diagramme réseau du VNet* via le menu *"Diagram"* : +
image:AZ-104_AAD-VNet_03.jpg[]
    ** Dans le diagramme donné en exemple, on peut voir que : 
        *** le VNet a 3 subnets
        *** que le subnet "Production" a une NIC
        *** que cette NIC est rattachée à une VM, à une IP publique et à un NSG

.Toujours une NIC "primary" pour une VM
[NOTE]
====
Toute VM Azure a obligatoirement une NIC "primary" : +
image:AZ-104_AAD-VNet_04.jpg[]

Cela parce qu'une VM peut avoir plusieurs NIC, et donc autant d'adresses IP différentes. +
Mais même si une VM a 200 NICs, et donc 200 IPs différentes, il y aura toujours une NIC "primary"

Cette NIC primary va surtout *servir pour tout ce qui est routage*, pour *"avoir le dernier mot"*.
====

* "Bon à savoir" de Philippe : même si on laisse l'IP publique d'une VM en dynamique (donc changement à chaque arrêt / redémarrage), on peut y associer un DNS géré par Microsoft pour pouvoir toujours y accéder via un même nom DNS.

* Les *NSG* sont dotés de *règles de filtrage par défaut*, *classées par priorité* et que l'*on ne peut pas supprimer* : 

    ** *Flux entrants* : 
        *** prio 65000 - "AllowVnetInBound" : toutes les communications au sein d'un VNet entre les subnets sont autorisées
        *** prio 65001 - "AllowAzureLoadBalancerInBound" : un load balancer Azure doit pouvoir accéder aux VMs qui sont dans un subnet (logique, c'est le principe d'un load balancer)
        *** prio 65500 - "DenyAllInBound" : "on refuse tout"

    ** -> On peut pas supprimer ces règles MAIS on peut en créer d'autres avec une plus forte priorité (priorité plus forte = nombre plus petit)

    ** *Flux sortants* : 
        *** On retrouve 2 règles similaires aux flux entrants : "AllowVnetOutBound" et "DenyAllOutBound"
        *** et 1 nouvelle règle "AllowInternetOutbound" en prio 65001 : le trafic sortant sur une VM Azure est autorisé vers internet
            **** Exemple : si on lance un navigateur sur une VM Azure et qu'on tape www.google.fr, on pourra s'y connecter via Internet

.Effective Security Rules : Comment s'y retrouver parmi un trop grand nombre de règles NSG ? Qu'est-ce qui s'applique réellement au final ?
[NOTE]
====
Dans votre NSG, vous avez un menu *"Effective security rules"* correspondant à une fonctionnalité d'Azure qui va "réfléchir pour vous", en fonction des priorités des règles, du deny et du allow, à celles qui s'appliquent réellement au final. +
Celles-ci seront fournies sont forme de tableau.
====

* Le menu *"NSG Flow logs"* de votre NSG vous permet de visualiser à tout moment les logs de ses flux entrant et sortant.
    ** Cela nécessite de mapper son NSG à un storage account et de définir une rétention pour les logs
+
WARNING: Par défaut, rien n'est conservé, c'est à nous d'activer et de configurer ces logs

=== AZ-104 EP02 : Hub & Spoke et Azure Backup

URL vidéo PHILIT : https://www.youtube.com/watch?v=EbZLEcDVF8g&list=PLxf9spw2semSHqq8XvRaiT9HNWzO054MT&index=2

==== Hub & spoke (peering, UDR, NVA...)

Rappel : Par défaut, 2 VNets (par exemple, un en 192.168 et un en 10.0) ne peuvent PAS communiquer ensemble. +
image:AZ-104_Hub-Spoke-backup_01.jpg[] +
(Dans l'exemple du schéma, chaque VNet n'a qu'un seul subnet, qui occupe tout l'espace d'adressage du VNet)

* Si je veux permettre la communication entre ces VNets, je vais avoir 2 options : 

    ** le *peering* : beaucoup d'avantages pour cette solution, dont un faible coût et simple à mettre en oeuvre. +
    Le peering consiste à raccorder entre eux les 2 VNets de façon à montrer à Azure qu'ils ne forment en fait qu'1 seul VNet "logique" (avec 2 subnets dans notre exemple)
        *** Pour que cela fonctionne, il faut que *les espaces d'adressage des 2 VNets soient différents* / ne se chevauchent pas.

    ** le *"VNet to VNet"* : dans cette solution, Azure va créer un *VPN site à site entre les 2 VNets*. +
    Le protocole *IPSec* (Internet Protocol Security) va être utilisé par ce VPN pour assurer le chiffrement des flux qui circulent entre les 2 VNets.
        *** Contrairement au peering, le VNet to VNet est cher, long à mettre en place, pas forcément très compliqué, mais c'est une techno qui "date un peu". +
        -> Très souvent en entreprise, *on lui préfère le peering*.

image:AZ-104_Hub-Spoke-backup_02.jpg[]
    
.En quoi la connectivité VNet to VNet est-elle plus chère que le peering ?
[NOTE]
====
* *Moins de ressources réseau* :

    ** Le *peering VNet* utilise l'*infrastructure dorsale Microsoft* (fait partie du réseau mondial Microsoft) pour établir une connexion directe entre les réseaux virtuels.
    ** La *connectivité VNet à VNet*, en revanche, nécessite des *passerelles VPN virtuelles* et des *tunnels VPN* pour acheminer le trafic entre les réseaux virtuels. Cela implique une utilisation accrue des ressources réseau, ce qui se traduit par des coûts plus élevés.

* *Pas de frais de transfert de données* :

    ** Le peering VNet ne facture pas de frais de transfert de données pour le trafic entre les réseaux virtuels pairs.
    ** La connectivité VNet à VNet, en revanche, facture des frais de transfert de données pour le trafic transitant par les passerelles VPN.

* *Facilité d'utilisation* : Le peering VNet est simple à configurer et à gérer, là où la connectivité VNet à VNet est plus complexe à mettre en place et à administrer, ce qui peut entraîner des coûts supplémentaires.
====

.Réseau mondial Microsoft et WAN Microsoft, Infrastructure dorsale et frontale
[NOTE]
====
* *Réseau mondial Microsoft* :
    ** Définition: Il s'agit de l'infrastructure physique et logicielle qui connecte les centres de données Microsoft à travers le monde.
    ** Composants: Il inclut l'*infrastructure dorsale Microsoft*, les *centres de données*, les points de présence et les réseaux métropolitains.
        
        *** *Infrastructure dorsale* (Backhaul, le "cœur" du réseau) : Transporte les données sur de longues distances entre les centres de données, les points de présence et les réseaux métropolitains.
        *** *Infrastructure frontale* (Fronthaul,  la "périphérie" du réseau) : Relie les utilisateurs finaux aux réseaux de communication, généralement sur la dernière portion du trajet.

    ** Fonction: Il achemine le trafic entre les services Microsoft et les clients à travers le monde.

* *WAN mondial Microsoft* (réseau étendu mondial Microsoft) :
    ** Définition: Il s'agit d'un service Azure qui permet aux entreprises de créer et de gérer un réseau privé virtuel (VPN) mondial.
    ** Composants: Il utilise le réseau mondial Microsoft comme infrastructure sous-jacente.
    ** Fonction: Il permet aux entreprises de connecter leurs sites distants et leurs utilisateurs à leurs applications et données dans le cloud Azure.

En résumé:

    * Le réseau mondial Microsoft est l'infrastructure physique et logicielle qui permet aux services Microsoft de fonctionner.
    * Le WAN mondial Microsoft est un service Azure qui utilise le réseau mondial Microsoft pour créer un VPN mondial pour les entreprises.
====

*PEERING* :

image:AZ-104_Hub-Spoke-backup_03.jpg[]

    * *Très facile à mettre en place* : le mettre en place entre 2 VNets prend *2 min*
    * *Pas cher* : Microsoft va juste facturer la bande passante entre  les 2 VNets
        ** et le *coût de la bande passante entre 2 VNets*, surtout dans une même région, n'est pas très élevé 0.01€ / Go pour de l'inbound ou outbound data transfer (voir https://azure.microsoft.com/en-us/pricing/details/virtual-network/ et https://azure.microsoft.com/en-us/pricing/details/bandwidth/)

    * Peering regional : entre 2 VNets dans la même région
    * Peering global : entre 2 VNets dans 2 régions différentes (donc le peering peut être *multi-région*)
        ** coût plus élevé que le peering regional, voir les 2 liens précédents
    
    * Le peering est *multi-abonnement* (*multi-suscription*) : une entreprise possédant plusieurs souscriptions peut raccorder des VNets dans ces différentes souscriptions.
    
    * Le peering est *multi-tenant* : On va pouvoir *raccorder 2 VNets de 2 clients différents* (donc 2 clients différents vont pouvoir communiquer entre eux)
        ** Rappel : 1 tenant représente les identités d'un client. +
        Si on a 2 tenants, c'est qu'on est face à 2 clients différents
        ** Pour faire ce raccordement multi-tenant, il faut avoir un compte autorisé dans les 2 tenants, il y a plusieurs manips à faire, MAIS c'est possible
    
    * Le peering utilise le *protocole MACsec* (Media Access Control security), et permet de *chiffrer les flux* traversant les équipements Microsoft
        ** MAIS le chiffrement n'est *PAS activé par défaut*.
        ** MACsec ne chiffre que les flux entre les deux VNets. Il ne chiffre pas les flux entre les VNets et Internet ou entre les VNets et d'autres réseaux.
+
.Des détails sur le protocole MACsec
[NOTE]
====
* MACsec uses a combination of *data integrity checks* and *encryption* to secure traffic traversing the link
    ** Voir https://www.juniper.net/documentation/us/en/software/junos/security-services/topics/topic-map/understanding_media_access_control_security_qfx_ex.html[]

* Media Access Control Security (MACsec) is a *layer2 security protocol* standardized by the IEEE that operates on Ethernet frames. It uses *AES GCM cryptography* with 128-bit key and 256-bit key versions. MACsec is designed to provide *authentication*, *confidentiality* and *integrity* for data transported on *point-to-point links in the enterprise Local Area Network (LAN)* using the Advanced Encryption Standard with Galois/Counter Mode (AES-GCM) data cryptography algorithm.
    ** Voir https://www.comcores.com/what-is-macsec/
====

*DEMO : création de peering entre VNet Hub et VNet Spoke*
 
image:AZ-104_Hub-Spoke-backup_06.jpg[width=700]

    * on commence par créer les 2 VNets
    * puis, sur l'un d'eux, on va dans "peerings", puis "add" pour ajouter un peering dans les 2 sens : VNet Hub vers VNet Spoke ET VNet Spoke vers VNet Hub

    * Option "Traffic to remote virtual network" : doit toujours être activée, le trafic devant se faire dans les 2 sens. +
    Si on bloque l'un des sens, le peering ne pourra PAS se faire (raison pour laquelle la valeur par défaut est "allow")

    * Option "*Traffic forwarded* from remote virtual network"
        ** Si j'ai créé 2 VNet spoke, tous 2 reliés à un même VNet hub, si mon hub reçoit un flux qui ne lui est pas destiné, MAIS qui est destiné à un VNet avec lequel il est peeré, *le hub va laisser passer le flux*.
        ** Donc, dans le mon exemple, le trafic forwarding permet à VNet Hub, s'il reçoit un flux de VNet spoke à destination de VNet spoke 2, de le laisser passer : (flèche verte sur le schéma ci-dessous)
        image:AZ-104_Hub-Spoke-backup_04.jpg[]

    * Option "Virtual Network Gateway or Route Server" pour le *partage de la VNG* (Virtual Network Gateway) ou de l'ARS (Azure Route Server)
        ** En tant que VNet Hub, si on a une liaison VPN site à site (S2S) avec son réseau on-premises, on va pouvoir partager cette liaison site à site avec ses VNets spoke. +
        Un VNet spoke va donc pouvoir passer par le VNet hub pour accéder au réseau on-premises, et le réseau on-premises va pouvoir passer par le VNet hub pour accéder à un VNet spoke : +
        image:AZ-104_Hub-Spoke-backup_05.jpg[]
        ** Le partage de la VNG vous permet, en tant que hub, de partager votre connexion VPN avec vos spoke et votre réseau on-premises
    
        ** La VNG est la représentation de mon VPN dans Azure : c'est un VPN avec une IP publique qui est managé par Microsoft

    * Les mêmes options sont disponibles pour la connexion entre le Hub et le Spoke que pour celle entre le Spoke et le Hub.

    * Lorsque l'on clique sur "Add", on voit bien que Azure *crée le peering dans les 2 sens* : +
    image:AZ-104_Hub-Spoke-backup_07.jpg[]
        ** Il faut 20 à 30 sec pour que le peering soit effectif (peering status "connected")

[WARNING]
====
Là, on vient de voir une démo "théorique" de peering car entre 2 VNets uniquement, mais dans la *"vraie vie"* le *"Hub and Spoke"* n'est pas entre 2 VNets uniquement mais entre *plusieurs VNets* : 3 (minimum), 4, voire des centaines de VNets.

-> Quand on a plusieurs VNets de raccordés avec le Hub, on rentre dans une *topologie d'architecture* appelée le *"Hub and Spoke"*. +
On retrouve cette topologie d'architecture chez la plupart des Cloud providers (AWS, GCP) : +
Une "étoile" avec un point central, le hub, raccordé à toutes ses extrémités, les spokes : UN hub et DES spokes.
====

*HUB and SPOKE* (pour une infra 100% Azure uniquement, et PAS hybride) :

* le *hub* : va contenir tous les "services partagés" (que l'on ne va donc pas avoir besoin de redéployer dans les différents spokes) : 
    ** DC : les contrôleurs de domaines
    ** LB : les load balancers
    ** FW : les firewalls
    ** mon bastion

* le *spoke* : un spoke est déjà un VNet. 

    ** Il va pouvoir *représenter un environnement* : DEV, PROD, etc. +
    A chacun d'eux va être associé un subnet, on va donc avoir *un VNet et plusieurs subnets*.

    ** un spoke peut également *être un VNet hébergé chez un tiers*.
        *** Exemple : imaginez que vous travaillez avec une société partenaire qui édite un soft de notes de frais, hébergé sur Azure. +
        Vous souhaitez peut-être que vos collaborateurs accèdent à ce soft directement au travers d'un IP privée. +
        Pour ce faire, on va peerer notre hub avec un spoke qui contient l'infrastructure de gestion de notes de frais proposée par la société partenaire.

En résumé : 

    * *Le peering* est fait pour *peerer des environnements d'applicatifs* hébergés dans Azure, en PROD, PrePROD, etc. qui sont représentés par des spokes
    * Mais cela peut aussi être *peerer un VNet distant* d'un partenaire d'une autre société pour pouvoir exploiter le logiciel qu'elle nous met à disposition en *mode PaaS*.
    * le peering est la jonction de 2 VNets entre eux et le Hub and Spoke est une topologie d'architecture qui va nous permettre de faire des économies.

Comment le *Hub and Spoke* permet-il de *faire des économies* ?

    * Tous les services partagés du Hub vont pouvoir être partagés via le peering avec les spokes.
        ** Sans cela, si par exemple dans le spoke Dev du précédent schéma on avait eu besoin d'authentification AD, il aurait fallu déployer nos DC dans le spoke. Idem pour tous les autres spokes ayant besoin d'accéder à l'AD.

*Focus sur le peering dans le cas de la topologie d'architecture Hub and Spoke* : 

    * Pour fonctionner, le Hub and Spoke a *besoin d'autres services Azure* que le seul peering : +
    image:AZ-104_Hub-Spoke-backup_08.jpg[width=600]

        ** des *UDR*, User Defined Routes : une *table de routage* statique que l'on va appliquer à des subnets
            *** Une UDR peut être associée à plusieurs subnets MAIS un subnet ne peut être associé qu'à une seule UDR
        ** la fonctionnalité de *Traffic Forwarded*
        ** une *NVA*, Network Virtual Appliance : soit c'est une VM sur laquelle on a installé le rôle "Routing and remote access", soit un Azure Firewall (ou un autre firewall comme du F5, du Fortinet, etc. L'avantage de l'Azure Firewall est d'être un service managé par Microsoft, c'est du PaaS)
+
.Définition d'une NVA
[NOTE]
====
* Azure Network Virtual Appliances (NVAs) are instrumental in *enhancing high availability* and *controlling traffic flows* within Azure applications. +
They are particularly significant in *constructing demilitarized zones (DMZ)* in the cloud. 

* NVAs in Azure *scrutinize all incoming and outgoing traffic*, *permitting only the traffic that complies with predefined rules*, thus ensuring a secure network boundary.

-> The main purpose of an Azure NVA is to *handle and secure network traffic* in Azure cloud by doing *routing*, *firewall*, *load balancing*, *intrusion detection*, etc.)

Ressources : 

    * What is Azure Network Virtual Appliance (NVA) ? : https://aviatrix.com/learn-center/cloud-security/azure-network-virtual-appliance/
    * What is An Azure NVA (Network Virtual Appliance) (2024/06/13) : https://www.geeksforgeeks.org/azure-network-virtual-appliance/
====

    * -> Tout ceci permet de *faire transiter les flux* entre un hub et un spoke qui veut communiquer avec un autre spoke
    
    * Dans le cas de l'exemple précédent, si VNet-Spoke veut communiquer avec VNet-Spoke2, il va falloir : +
    image:AZ-104_Hub-Spoke-backup_09.jpg[width=600]

        ** appliquer une *UDR* au subnet de VNet-Spoke
            *** cette UDR, une table de routage, va dire que, pour accéder à 172.16.0.0/24 (correspond à VNet-Spoke2), il va falloir que le prochain *bond* soit l'IP privée de ma NVA, donc ici de l'Azure Firewall qui va être créé dans le hub
        ** La *NVA*, Azure Firewall ou VM Windows, va être déployée dans le Hub et va faire office de router : elle va router les paquets entre les différents spokes.
        ** le *Traffic Forwarded* : son rôle est de laisser les paquets transiter entre vos VNet-Spoke et VNet-Spoke2 en passant par le hub
    
    * -> Tout ceci va rendre le hub capable de faire transiter des paquets qui passent par lui mais ne lui sont pas destinés, mais sont destinés à un VNet qu'il connaît.

.Bond = liaison d'agrégation
[NOTE]
====
Un bond est une fonctionnalité permettant de regrouper plusieurs cartes réseau physiques en une seule interface réseau logique. +
Cela permet d'augmenter la bande passante et la redondance du réseau.
====

*DEMO : création d'une UDR*

    * L'*UDR* est une table de routage venant *supplanter* l'autre table de routage d'Azure, à savoir les *system routes*

        ** En fait, *les system routes peuvent vite être supplantées* par 2 services Azure : 

            *** les *UDR* : table de routage toujours prioritaire par rapport aux system routes
            *** le *protocole BGP*, Border Gateway Protocol, qui va permettre de propager des routes dynamiquement. +
            Si le protocole BGP dit le contraire d'un system route, c'est lui qui prend le pas sur les chemins par défaut par les system routes
        ** donc l'ordre de priorité est 1) UDR -> 2) protocole BGP -> 3) System routes

    * Pour créer une UDR, on recherche sur le Portal Azure "*Route tables*" +
    image:AZ-104_Hub-Spoke-backup_10.jpg[]
        ** Les UDR doivent toujours être appliquées à des *subnets qui sont dans la même région qu'elle*
        ** une fois l'UDR créée, je vais lui ajouter une route : +
        image:AZ-104_Hub-Spoke-backup_11.jpg[]
        ** les "next hop type" et "next hop address" correspondent au type et à l'IP du prochain bond réseau, à savoir une NVA qui sera ici un Azure Firewall et qui sera sur l'IP privée 10.0.0.4, ce qui correspond à la 1ere IP disponible dans un subnet (voir chapitre "VNet, subnet, NIC, NSG")

.Définition d'un "hop" (qui est lié MAIS différent d'un "bond")
[NOTE]
====
Quand on parle de réseau / network *un "hop" représente un saut*, une étape qu'un paquet de données effectue lors de son parcours d'un point à un autre. +
Chaque fois qu'un paquet passe d'un appareil réseau à un autre (routeur, switch, etc.), on compte 1 hop.
====
    
    * Là, j'ai créé mon UDR et sa route, mais je ne l'ai appliquée à rien. +
    -> Je vais donc dans la section "subnets" de mon UDR, et je lui associe le subnet voulu (ici d'un de mes spokes) : +
    image:AZ-104_Hub-Spoke-backup_12.jpg[]

    * On pourrait également créer un Azure Firewall pour compléter la mise en place de notre topologie Hub and Spoke. +
    Créer un Azure Firewall est simple, mais prend une bonne 10e de minutes.
        ** L'Azure Firewall va avoir un subnet dédié dans le hub et va permettre de faire communiquer les spokes entre eux en passant par le hub.
        ** Tout ceci va me permettre de router des paquets entre mes spokes tout en les faisant transiter par un point unique, le hub, et son Azure Firewall qui va filtrer les paquets et être utilisé comme routeur pour router les paquets entre les spokes.

==== Azure Backup : Mars agent, ABS et Recovery Service Vault

*Azure Backup* est un service PaaS permettant de *backuper 3 types de ressources* : 

    * 1️⃣ *VMs sur Azure* : que l'on va pouvoir backuper dans un *RSV*, *Recovery Service Vault*, le "*coffre-fort*" de vos backups (mais pas que... On le verra avec le PRA inter-région) +
    image:AZ-104_Hub-Spoke-backup_14.jpg[width=400]
        ** Ce RSV a une rétention théorique de 99 années
        ** Ce RSV va stocker votre backup dans un *storage account*, par défaut en *GRS* (Geo-Redondant Storage, votre backup sera donc redondé dans une autre région)
            *** Ce storage account est managé par Microsoft, vous n'y aurez pas accès et ne le verrez même pas dans la console Azure MAIS il existera bien.

            *** Ce storage account est par défaut en GRS MAIS si jamais on ne veut pas de réplication dans une 2nd région, par exemple pour des contraintes réglementaires, on peut toujours AVANT le 1er backup, le passer à ZRS (Zone-redundant storage) ou en LRS (Locally-redundant storage), et dans ce cas il n'y a PAS réplication dans une 2nd région. Mais dès lors si on perd sa SEULE région, on perd également son backup. +
            -> Mais 🔥 *attention* 🔥, une fois que le *1er backup a été effectué*, il n'est *PLUS possible de changer* le type de réplication +
            image:AZ-104_Hub-Spoke-backup_31.jpg[] +
            _-> Une fois effectuée la 1ere sauvegarde, les choix de "Storage replication type" seront grisés dans les propriétés du RSV_

+
.GRS, LRS, ZRS
[NOTE]
====
* *LRS* : *Locally-redundant storage*. Maintain 3 copies of my files in the same datacenter
* *ZRS* : *Zone-redundant storage*. Distributes data across multiple data centers in the same region 
* *GRS* : *Geo-redundant storage*. Distributes 6 copies of your files across 2 data centers (3 in the primary region, and 3 in the secondary one).
====

        ** Le RSV est obligatoirement dans la *même région que la VM à backuper*
        ** Ce storage account en GRS va permettre d'avoir une *copie du backup dans une autre région* ("Cross Region Restore") : +
        Si ma VM est en North Europe (NE), mon RSV doit obligatoirement être créé en NE et son storage account va automatiquement être répliqué dans la région Pair de NE qui est West Europe (WE)

        ** Gros avantage de ce système, il va permettre la *mise en place d'un PCA* (Plan de Continuité d'Activité)
            *** Le jour où il y a une rupture de la normalité en NE, on va pouvoir restaurer notre VM en WE, ce qui va permettre le PCA : "j'ai un problème sur une région A, je restaure ma sauvegarde dans une région B"
            *** Il ne s'agit *PAS de PRA* (Plan de Reprise d'Activité) : il n'est pas ici question de basculement, de failover ou de failback
+
.Failover et failback
[NOTE]
====
Voir : https://www.rubrik.com/insights/the-difference-between-failover-and-failback

* *Failover* is the ability to switch automatically and seamlessly to a reliable backup system. +
The failover operation switches production from a primary site to a backup (recovery) site.

* *Failback* returns production to the original (or new) primary location after a disaster (or a scheduled event) is resolved.

-> When an error is detected a failover workflow changes data sources to a recovery system while a failback workflow restores data back to the original state after a ransomware event or other corporate data loss.
====

        ** possibilité de faire des sauvegardes "FULL"
        ** *Soft Delete* à 14 jours : il s'agit d'une corbeille ; quand on supprime une sauvegarde de VM, cette sauvegarde pourra toujours être restaurée pendant 14 jours, après elle sera définitivement supprimée.
            *** Le Soft Delete peut être activé / désactivé dans les Security Settings du RSV. +
            Si on le désactive, on recevra dans la foulée un mail de Microsoft m'informant que la corbeille du RSV a été désactivée. +
            image:AZ-104_Hub-Spoke-backup_32.jpg[]

        ** Le backup peut être configuré *soit à la création* de la VM, *soit après*.

            *** *Backup configuré lors de la création de la VM* : +
            image:AZ-104_Hub-Spoke-backup_13.jpg[width=800]

            *** Backup configuré APRES la création de la VM -> *création d'un Recovery Services Vault (RSV)* : 
            image:AZ-104_Hub-Spoke-backup_15.jpg[] 
            image:AZ-104_Hub-Spoke-backup_16.jpg[]
                **** Ce RSV doit être créé dans la même région que la VM à backuper
                **** Une fois le RSC créé, il reste à la configurer : +
                image:AZ-104_Hub-Spoke-backup_17.jpg[]
                image:AZ-104_Hub-Spoke-backup_18.jpg[]
                {lb}
                Ici on indique que l'on souhaite backuper une VM tournant sur Azure. +
                -> On pourrait backuper d'autres types de ressources hébergées sur d'autres types d'environnement, comme du on-premises
                image:AZ-104_Hub-Spoke-backup_19.jpg[]
                **** Il faut ensuite définir une *stratégie de backup* : rétention par semaine, par mois, par année, fréquence 
                image:AZ-104_Hub-Spoke-backup_20.jpg[]
                **** Il est possible de ne backuper QUE l'OS de la VM (son disque) sans les disques de données (problématique de confidentialité par exemple) via l'option "OS Disk Only"

    * 2️⃣ Backup des infra *on-premises* - *Agent MARS* : *QUE pour des fichiers et dossiers sur Windows* +
    image:AZ-104_Hub-Spoke-backup_22.jpg[] +
    Si on a un serveur de fichiers sur Windows contenant des fichiers et des dossiers, on va pouvoir les backuper sur Azure, dans un RSV, via l'installation d'un logiciel appelé l'*agent MARS* (Microsoft Azure Recovery Services)
        ** En installant l'agent, on va sélectionner les fichiers à backuper Azure va se charger d'externaliser le backup dans un RSV
        ** Exemple : tous les mercredis Philippe s'en sert pour backuper son poste de travail Windows dans Azure. Pour ce faire, il a installer sur sa machine l'agent Azure Backup, et cet agent, représenté par le fichier *mars.exe*, va permettre de sauvegarder vos ressources dans Azure +
        image:AZ-104_Hub-Spoke-backup_21.jpg[]
+
[NOTE]
====
Tout ce qui est *envoyé VERS Azure* est *gratuit* en termes de flux réseau : tout mon backup externalisé, toute la bande passante utilisée pour envoyer mes données dans mon RSV n'est pas facturé par Microsoft. +
-> Microsoft ne *facture* que la bande passante *EN SORTIE* d'Azure, *au-delà des premiers 5 Go*.

Attention ! Pour le backup dont parlait Philippe, la bande passante n'est pas facturée, mais il est facturé pour la volumétrie de stockage de son backup dans son RSV, donc dans son storage account.
====

        ** Si je choisis dans Azure Backup de backuper des "Files and folders" sur du "On-Premises", Azure va directement me proposer de télécharger l'agent MARS. +
        image:AZ-104_Hub-Spoke-backup_23.jpg[]
        image:AZ-104_Hub-Spoke-backup_24.jpg[]
            *** L'agent MARS va pouvoir connaître mon RSV via un fichier "VaultCredentials", téléchargeable sur la page et valable 10 jours : +
            image:AZ-104_Hub-Spoke-backup_25.jpg[]
                **** Ce fichier ne contient ni plus ni moins que le chemin vers votre RSV

    * 3️⃣ Backup des infra *on-premises* - *VM ABS* (Azure Backup Server) : *pour des VMs on-premises* +
    image:AZ-104_Hub-Spoke-backup_26.jpg[] +
    Si sur son infra on-premises on a des VMs, sur des hyperviseurs Hyper-V ou VMWare, et des machines physiques, il est possible de les sauvegarder dans Azure en installant une VM dite "ABS" (Azure Backup Server) dans notre réseau on-premises.
        1. Cette VM va déployer un agent sur nos machines physiques ou virtuelles, 
        2. agent qui va permettre de backuper nos machines physiques ou virtuelles sur la VM ABS 
        3. qui va ensuite externaliser ce backup dans votre RSV

        ** DEMO avec le backup de VMs sur Hyper-V et VMWare : +
        image:AZ-104_Hub-Spoke-backup_27.jpg[]
        ** Azure va alors vous proposer de télécharger le logiciel ABS pour l'installer sur un serveur on-premises : +
        image:AZ-104_Hub-Spoke-backup_28.jpg[]
        image:AZ-104_Hub-Spoke-backup_29.jpg[]
            *** Ce logiciel nécessite un Windows Server 2016 ou 2019 et la taille de son fichier d'install est de 4.2 Go +
            image:AZ-104_Hub-Spoke-backup_30.jpg[]

-> Il s'agit là des 3 méthodes de backup proposées par Azure, mais on peut également parfaitement backuper avec du *Vim* ou du *Netbackup*

    * Ces services sont d'ailleurs proposés dans Azure
    * MAIS l'avantage d'*Azure Backup*, via les 3 méthodes proposées, est qu'il s'agit d'un *service PaaS* -> On ne manage PAS de VM. 
        ** Tout est géré au niveau de Microsoft dans le RSV.

=== AZ-104 EP03 : VPN S2S (Site à Site), VNet to VNet & PRA

URL vidéo PHILIT : https://www.youtube.com/watch?v=cuWs3E1Zmm8&list=PLxf9spw2semSHqq8XvRaiT9HNWzO054MT&index=3

==== VPN S2S (Site à Site dans Azure)

* *Plusieurs composants* sont requis pour créer une *connexion VPN Site à Site* avec Azure : 

    ** 1️⃣ le plus important, un *VNet* Azure : 
        *** un composant spécifique va être attribué à ce VNET, le *Gateway subnet* : ce subnet va être dédié à *recevoir les connexions distantes depuis vers VPN on-premises*.
        *** Ce VNET doit être conforme à la RFC 1918 "Adress Allocation for Private Internets" : https://datatracker.ietf.org/doc/html/rfc1918[]
        *** L'espace d'adressage de ce VNet doit être différent de celui de votre espace d'adressage on-premises
    
    ** Dans votre réseau *on-premises*, il va y avoir un *composant VPN* (F5, Fortinet, Juniper, Checkpoint, etc.) qui *DOIT avoir une IP publique* afin que Azure puisse l'utiliser pour de se connecter au réseau on-premises.
        *** On peut également utiliser comme VPN un Windows Server avec le rôle "Routing and Remote Access".

    ** Entre les 2, il faut créer *une connexion VPN* qui va passer par le *réseau Internet*. +
    Pour créer cette connexion VPN, on utilise 2 composants Azure : 
        
        *** 2️⃣ une *VNG*, Virtual Network Gateway : 
            **** C'est la *représentation du VPN Azure dans Azure*
            **** Elle a forcément une *IP publique*
            **** Il s'agit d'une ressources chère et longue à créer (20 à 45 minutes)

        *** 3️⃣ une *LNG*, Local Network Gateway : 
            **** C'est la *représentation de votre VPN on-premises*
            **** Elle a une IP publique qui correspond à celle de votre VPN on-premises pour indiquer à Azure à quelle IP publique il doit se connecter pour atteindre votre réseau on-premises.
            
    ** 4️⃣ une *clé PSK* (Pre-shared key)
        *** Wikipedia : In cryptography, a pre-shared key (PSK) is a shared secret which was previously shared between the two parties using some secure channel before it needs to be used.
        *** Il s'agit d'une clé commune définie à la fois dans mon VPN on-premises et dans ma VNG afin de leur permettre de communiquer, s'authentifier et ainsi permettre la création du tunnel IPsec entre eux.

.Tunnel IPSec, protocole IKE et clés PSK
[NOTE]
====
* *What is IKE ?* (https://www.linkedin.com/advice/0/how-do-you-choose-between-ikev1-ikev2-ipsec[]) : 

    ** IKE (Internet Key Exchange) is a protocol that establishes a secure association between two peers, called Security Associations (SAs), that define how to encrypt and authenticate IPsec traffic. IKE also exchanges cryptographic keys and negotiates other parameters, such as the encryption algorithm, the authentication method, and the lifetime of the SAs. +
    IKE has two phases:

        *** phase 1 creates a secure channel between the peers, called the IKE SA
            **** Gemini : *Phase 1 de IKE* (Authentification) : *Utilise les clés PSK* pour la vérification mutuelle de l'identité des participants.

        *** phase 2 creates one or more IPsec SAs to protect the actual data traffic.
            **** Gemini : *Phase 2 IKE* (Échange de clés et chiffrement) : *Négocie, génère et échange des clés de chiffrement dynamiques* (comme des clés AES), qui sont ensuite utilisées par IPSec pour protéger les communications VPN.

* *Gemini* : 

    ** Le *protocole IKE* intervient en amont du processus IPSec, en établissant une connexion sécurisée et en négociant les clés de chiffrement nécessaires : 

        1. Une fois qu'IKE a réussi l'*authentification entre les 2 parties*, soit par l'usage de certificats numériques, soit par l'utilisation d'une clé PSK partagée (alternative plus simple mais moins sécurisée) 
        2. et qu'il a réussi l'*échange des clés de chiffrement dynamiques* nécessaires à la sécurisation la communication VPN, 
        3. alors IPSec peut commencer à chiffrer et à authentifier les paquets de données qui traversent le tunnel VPN.

    ** IKE établit une SA (*Security Association*) pour chaque canal de communication (entrant et sortant) du tunnel VPN. +
    -> La SA définit les algorithmes de chiffrement, d'authentification et de mode de fonctionnement à utiliser pour protéger les communications.
        *** Les algorithmes d'authentification SA (Security Association) sont utilisés pour authentifier l'origine et l'intégrité des paquets de données qui traversent le tunnel VPN. Ils font partie de la phase 2 d'IKE et de la négociation IPSec.

    ** Les *clés PSK*, quant à elles, jouent un rôle crucial dans l'*authentification* mutuelle entre les parties prenantes dans le processus IKE. Elles permettent d'établir une confiance mutuelle avant que les clés de chiffrement IPSec ne soient négociées et échangées. +
    Les clés PSK doivent être partagées de manière sécurisée entre les parties prenantes AVANT l'établissement de la connexion VPN.
====

[NOTE]
====
Documentation Microsoft listant les principaux fournisseurs de *périphériques VPN* : https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpn-devices

    * Pour chaque VPN, cette documentation donne le lien vers les informations de l'éditeur pour la configuration de son VPN, y compris la partie configuration dans Azure.
    * Les paramètres IKE phase 1 et phase 2 sont également donnés en fin de page
====

* Le VPN on-premises peut être configuré soit en PolicyBased soit en RouteBased : 
    ** *RouteBased* : *à préférer*, on galère moins, car il va y avoir un *routage dynamique de propagation de routes* qui va être utilisé par le VPN Site à Site
    ** *PolicyBased* : 
        *** tout doit être défini manuellement
        *** on aura en phase d'authentification QUE de l'IKE v1, et non le choix entre de la v1 ou de la v2
        *** sur un même VPN, on ne pourra pas faire du Site à Site et du Point à Site. Les connexions VPN seront SOIT en Site à Site SOIT en Point à Site
+
.VPN Point à Site vs VPN Site à Site
[NOTE]
====
* Un *VPN Point à Site* se configure au niveau du poste de travail. +
Il s'agit d'un *client lourd* à installer et qui va permettre à celui-ci de se connecter à votre réseau virtuel Azure à distance.

* Dans le cas d'un VPN Site à Site, c'est l'intégralité de votre espace d'adressage on-premises que vous mettez potentiellement à disposition pour se connecter à votre VNet.
====

*DEMO* de configuration du *router Synology RT2600ac*, qui *fait aussi VPN*, de la cave de Philippe 😉

    * Je commence par créer un nouveau Resource group : RG-SYNO-VPN
        
    * Puis je crée dans ce RG une 2️⃣ *nouvelle Virtual Network Gateway* (VNG)
        ** la *création d'une VNG* sur Azure est une opération longue prenant *entre 20 et 45 minutes*
        ** L'IP publique de cette VNG est l'IP que je vais devoir renseigner dans mon RT2600ac
        ** La VNG est un service managé par Azure, il y a donc peu d'options de configuration :

            *** création d'une *connexion Point à Site*
            *** *choix du SKU* (Basic, Standard, High Performance) qui va correspondre à la bande passante associée au VPN
                **** Plus le SKU est élevé plus le VPN va coûter cher, mais plus la bande passante proposée par Microsoft va être élevée
            *** *activer le mode "actif-actif"* pour le VPN : c'est à dire avoir 2 liaisons VPN vers 2 périphériques VPN on-premises en étoile.
                **** Donc si l'un des 2 tombe, l'autre prend le relais

    * Cette VNG a besoin d'un 1️⃣ *VNet* pour fonctionner, ici VNET-AZURE
        ** parmi ses subnets, on voit un  *GatewaySubnet* (créé via le bouton "+ Gateway subnet") et qui est managé par Microsoft (/28 ou /29 minimum pour être créé par Azure) +
        image:AZ-104_VPN-S2S-VNet-to-VNet-PRA_01.jpg[]

    * On va maintenant créer la 3️⃣ *Local Network Gateway* (LNG) qui va contenir 2 informations importantes : 
        ** l'*IP publique* de notre VPN
        ** les *espaces d'adressage* qui auront le *droit d'accéder à Azure* +
        image:AZ-104_VPN-S2S-VNet-to-VNet-PRA_02.jpg[]
            *** Sans ces derniers, quand bien même notre connexion VPN serait effective (marquée comme "connected"), on ne recevrait aucun flux du réseau on-premise car Azure les dropperait car non appartenant à un espace autorisé

    * On termine en créant une connexion VPN qui va utiliser : +
    image:AZ-104_VPN-S2S-VNet-to-VNet-PRA_03.jpg[]

        ** VNet : VNET-AZURE
        ** VNP
        ** LNG
        ** Shared key (clé PSK)

    * Pour information, dans ma VNG, je retrouve la configuration de la connexion Point à Site que je peux définir si besoin

{sb}

Quelques précisions sur le *VPN Point à Site* : 

    * Le Point à Site vous permet de télécharger un *client lourd* depuis le portail Azure
    * Une fois installé, quand vous allez vous authentifier, celui-ci va utiliser un *système de certificats client / serveur* et donc c'est bien *votre poste de travail lui-même qui va pouvoir se connecter à Azure* +
    -> Ce client lourd ne va pas vous demander un login / mot de passe correspondant à votre email professionnel, il va juste authentifier votre poste de travail.
        ** Pratique car cela permet d'*automatiser* d'une certaine façon une *connexion vers Azure à base de certificats*, auto-générés sur votre poste de travail puis rajoutés dans le magasin de certificats, via une console MMC (Microsoft Management Console), ou dans votre poste de travail Windows.

    * Plusieurs protocoles sont utilisés par le VPN Point à Site :

        ** *SSTP* (Secure Socket Tunneling Protocol) de Microsoft : fonctionne sur le port 443
        ** *OpenVPN* : fonctionne lui aussi sur le port 443

        ** L'usage du *port 443* permet de *passer les pare-feux beaucoup plus facilement*, y compris sur votre poste de travail.
            *** Généralement le HTTPS sur le port 443 est ouvert en sortie dans les entreprises

    * Avec un *VPN Point à Site*, il est possible de *s'authentifier* : 
        ** soit *directement à l'aide de son poste de travail* (comme expliqué plus haut)
        ** soit avec son *compte Azure Active Directory*
        ** soit avec son *compte Active Directory*, mais dans ce cas il vous faut un serveur RADIUS on-premises pour mapper le tout
+
.Protocole RADIUS
[NOTE]
====
RADIUS (Remote Authentication Dial-In User Service) est un *protocole client-serveur* permettant de *centraliser des données d'authentification*.
Le serveur RADIUS (installé par exemple sur Linux) communique avec un client, appelé NAS (network access server, par exemple un routeur CISCO).

image::AZ-104_VPN-S2S-VNet-to-VNet-PRA_04.png[width=600]
====

    * Si on utilise des certificats, il est possible de les auto-générer sur son poste de travail depuis une simple commande Powershell

==== VNet to VNet

NOTE: Philippe parle également du "VNet to VNet" comme d'une connexion VPN Site à Site entre 2 VNets

* Pour connecter 2 VNet entre eux, le peering est une solution simple et efficace. +
-> Néanmoins, certains clients préfère utiliser une *vieille technologie* présente sur Azure : le VNet to VNet

image::AZ-104_VPN-S2S-VNet-to-VNet-PRA_05.jpg[]


* Le VNet to VNet est une fonctionnalité permettant de raccorder 2 VNet entre eux via une liaison VPN de type Site à Site.

* Les *avantages* du VNet to VNet :

    ** la *sécurité* offerte par le *tunnel IPSec* de la liaison VPN
        *** L'échange entre les 2 VNet est obligatoirement chiffré là où le chiffrement est optionnel pour le peering
    ** Les 2 VNet peuvent être dans des *régions différentes*

* Les *inconvénients* : 

    ** Le VNet to VNet est *très cher* car une VNG est un composant cher (pour s'occuper "juste" de la connexion entre 2 VNet). +
    En cherchant passant par la calculette Azure pour une "*Passerelle VPN*", on trouve les chiffres suivants +
    (avec 730 heures ~ 1 mois d'usage d'une service à temps plein) : 

        *** *usage de dev* soit "VPN de base" : ~25€ / mois

        *** 1er *VPN de prod*, "VpnGw1" SANS la bande passante : ~133€ / mois
            **** Mais il s'agit d'un VPN Site à Site, donc il faut ajouter le *coût de la bande passante du trafic sortant*. +
            Si on prend 500 Go de trafic sortant, cela vient ajouter ~30€ / mois
            **** Mais ici, il est question non pas de Site à Site mais de VNet to VNet (type de passerelle "Transfert entre réseaux virtuels" et non "VPN") à 16€ / mois MAIS comme il faut une VNG PAR VNet (connexion dans les DEUX sens), cela fait 16 x 2 ~30€ / mois
            **** Donc, au total, on se retrouve avec un coût pour le VNet to VNet de (133 + 16) x 2 ~ *300€ / mois* +
            image:AZ-104_VPN-S2S-VNet-to-VNet-PRA_06.jpg[]

    ** Il est *long à mettre en place* toujours à cause de la *VNG*
        *** Rappel : pour créer une VNG, il faut entre 20 et 45 minutes
        *** Par contre, il n'est *pas nécessaire de créer une LNG*

* Composants nécessaires pour créer une connexion VNet to VNet, pour chaque VNet : 
    ** un *Gateway Subnet*
    ** une *VNG*
    ** une clé *PSK*

.Résumé : différences entre liaison en peering et connexion VPN Site à Site ?
[NOTE]
====
Ces 2 services remplissent au final le *même rôle*, *relier 2 VNets entre eux*, mais des différences existent  : 

    * Le peering utilise le protocole MacSec pour chiffrer certains échanges
        ** plus simple à mettre en place
        ** moins cher
    
    * La liaison VPN Site à Site chiffre les flux via le protocole IPSec
        ** Ce type de connexion est *plus cher* MAIS est sécurisé "by design"
        ** Tout comme le peering, les flux du VNet to VNet *ne transitent PAS par Internet*

-> De manière générale, le *VNet to VNet* est *de moins en moins utilisé* et *remplacé par du peering*, surtout pour des topologies Hub and Spoke.
====

*DEMO : VNet to VNet*

* Il faudrait commencer par avoir 2 VNets et donc 2 VNG 
* puis aller dans "Connexion VPN" et faire un "Add connection" +
image:AZ-104_VPN-S2S-VNet-to-VNet-PRA_08.jpg[]
* Et là indiquer que la "Connection type" est de type "VNet-to-VNet" et donner la 2nd VNG : 
image:AZ-104_VPN-S2S-VNet-to-VNet-PRA_07.jpg[width=400]

==== PRA inter-région d'une VM

* Si j'ai par exemple une VM (ici "W2K19") créée sur la région North Europe, je vais chercher à *me prémunir de la perte de la région Azure North Europe ENTIERE* (donc me prémunir de la perte de TOUS les data centers d'une région)
    
    ** Si je cherche à me prémunir de la *perte d'UN data center dans une région*, on utilisait les *Availability Zones (AZ)*
    ** Et pour se prémunir des *pertes au sein d'UN data center*, on utilisait les *Availability Sets*

* Dans ce cas de perte d'une région entière, je veux que ma VM soit *recréée dans une 2nd région*. +
Dès lors, on entre dans une logique de DRP (Data Recovery Plan), de PRA (Plan de Reprise d'Activité)

*SCHEMA* : +
image:AZ-104_VPN-S2S-VNet-to-VNet-PRA_09.jpg[]

    * On retrouve notre VM "W2K19" (il y en a même une 2nd) avec un disque managé

.Managed disk (disque managé)
[NOTE]
====
Un disque managé est un disque qui est managé par Microsoft, c'est à dire que le VHD (Virtual Hard Drive) est contenu dans un disque qui n'est PAS accessible depuis Internet.

-> Il s'agit du disque typique que l'on va utiliser pour les VMs de nos jours +
(il est représenté sur le schéma par l'ensemble disque bleu / disque vert)
====

    * Quand on va configurer le PRA chez Microsoft, on va commencer par créer un compte de stockage au plus proche du managed disk
    * et ce compte répliqué va recevoir les données répliquées du managed disk en *synchrone* : +
    Tout ce qu'on écrit sur la VM va être répliqué dans un *compte de stockage "de cache" ASR* (*Azure Site Recovery*)
        ** Nous n'accédons PAS à ce compte de stockage, mais celui-ci va contenir à tout moment une *copie du disque de la VM*
    * Ce compte de stockage va *répliquer* les données dans une *2nd région* MAIS en *asynchrone*
        ** Ce service n'est pas gratuit, la réplication d'une VM dans une 2nd région a un coût
    * Cette 2nd région peut être liée à la région pair (par ex : West US et East US, ou France Central et France South) OU être complètement différente (France Central et une région des US par exemple), dans ce dernier cas, il faut juste se dire qu'il y aura de la latence.

Comme on réplique les données de façon aynchrone, en cas de panne générale dans la région primaire, vous aurez *forcément une perte de données au moment de la réplication*.

    * Comme il y a une perte, il va falloir prendre en compte des concepts de RPO et RTO : 

        ** *RPO* - *Recovery Point Objective* : c'est la durée admissible de pertes des données pour une panne
            *** Le RPO dépend avant tout de Microsoft : c'est la fréquence de rafraîchissement des données entre les 2 régions

        ** *RTO* - *Recovery Time Objective* : C'est le temps que l'on va mettre pour basculer de la région primaire qui est tombée à la région secondaire
            *** Le RTO dépend du client : c'est lui qui effectue le basculement sur la 2nd région

        ** Plus ces 2 valeurs sont faibles, plus on aura des données à jour quand on basculera sur la 2nd région

.Dans la 2nd région, la VM n'est pas dessinée dans le schéma, pourquoi ?
[NOTE]
====
* Parce que Azure déclenchera le PRA uniquement quand vous l'aurez décidé, c'est à dire quand vous l'aurez déclenché manuellement.
* A ce moment, Azure va prendre le VHD dans la 2nd région et s'en servir pour créer la nouvelle VM

image::AZ-104_VPN-S2S-VNet-to-VNet-PRA_10.jpg[]

-> Donc, en termes de coût, *on ne paye PAS 2 VMs à un instant "t"*
====

*Coûts associés à un PRA* : +
image:AZ-104_VPN-S2S-VNet-to-VNet-PRA_11.jpg[width=800]

    * (déjà, on ne paye pas pour 2 VMs)
    * le *stockage*
    * la *bande passante* pour la synchro entre les 2 régions
    * le *coût de protection de la VM* : quand on déclenche la protection d'une VM via un PRA, Azure va appliquer un coût supplémentaire à cette VM : une *licence de protection* pour ~20€ / mois

.Pas de question sur le coût à la certification
[NOTE]
====
Il n'y a *pas de question "de coût" dans la certification Azure* : les coûts évoluant en fonction des régions, les options ayant une incidence sur le coût, il serait vraiment compliqué de répondre à une question de ce type sans la calculatrice Azure.

On peut vous poser une question du type "Voici mon use case, quelle est la solution la moins onéreuse à mettre en place ?", mais cela n'ira pas plus loin côté "coût".
====

*DEMO : PRA inter-région*

.On accède à la configuration du PRA via le menu "Disaster recovery" de la VM
image:AZ-104_VPN-S2S-VNet-to-VNet-PRA_12.jpg[]

* On commence par *choisir la région* de la VM du PRA
    ** Faire un PRA entre 2 plaques géographiques semble mal avisé (mais possible), mieux vaut rester plus proche.
    ** Dans le cas présent, à savoir ma VM w2k19 créée en North Europe, le plus logique est de configurer le PRA en France Central

* Dans les "advanced settings" du "*Disaster recovery*", on a la possibilité : 
    ** de changer de souscription pour la VM du PRA
    ** définir un Resource group qui va accueillir le managed disk de la VM du PRA en attendant qu'elle soit créée
    ** en fait les options permettant de choisir un Resource group, un VNet, une Availability Zone ou Set (toutes des options gratuites) permettent de pré-créer l'infrastructure nécessaire pour le déclenchement de la synchro du PRA

    ** 💡 Bon à savoir : on peut donner au VNet qui va être créer dans la 2nd région le *même espace d'adressage que celui de la région primaire* -> le jour où je vais créer ma VM dans la 2nd région, elle pourra donc avoir la même IP que dans la région primaire puisqu'elle fera partie d'un même espace d'adressage (mais dans une autre région)
        *** Donc pas besoin dans ce cas de s'embêter à repenser à tous les aspects réseau à la recréation de la VM, tout va être géré côté Microsoft.

.Migration de VM d'une subscription à une autre
[NOTE]
====
Fut un temps, on avait l'habitude de déclencher un PRA uniquement pour effectuer une migration de VM d'un abonnement (subscription) à un autre. +
Néanmoins, c'est de moins en moins utilisé car dans un *Resource group*, il existe maintenant une *fonctionnalité permettant directement de déplacer une VM d'une subscription à une autre* : +
image:AZ-104_VPN-S2S-VNet-to-VNet-PRA_13.jpg[]
====

.Différences entre PRA et Backup
[NOTE]
====
Tout deux répondent à des besoins différents : 

    * Le *PRA* permet de *se prémunir de la perte d'une région* ET SURTOUT d'avoir *une VM qui va être synchronisée au cours du temps*, avec un projet de *basculement* qui de l'ordre de *15 min de perte de données*

    * Un *backup* rentre plutôt dans un *PCA* (Plan de Continuité d'Activité).
        ** Ce dernier va faire que, par exemple, on va backuper 1 fois par jour sa VM.
        ** Donc à la restauration, à la date du dernier backup, la perte de données pourra être beaucoup plus conséquente qu'avec un PRA

J'ai un peu de mal à comprendre cette explication de Philippe quant à ce qui est communément admis pour la différence entre un PRA et un PCA. +
J'ai l'impression que Philippe explique ici qu'un PRA est un "PCA++" où l'on va synchroniser la sauvegarde de la VM au cours du temps.

Voici les définitions communément admises pour un PCA et un PRA (voir https://www.naitways.com/nos-guides/guide-plan-de-reprise-dactivite/difference-pra-pca-comprendre-les-elements-qui-assurent-la-resilience-de-votre-entreprise/[]) : 

    * *PCA (Plan de Continuité d'Activité)* : 
        ** un PCA garantit que les opérations de l’entreprise, dans son ensemble, sont capables de fonctionner en cas d’incident.
        ** Il se réfère aux mesures à prendre pour maintenir et poursuivre les activités d’une organisation face aux menaces potentielles.
        ** le PCA définit en amont les risques susceptibles d’affecter les activités de l’entreprise. Il peut s’agir de catastrophes naturelles, de cyberattaques ou de fraudes. Ensuite, il met en place des solutions de protection et des mesures d’atténuation des risques identifiés, ainsi que des procédures de test pour vérifier leur efficacité.
        ** -> *Azure Backup* (et les backups qu'il permet) s'inscrit dans un *PCA*

    * *PRA (Plan de Reprise d'Activité)* : 
        ** Un PRA vise à rétablir le système d’information de l’entreprise au plus vite en cas de sinistre. 
        ** Le PRA vise à minimiser les temps d’arrêt de l’entreprise en maintenant l’accès aux infrastructure informatiques et aux applications critiques.
        ** Il va se baser sur 2 éléments clés : le RPO et le RTO.
        ** -> *Azure Site Recovery* s'inscrit dans un *PRA*

    * Alors que le PCA consiste à maintenir le bon fonctionnement de l’activité globale d’une entreprise pendant et après un incident, le PRA se concentre plutôt sur les conditions de reprise de l’activité suite à un arrêt.

    * Le *PCA* se base sur une *prévention des risques de perte de données* -> on fait des *backups* pour éviter de perdre ou de "trop perdre".
    * Le *PRA* repose quant à lui sur une *récupération des données après sinistre* pour une reprise d'activité la plus rapide possible.

-> DE MON POINT DE VUE : 

    * Le *service de Azure backup* va permettre de conserver *PLUSIEURS backups* de nos VMs à différents moments
    * Tandis que *le service de "Disaster recovery"* d'une VM Azure va permettre d'avoir *UN réplica* de ma VM *régulièrement synchronisé* avec celle-ci
====

    ** Azure permet maintenant de réserver les ressources nécessaires à la création de sa VM de PRA via les "*Capacity Reservation Groups*". +
    -> Aussi étonnant que cela puisse paraître, c'est même le *seul moyen d'obtenir la GARANTIE* qu'au moment de sa demande de basculement, les *ressources nécessaires* à la création de nos VMs soient *disponibles* dans la 2nd région 😲
    image:AZ-104_VPN-S2S-VNet-to-VNet-PRA_14.jpg[width=800]
        *** Pour information, les concurrents (AWS, GCP) ne s'engagent pas non plus (par défaut) sur la disponibilité des ressources au moment de la demande de basculement.
        *** Cela s'explique par la *complexité* de la chose : c'est impliquerait que chaque data center serait capable d'absorber la charge de tous les autres data centers des autres régions.

    ** On peut également demander à Azure d'*inclure tous les disks OU seulement le disque de l'OS* de la VM : +
    image:AZ-104_VPN-S2S-VNet-to-VNet-PRA_15.jpg[]

* Pour estimer le coût de son PRA via la *calculatrice Azure*, il faut choisir "Récupération de site Azure" +
image:AZ-104_VPN-S2S-VNet-to-VNet-PRA_16.jpg[]

* Pour info, on peut également faire du PRA intercloud privé du client, piloté par Azure : 
    ** On va pouvoir avoir un client avec 2 data centers avec de l'hyper-V ou du VMWare on-premises
    ** et la réplication des VMs entre ces 2 data centers se fait via Azure comme vu précédemment
        *** Cela coûter 15€ / instance
        *** Philippe ne l'a jamais vu chez aucun client jusqu'à maintenant...

🔥 *TRES IMPORTANT* 🔥 : Le *PRA inter région Azure* se base lui aussi sur un *RSV* (Recovery Service Vault)

    * Contrairement à ce que Philippe avait initialement dit dans le cours sur les backups, un RSV ne convient PAS que des backups (Azure Backup), il contient également tout ce qui est PRA inter-région
    
    * Dans le cas d'un PRA, on ne peut *PAS créer le RSV dans la même région "source"* que la VM (message d'erreur si on essaye)

        ** On retrouve cette condition dans cet article de Microsoft détaillant comment configurer un *Disaster Recovery* à l'aide de *Azure Site Recovery* : +
        https://learn.microsoft.com/en-us/azure/site-recovery/azure-to-azure-tutorial-enable-replication +
        "Create a Recovery Services vault in any region, *except in the source region* from which you want to replicate VMs."

    * Le RSV permet les fonctionnalités suivantes : 

        ** *Failover* : On constate que la région primaire est tombée, et on décide de lancer un PRA vers la région secondaire (donc recréer notre infra dans la région secondaire)

        ** *Failback* : On est sur la région secondaire et la région primaire redevient "up". Nos utilisateurs ont continué à travailler sur une VM qui a été créée sur la région secondaire et on ne veut pas perdre les données associées. +
        Le failback va permettre de *répliquer notre VM dans l'autre sens*.

        ** *Ordonnancement* : Par exemple, si on a un applicatif basé sur une BDD, un middleware et un frontend soit 3 VMs le composant. +
        Si on a un PRA sur ces 3 VMs, au moment du basculement celles-ci vont être *recréées* mais potentiellement dans *n'importe quel ordre*.
        Or on peut avoir un applicatif qui impose que pour fonctionner il faut d'abord le middleware, puis le frontend et enfin la BDD. +
        -> L'*ordonnancement* va permettre de spécifier *dans quel ordre l'infra va être recréée* dans la 2nd région.

        ** *Test de basculement* : Pratique quand on a des infras basées sur des *audit à base d'ISO-27012, 27001, etc.* 
            *** Très souvent dans ce type d'audits, les auditeurs demandent à ce qu'un test de basculement soit effectué régulièrement (souvent 1 fois / an) afin de vérifier "avant le jour J et la cata" (rupture de normalité, inondation, etc.)" que tout est effectivement bien configuré. +
            -> Les tests de basculement sont faits pour cela et vont permettre, quand on le souhaite, de recréer la VM dans un *VNet complètement cloisonné* des autres VNet (pas de peering, de VPN, de VNet to VNet ou d'Express Route)
                **** Ce VNet sera uniquement utilisé pour la recréation de la VM (complètement *dédié aux tests de basculement*) pour vérifier que notre appli est bien recréée dans la 2nd région.
                **** Et pour accéder à la VM, il faudra installer une IP publique dessus

.Quelques infos sur la famille de normes ISO-27000
[NOTE]
====
* *ISO-27012* : guidelines for cybersecurity. +
It provides guidelines for managing cybersecurity risks within organizations. It offers recommendations for establishing cybersecurity policies, procedures, and controls to protect against cyber threats and vulnerabilities.

* *ISO-27001* : It specifies the requirements necessary to implement, maintain and manage an ISMS (Information Security Management Systems), within the process of continuous improvement known as PDCA, an acronym for Plan-Do-Check-Act, in relation to the planning, doing, verifying and acting phases.

-> Pour plus d'informations, voir : +
https://www.sorinmustaca.com/the-iso-27000-family-of-protocols-and-their-role-in-cybersecurity/
====

=== AZ-104 EP04 : Azure Load Balancer & Application Gateway

URL vidéo PHILIT : https://www.youtube.com/watch?v=MdRokWoGgr0&list=PLxf9spw2semSHqq8XvRaiT9HNWzO054MT&index=4

==== Load Balancing Services sur Azure

*Load balancing* :

    * rediriger le trafic vers un ensemble de noeuds en fonction de différentes règles de routage
    * notions de priorité, de pondération, règles de routage basées sur la géographie

    * 4 load balancers sont disponibles sur Azure et managés par Microsoft : 

        ** Application Gateway
        ** Azure Front Door
        ** Azure Load Balancer
        ** Traffic Manager

.Load balancing services
image:AZ-104_load-balancer_01.jpg[]

*Azure Application Gateway* : 

    * Azure Application Gateway fonctionne sur la *couche 7 du modèle OSI*, "application layer"
        ** On va y retrouver les protocoles *HTTP* et *HTTPS*

    * L'Application Gateway va supporter derrière le *backend pool*, des *VMs qui sont des frontaux web*.

.Backend Pool
[NOTE]
====
The *backend pool* is a critical component of the load balancer. The backend pool defines the group of resources that serve traffic for a given load-balancing rule.

Microsoft explanation : +
https://learn.microsoft.com/en-us/azure/load-balancer/backend-pool-management
====

    * Usage classique d'un Application Gateway : j'ai un site web que je veux rendre disponible et, pour scaler dans Azure, dans un backend pool : 
        ** Mon site web est par exemple déployé sur 10 VMs
        ** Ce site web est dans un backend pool qui est derrière un Application Gateway
        ** L'Application Gateway va porter l'*IP publique* de mon site web

    * Le "problème" de l'Application Gateway est que c'est un service *régional* : 
        ** Si notre site web est international, avec pour vocation d'être disponible aux Etats-Unix, en Chine, etc., l'Application Gateway, si par exemple créé en France Central, ne pourra rediriger des flux QUE vers des ressources en France Central. +
        Donc Application Gateway en France Central -> backend pool en France Central

*Azure Front Door* : 

    * Front Door est un produit beaucoup plus récent que Application Gateway
    * Il fonctionne également sur la *couche 7* du modèle OSI

    * Gros avantage : service *global*
        ** il va avoir une *VIP publique qui va être globale à plusieurs régions*, et va pouvoir rediriger le trafic vers différentes régions.

.VIP (Virtual IP Address)
[NOTE]
====
Gemini : a VIP stands for Virtual IP Address. It's not a physical network interface card, but rather a *logical IP address* assigned to a service or group of resources.

Function: A VIP acts as a single point of entry for clients accessing a service. It doesn't have a physical network card itself but routes incoming traffic to the actual backend servers associated with the service.
====

    * Front Door est plutôt utilisé quand on a une application qui doit être accessible de manière globale (cad dans plusieurs régions)

    * Exemple d'usage de Front Door et différence avec Application Gateway :

        ** Une application est souvent constituée d'un frontend et d'un backend qui est une BDD.

        ** Si l'application (site web) est *REGIONALE* (spécifique à 1 unique région), on va avoir un *Application Gateway* avec derrière des VMs dans 1 région, et derrière ces VMs on va retrouver 1 BDD de type *Azure SQL*, à savoir un produit par défaut régional.

        ** Si l'application (site web) est *GLOBALE*, on va avoir un *Front Door* qui va rediriger le trafic dans différentes régions, avec dans chacune comme backend une BDD de type *Cosmos DB* qui va être répliquée dans les autres régions.

*Autres usages de l'Application Gateway et de Front Door* : 

L'Application Gateway et le Front Door permettent bien d'autres usages que la seule redirection de flux vers les différentes VMs d'un backend pool.

    * *Déchargement SSL* : 

        ** Le *certificat SSL* va être *porté par le load balancer*
        ** Les utilisateurs vont arriver en HTTPS sur le load balancer, type Application Gateway, qui, comme il porte le certificat SSL, va pouvoir rediriger le flux en HTTP sur les backend pools
        ** Donc l'utilisateur arrive en HTTPS et il est redirigé en HTTP sur le backend pool, ce qui permet de *décharger les frontaux web* de la couche de chiffrement / déchiffrement. +
        -> Vous ne serez plus obligés d'héberger les certificats sur les frontaux web.

    * *Réécriture d'URL et redirection* : 

        ** si on arrive en "http://toto.com", l'Application Gateway va recevoir le flux en HTTP et va le rediriger en HTTPS.

    * *Réécriture d'entêtes HTTP*
    * *Affinité de cookies*
    * *Différentes méthodes de routage*
    * etc.

-> Le Front Door fait globalement tout ce que fait l'Application Gateway MAIS c'est un service global.

Autre point important : on peut *ajouter un WAF* (Web Application Firewall) à un Application Gateway ou Front Door

    * un WAF est un firewall dédié à la protection des applicatifs web

*Azure Load Balancer* : 

    * Il fonctionne sur la *couche 4 du modèle OSI*, la couche transport, et travaille donc avec les protocoles *TCP* et *UDP*
    * Ce service est soit *régional* soit (depuis peu) *global*
    * présence de sondes d'intégrité pour vérifier les noeuds

    * Il existe en 2 versions : 
        ** la version basique (SKU "Basic"), gratuite mais sans SLA associé
        ** la version payante (SKU "Standard"), globale avec SLA et disposant de nombreuses fonctionnalités
+
NOTE: Pour plus d'informations sur les *capacités cross-region ("Global")* de l'Azure Load Balancer en Standard, voir : +
https://learn.microsoft.com/en-us/azure/load-balancer/cross-region-overview

*Azure Traffic Manager* : 

    * Lui fonctionne avec le protocole *DNS*
        ** le protocole DNS est associé avec la couche 7 "application" du modèle OSI
    * Quand on crée le service Traffic Manager, on crée en fait un *profil* qui va concerner un nom de domaine (en *.trafficmanager.net)
        ** Ce nom de domaine va être utilisé quand vous avez votre propre nom de domaine. +
        Exemple : 
            *** vous avez votre nom de domaine "toto.com"
            *** vous allez créer un *enregistrement DNS*, qu'on appelle un *CNAME*, qui va pointer sur le nom de domaine .trafficmanager.net de votre profil

    * -> Choisir un *profil* revient à *choisir une méthode de routage* parmi 6 disponibles : 
        ** pondération
        ** priorité
        ** géographie
        ** latence (basée sur les performances)
        ** etc.
+
NOTE: Pour plus d'informations sur les méthodes de routage du Traffic Manager, voir : +
https://learn.microsoft.com/fr-fr/azure/traffic-manager/traffic-manager-routing-methods

[IMPORTANT]
====
Pour la certification *AZ-104*, on va très peu parler du Traffic Manager, mais surtout se concentrer sur l'*Application Gateway* et le *Load Balancer*.

-> Ces 2 services font l'objet de beaucoup plus de questions que Front Door ou le Traffic Manager, qui eux sont vus plus en détails dans l'AZ-305.
====

*Ces 4 load balancers* sont tous des *services PaaS* : 

    * Ils sont donc scalés automatiquement par Microsoft
    * Mais rien ne nous empêche d'installer un soft de load balancing sur une VM dans Azure.
        ** Exemple : un Windows Server avec le rôle permettant de faire du load balancing (depuis un server Windows)
    * On peut également en utiliser d'autres comme du Juniper ou du F5

.Quelques précisions sur le backend pool
[NOTE]
====
Généralement, on a *dans le backend pool* soit des *VMs*, soit des *IPs*, soit des *App Services*.

* Pour l'*Application Gateway*, l'*Azure Load balancer* et le *Traffic Manager* : 
    ** on peut mettre des VMs sans problème dans le backend pool
    ** Avec l'Application Gateway, plutôt que de pointer sur une VM dans le backend pool, on peut pointer sur un App Service qui peut être une web app.

* *Front Door* est un peu particulier car dans le backend pool il peut *pointer sur d'autres load balancer* comme des Application Gateway :
    ** On va donc avoir une VIP publique globale et on va rediriger les flux vers des Application Gateway qui sont déployés dans différentes régions Azure.
    ** Ces Application Gateway vont eux-mêmes rediriger les flux sur des VMs ou des App Service.
    ** Dans le backend pool du Front Door, on peut également *pointer vers un storage account*
    ** On a des services PaaS, dans le Front Door, qui peuvent être la *cible des requêtes des clients à l'international*.
====

.Fonctionnement SANS et AVEC load balancer
image:AZ-104_load-balancer_02.jpg[]

Fonctionnement standard *SANS load balancer* : 

    1. je suis un utilisateur et cherche à me connecter au site www.contoso.com
    2. je commence par interroger avec une requête DNS le serveur DNS primaire, qui va potentiellement interroger d'autres serveurs DNS, afin de trouver l'IP du site www.contoso.com
    3. le serveur DNS primaire me renvoie l'IP publique du site www.contoso.com
    4. et je vais donc me connecter à la VM (dans notre cas) qui porte cette IP publique

    * Mais si cette VM venait à tomber (attaque DDOS, procédures de maintenance et redémarrage, problème matériel, etc.), alors le site www.contoso.com ne serait plus accessible.

Fonctionnement standard *AVEC load balancer* : 

    * le load balancer va permettre de rediriger les flux de manière équitable entre les différents noeuds qui supportent le site web.

    1. Les 1eres étapes sont les mêmes, l'utilisateur interroge le serveur DNS primaire pour obtenir l'IP du site www.contoso.com
    2. Mais celui-ci ne va pas lui renvoyer ici l'IP publique du site sur une VM, MAIS va lui renvoyer l'*IP publique de l'Azure Load Balancer* (icône vert / bleu / blanc du schéma : icône officielle de l'Azure Load Balancer, couche 4 du modèle OSI), ce qu'on appelle souvent une *VIP*
    3. Et quand l'Azure Load Balancer va recevoir la requête de l'utilisateur, en fonction d'une *règle de routage* (3 disponibles), il va rediriger celle-ci vers l'une des VMs disponibles (celles qui sont "up")

    * Un load balancer va donc pouvoir pallier la perte d'une VM dans un backend pool. +
    Il permet d'augmenter la disponibilité de votre site web / applicatif web.
        ** Par contre, pas de magie, si tous les noeuds de mon backend pool tombent, le site supporté sera alors indisponible...

-> On va s'intéresser à ce 2nd fonctionnement

==== Azure Load Balancer

* Après la création du Load Balancer, je vais créer mes backend pools (il peut y en avoir plusieurs)
    ** en effet, 1 Load Balancer va pouvoir rediriger les flux vers plusieurs applicatifs

* des *sondes d'intégrité* (health probes) vont vérifier toutes les X sec que chaque noeud du backend pool sont bien up
    ** Si un noeud (cad une VM) ne répond pas au bout de Y sec, le load balancer sort celui-ci du backend pool

* Des *règles de load balancing* existent : 

    ** *Modification de port* : par exemple si j'arrive sur le port 80 sur le load balancer, je vais être redirigé vers tel backend pool sur le port 8082, ce qui va permettre d'avoir un port qui n'est pas exposé sur Internet et qui est utilisé par mes VMs dans mon backend pool

Il existe *2 versions* de l'Azure Load Balancer : 

    * Version *"public"* avec une *IP publique* et qui redirige les flux vers un backend pool avec des *VMs accessibles via IP privées* +
    image:AZ-104_load-balancer_03.jpg[width=600]

.Azure Load Balancer : protection de l'adressage des VMs du backend pool (via SNAT)
[NOTE]
====
Un *Load Balancer* va également permettre de *protéger l'adressage des VMs* du backend pool : 

    * L'IP publique utilisée pour le trafic sortant du backend pool est alors portée celle du Load Balancer et PAS celles des VMs. +
    -> Donc si une VM veut sortir sur Internet, elle va utiliser l'IP publique du Load Balancer, et non la sienne.
    
    * Ce masquage est réalisé à l'aide de la technique du *SNAT* (*Source Network Address Translation*). +
    On va porter la requête sortante provenant de l'IP privée de la VM vers une ressource sur Internet à partir de l'IP publique de l'Azure Load Balancer.
====

    * Version *"internal"* avec une *IP privée* et qui redirige également vers des *VMs accessibles avec des IP privées* +
    image:AZ-104_load-balancer_04.jpg[width=600]

        *** On va souvent retrouver cet "internal Load Balancer" derrière un frontend. +
        Exemple : 
            **** On a 3 VMs en guise de frontend qui porte un site web (ex : IIS, Apache) 
            **** Elles reçoivent des requêtes depuis un Azure Load Balancer PUBLIC ("version 1") qui va rediriger les flux vers les ports 80 de ces 3 VMs.
            **** Mais pour fonctionner, ces 3 VMs ont besoin d'accéder à une BDD sur le 1433 (du SQL) +
            Donc, on va mettre un Azure Load Balancer Internal derrière notre frontend, qui va porter une IP privée et va rediriger les flux vers des BDDs SQL.
            Qui sont dans notre cas à priori managées par Microsoft MAIS qui peuvent très bien être des VMs (c'est d'ailleurs ce que l'on voit le plus souvent)

NOTE: Le schéma indique un port 1443 mais en mode PaaS sur Azure pour du SQL c'est le port *1433* qui est utilisé (et on ne peut PAS changer de port)

    * -> C'est donc la combinaison de ces 2 types de Load Balancer qui va permettre d'avoir des applications composées de frontend, backend, middleware hautement disponibles et scalables dans Azure

L'Azure Load Balancer dispose de 2 *SKUs* : *Basic* (gratuit) ou *Standard* (payant) : +
image:AZ-104_load-balancer_05.jpg[width=600]

    * *Pas de SLA* en version Basic : si le service tombe, il n'y aura aucun dédommagement de la part de Microsoft (avoirs ou autres) contrairement à la version Standard.
    * 1000 VMs possibles dans le backend pool en Standard contre seulement 300 en Basic

    * Tous les *ports* sont par défauts *OUVERTS* dans la version *Basic*
        ** Quand on arrive sur l'Azure Load Balancer en Basic, par défaut, aucun NSG n'est activé et donc tous les ports sont disponibles pour essayer d'accéder au backend pool
        ** En version *Standard*, tous les ports sont *FERMES* par défaut et le Load Balancer vous oblige à appliquer un NSG pour définir les flux entrants accessibles.

-> En gros, par défaut la version *standard* est "*sécurisée par design*"

.Focus sur les Availability Zones (AZ)
[NOTE]
====
image:AZ-104_load-balancer_06.jpg[width=600]

* 1 région Azure possède *soit 3 AZ soit PAS DU TOUT*
    ** Par exemple, on ne peut PAS avoir 1 région avec 2 AZ 

* 1 Availability Zone (AZ) regroupe 1 ou plusieurs Data Center (DC)
* Les DC d'une même AZ sont proches physiquement, MAIS entre les DC d'AZ différentes, il y a plusieurs kilomètres (une distance physique minimale).
    ** -> Si les DC d'une AZ brûlent, il ne faut pas qu'il puisse s'étendre aux DC des autres AZ (cas malheureux d'OVH ces dernières années)

* L'idée est que dans 1 région on puisse perdre 1 AZ MAIS pas les 2 autres

* Pour se faire une idée des data centers Azure de Microsoft : 

ifdef::env-github[]
https://www.youtube.com/watch?v=ut1-qTlusnA[vidéo : Azure Datacenter | A tour to Microsoft Azure Datacenter]
endif::[]
ifdef::env-browser[]
video::ut1-qTlusnA[youtube, width=640, height=480]
endif::[]

* Dans la vidéo précédente, on nous montre une *AZ* (notée Z1 ci-dessous) avec ici *4 data centers* : +
image:AZ-104_storage-account_04.jpg[]

* Sur cette autre image, on voit maintenant *2 AZ bien séparées d'une distance minimale* avec des routes coupe-feu et autres mesures de protections physiques : +
image:AZ-104_storage-account_05.jpg[]
====

Spécificité de l'Azure Load Balancer en *Standard* (donc PAS disponible en Basic) : +
-> Il peut être défini avec une *VIP* soit en *Zone redundant*, soit en *Zonal*

image:AZ-104_load-balancer_07.jpg[width=800]
    
    * En *Zone redundant*, l'Azure Load Balancer va couvrir les 3 AZ vont rediriger les requêtes des utilisateurs vers vos backend, représentés sur le schéma par 3 subnets, chacun contenant des VMs.
        ** Ici l'Azure Load Balancer est commun à 3 AZ, donc malgré la perte de 2 zones sur 3, il sera toujours capable de rediriger les requêtes vers la 3e zone.
        ** C'est un choix garantissant une plus haute disponibilité que le Zonal, mais qui est également plus cher (du fait de la réplication de l'ALB dans toutes les zones)

    * En *Zonal*, la VIP publique va être contenue dans une zone particulière. +
        ** Donc,  quand on perd 1 zone en Zonal, on perd l'accès à son Load Balancer et à son backend pool

    * Cette configuration doit être choisie *à la création* de l'Azure Load Balancer

Il existe *3 méthodes de routages* sur les noeuds du backend pools : 

    * *None* : pas de méthode de routage, l'ALB redirige la requête de l'utilisateur vers n'importe quelle VMs du backend pool.
        ** C'est l'ALB qui choisit en fonction de la charge des noeuds, il n'y aura aucune "logique de décision" choisie par l'utilisateur.
        ** C'est pas terrible en termes de routage... Pour un site web marchant, si la VM avec son panier tombe, le panier n'existe plus, on va réactualiser la page, constater sa disparition et devoir remettre dedans ce qu'il contenait précédemment.

    * *Client IP* : basé sur l'IP publique de la requête utilisateur, l'ALB va toujours me rediriger vers la même VM.

    * *Client IP and protocol* : avec chaque fois que j'utilise la même IP et le même protocole (HTTP par exemple), l'ALB va me rediriger sur le même noeud (donc la même VM).
        ** Si mon IP ou mon protocole change, je peux dès lors me retrouver sur un autre noeud de mon backend pool.

*DEMO : Création d'un Azure Load Balancer (SKU Standard, de type Public et Regional)*

    1. Portail Azure, rechercher "load balancer" : on tombe sur la page "Load balancing / Load Balancer" avec listés les 4 types de Load Balancers sur Azure : Application Gateway, Front Door, Azure Load Balancer et Traffic Manager +
    image:AZ-104_load-balancer_08.jpg[width=1000]

    2. On fait un "Create" du "Load Balancer"

    3. On configure les caractéristiques souhaitées de l'Azure Load Balancer : *SKU* (Basic / Standard / Gateway), *Type* (Public / Internal), *Tier* (Regional / Global) +
    image:AZ-104_load-balancer_09.jpg[width=800]

        ** On ne peut pas choisir un Tier "Global" avec un Type "Internal". 
        -> Un type Internal implique une IP privée, or *on ne peut PAS avoir une IP privée de disponible dans plusieurs régions Azure*, cela n'existe pas techniquement.

        ** Le *SKU "Gateway"*, dont il n'a pas été question dans ce cours, est apparemment une "version ++" du Standard, *spécialisée dans la gestion et l'ajout de 3rd party NVAs*. +
        Dans sa documentation, Microsoft explique : 
        
            *** https://learn.microsoft.com/en-us/azure/load-balancer/tutorial-gateway-portal : +
            {sb}
            _Gateway Load Balancer is used for *transparent insertion of Network Virtual Appliances* (NVA). Use Gateway Load Balancer for scenarios that require *high performance* and *high scalability of NVAs*._

            *** https://learn.microsoft.com/en-us/azure/load-balancer/gateway-overview : +
            {sb}
            _Gateway Load Balancer is a SKU of the Azure Load Balancer portfolio catered for high performance and high availability scenarios with third-party Network Virtual Appliances (NVAs). With the capabilities of Gateway Load Balancer, you can easily deploy, scale, and manage NVAs._

    4. On configure la Frontend IP, à savoir l'*IP publique de mon ALB* +
    image:AZ-104_load-balancer_10.jpg[width=1000]

        ** C'est dans la création de la "Public IP address" que je vais indiquer si en termes d'Availability zone je suis "None", "Zone redundant" ou Zonal (c'est à dire spécifique à 1 zone) en sélectionnant ma zone parmi les 3 AZ de ma région.

    5. On configure ensuite les *backend pools* +
    image:AZ-104_load-balancer_11.jpg[width=1000]

        ** Je peux choisir si je vais identifier les VMs des backend pools par leur NIC ou leur IP : 
            
            *** identification par la NIC : +
            image:AZ-104_load-balancer_12.jpg[width=600]
            
            *** identification par l'IP : +
            image:AZ-104_load-balancer_13.jpg[width=600]

    6. On définit les *règles de routage entrantes* (*Inbound rules*) +
    image:AZ-104_load-balancer_14.jpg[width=1000]
        
        ** La "*Session persistence*" correspond à la *méthode de routage* détaillée précédemment et peut prendre les valeurs "None", "Client IP" et "Client IP and protocol"

        ** On crée la Health probe : +
        image:AZ-104_load-balancer_15.jpg[width=300]
            
            *** "Interval" permet de configurer la durée (ici 5 secondes) au bout de laquelle, en l'absence de réponse, le noeud est sorti du cluster (cad la VM est sortie du backend pool)

    7. Puis les règles de *routage sortantes* (*Outbound rules*, les règles de *SNAT*)

        ** Pour rappel, cela permet aux VMs de mon backend pool d'aller sur Internet avec l'IP publique de mon Load Balancer

    8. Après le "Review + create" final, l'ALB est disponible au bout de quelques minutes +
    image:AZ-104_load-balancer_16.jpg[]

==== Application Gateway (AG)

* L'Application Gateway est un service Azure avec une *très bonne réputation* (marche vraiment bien)

* L'AG est un service *régional*

* l'AG *regroupe plusieurs services* : 
        
    ** *Déchargement SSL* : +
    image:AZ-104_load-balancer_19.jpg[width=400]

        *** On vient *mettre ses certificats sur l'Application Gateway*, et quand l'utilisateur voudra aller en HTTPS sur un site web contenu dans un backend pool, l'Application Gateway sera capable de *rediriger le flux en HTTP* en interne.
        *** -> Cela permet de *décharger les backend pools de toute la couche de chiffrement / déchiffrement* du protocole SSL.

    ** *Redirection d'URL* : +
    image:AZ-104_load-balancer_20.jpg[width=400]
    
        *** quand l'utilisateur va vouloir aller en HTTP sur un site web contenu dans un backend pool, l'Application Gateway va le rediriger en HTTPS vers ce dernier.

    ** *Réécriture d'entête HTTP*
    ** *Affinité de cookies*
    ** etc.

NOTE: A savoir, c'est un service qui met *une 15e de minutes à être créé*.

* *L'Application Gateway n'a QU'UNE IP* ("frontend IP" du schéma) +
image:AZ-104_load-balancer_17.jpg[]

    ** Dans l'exemple, une IP publique
    ** Donc si on a 2 NDD (Nom De Domaine), "toto.com" et "tata.com", tous deux vont cibler la même IP, celle de l'Application Gateway, qui va ensuite rediriger la requête vers le backend pool contenant le bon site.
    ** Au final, l'Application Gateway se comporte donc comme un *Reverse Proxy*, qui héberge plusieurs sites web

* L'Application Gateway peut *protéger vos backend pools* à l'aide d'un *WAF* (Web Application Firewall)

* L'Application Gateway peut utiliser *2 méthodes de redirection* pour rediriger les flux des utilisateurs : +
image:AZ-104_load-balancer_18.jpg[]

    ** *Path Based Routing* : un routage *fonction du path / chemin d'URL* utilisé
        *** Dans l'exemple, www.contoso.com/images/* est redirigé vers le backend pool de VMs qui contiennent des images, et www.contoso.com/video/* est redirigé vers le backend pool de VMs qui contiennet des vidéos

    ** *Multiple Site Routing* : un routage *fonction du host / nom d'hôte* de la requête
        *** Dans l'exemple, www.contoso.com et www.fabrikam.com sont redirigés vers 2 backend pools différents.
        *** Cela va par exemple permettre d'avoir 1 IP publique (celle de l'Application Gateway) qui porte tous les sites web de votre société.

* L'Application Gateway est un service *scalable automatiquement* par Microsoft
    ** On peut indiquer qu'on le déploie avec 1 instance, donc 1 noeud qui contient le service Application Gateway
    ** MAIS si j'ai 10 000 000 de connexions d'un coup, je vais avoir la possibilité de scaler automatiquement jusqu'à par exemple 10 noeuds qui composent mon Application Gateway, ce qui va me permettre d'avoir un load balancer hautement disponible
    ** Cette *scalabilité* peut être : 
        *** en *autoscaling*
        *** en *manuel* : on peut manuellement augmenter le nombre d'instances qui composent le service Application Gateway sur la région spécifique

*DEMO : Création d'un Application Gateway*

* L'AG fait partie de ces services PaaS qui ont besoin d'un *subnet dédié dans un VNet*.
    ** Parmi les autres services ayant ce besoin, on peut citer : API Management, Azure Firewall, Azure Bastion (et d'autres)

* Ici, du fait de sa durée de création de ~15 minutes, Philippe a déjà créé l'AG. +
image:AZ-104_load-balancer_21.jpg[]
    
* L'Application Gateway est disponible en *différentes versions*, ici Philippe en a choisi une ("Tier : WAF V2") qui *intègre un WAF*, Web Application Firewall. +
    ** Le *WAF* va *protéger vos frontaux* contre des attaques de type injections SQL, cross-site scripting, vulnérabilité Log4j, vulnérabilité Spring4shell, etc.
    ** Le *WAF* est un *Firewall attribué à l'Application Gateway*.

* Il est bien sûr possible de créer un Application Gateway SANS WAF

* Quand on crée un Application Gateway AVEC un *WAF*, ce dernier est *par défaut en mode "Detection"* +
image:AZ-104_load-balancer_22.jpg[width=400]
    
    ** mode *Detection* : le WAF va détecter l'attaque MAIS ne va pas en dropper les paquets
    ** mode *Prevention* : le WAF va maintenant en plus dropper les paquets de l'attaque

* Rappel : l'AG peut être autoscalable +
image:AZ-104_load-balancer_23.jpg[width=400]
    ** Il y a toujours 1 noeud qui compose mon AG et je peux avoir jusqu'à 10 instances de mon AG qui tournent pour répondre à une augmentation de la charge

* Dans son AG Philippe a créé 1 backend pool avec 2 targets : +
image:AZ-104_load-balancer_24.jpg[width=800]
image:AZ-104_load-balancer_25.jpg[width=500]
    ** Ces 2 targets correspondent à 2 adresses IP privées, qu'il faut imaginer appartenir à 2 VMs Azure. +
    Dans l'idée de cette démo, on aurait 1 site web qui serait hébergé sur ces 2 VMs qui composent notre backend pool.

* A noter, via le *backend pool*, on peut rediriger les requêtes HTTP / HTTPS des utilisateurs : +
image:AZ-104_load-balancer_26.jpg[]
    ** vers un service PaaS Azure comme *Azure Web App*
    ** OU vers un *Virtual Machines Scale Set* (VMSS) qui permet un *scaling horizontal*
    ** OU vers des VMs
    ** OU des IPs ou FQDN

.Scaling horizontal et scaling vertical
[NOTE]
====
* *Scaling horizontal* : J'ai 1 VM, et en cas d'augmentation de la charge, je vais créer une nouvelle instance de cette VM.
    ** Je vais donc dupliquer la VM.

* *Scaling vertical* : J'ai 1 VM, et en cas d'augmentation de la charge, ja vais rajouter du CPU et de la RAM à CETTE VM
    ** Je vais donc rajouter des ressources à ma VM.
====

* L'*IP publique* de mon Application Gateway est disponible dans le *menu "Frontend IP configurations"* : +
image:AZ-104_load-balancer_27.jpg[]

* Le *déchargement SSL* se configure en ajoutant des listeners via le *menu "Listeners"* : +
image:AZ-104_load-balancer_28.jpg[]
    ** Ce listener correspond à un protocole (HTTP ou HTTPS) et un port d'écoute
        *** Pour du déchargement SSL, on choisit bien sûr le protocole HTTPS
    ** Je vais pouvoir soit uploader mon certificat soit en sélectionner un dans un Key Vault

* La *redirection d'URL* se réalise en plusieurs étapes : 
    
    ** la *définition d'un listener* qui écoute l'IP publique de mon AG en HTTP sur le port 80
        *** Dans cette exemple, le listener est de *type "Basic"*, c'est à dire que le trafic sera *router vers 1 seul backend pool*
            *** Contrairement au type "Multi site" qui permet de router le trafic vers différents backend pools en fonction du nom d'hôte de la requête entrante. +
            Par exemple, pour une boutique en ligne et un blog hébergés sur la même infrastructure, vous créez un listener "multi-site" avec deux règles : 1 pour router le trafic ciblant https://www.shopify.com/fr/site-de-vente-en-ligne vers le backend pool de la boutique et une autre pour router le trafic ciblant https://www.blogger.com/ vers le backend pool du blog.

    ** la *définition d'une règle de routage* via le menu "Rules" qui va écouter certaines requêtes et les rediriger vers au moins 1 backend target

        *** Les *requêtes écoutées* vont être représentées par un *listener* ("port80" ici) +
        image:AZ-104_load-balancer_29.jpg[]

        *** les *backend targets* peuvent être soit : 

            **** des *backend pools* : +
            image:AZ-104_load-balancer_30.jpg[]
                ***** "*Backend target*" permet de spécifier *où le trafic sera dirigé*, à savoir quel sera le backend pool ciblé
                ***** Les "*Backend settings*" permet de spécifier *comment le trafic sera traité une fois arrivé à destination* (algorithme de répartition de charge, délai d'inactivité, health probe, nombre maximal de connexions)

            **** une *"Redirection"*, qui est la configuration qui nous intéresse pour notre *redirection d'URL*. +
            image:AZ-104_load-balancer_31.jpg[]

                ***** Cette configuration va nous permettre de faire de la *redirection vers un autre listener*. +
                -> Ici je redirige le trafic PROVENANT de mon listener écoutant sur le port 80 VERS un autre listener qui pointe sur un backend pool en HTTPS en écoutant le port 443

+
.Maintenance de site
[NOTE]
====
Dans le cas d'une maintenance de votre site, vous pouvez également *rediriger les requêtes vers un "External site"*, qui peut être un FQDN représenté par une IP publique on-premise et qui héberge votre site temporairement pendant la maintenance de celui-ci dans Azure. +
-> Cela permet d'avoir une *maintenance transparente pour les utilisateurs*.
====

* Les *sondes d'intégrité* se configurent dans le *menu "Health probes"* : +
image:AZ-104_load-balancer_32.jpg[]

* Le *menu "Backend health"* permet de consulter la *santé des VMs de mes backend pools* : +
image:AZ-104_load-balancer_33.jpg[]
    ** Ici Philippe avait créé 2 IPs privées "bidon", sans VM derrière, d'où le status "Unhealthy" renvoyé.

=== AZ-104 EP05 : Supervision et Azure Monitor

URL vidéo PHILIT : https://www.youtube.com/watch?v=e00sKrTitaI&list=PLxf9spw2semSHqq8XvRaiT9HNWzO054MT&index=5

* *Azure Monitor* est un service "couteau suisse" qui contient plusieurs autres services : 
    ** Azure Network watcher
    ** les alertes (Azure Alerts)
    ** Azure Log Analytics
    ** etc.

==== Azure Monitor

.Présentation de Azure Monitor
image:AZ-104_supervision_01.jpg[]

* Azure Monitor vous permet de superviser vos ressources : 
    ** Azure
    ** on-premises
    ** ou provenant d'un autre Cloud Service Provider (CSP comme AWS, GCP)
    
    ** -> Dans ces 2 derniers cas, cela requiert l'installation de *l'agent MMA* (Microsoft Monitoring Agent) sur les VMs associées.

NOTE: *L'agent Dependency* vous permet de *visualiser les dépendances* associées à vos VMs on-premises ou d'autres CSP

-> Azure Monitor est donc un service *multi-cloud*.

* *Azure Monitor* est un service permettant de *récupérer* des *métriques* et des *logs* de différents services.
    
    ** Exemples de *métriques* : pourcentage d'utilisation de votre CPU, de votre RAM, le nombre d'accès disque, le nombre d'I/O par sec sur vos disques, la bande passante utilisée par votre VM en entrant et en sortant, taux d'utilisation d'une VM, etc.
        *** Les métriques permettent de *mesurer le taux d'utilisation des ressources*

    ** Exemples de *logs* : logs d'activité de vos ressources (*Activity Log*), journal d'évènements d'un OS, logs d'activité sur le portail Azure (tout ce qui est fait par les utilisateurs sur le portail Azure)

* Types de ressources dont Azure Monitor peut récupérer les logs et métriques :

    ** *Applications*
    ** *Operating System* : différents types de journaux (journal d'administration, journal de sécurité, etc.)
    ** *Azure Resources* : Web App, BDD managée par Microsoft, etc.
    ** *Azure Subscription*
    ** *Azure Tenant* (le tenant qui contient vos identités : les utilisateurs, les groupes, etc.) : les connexions de ces utilisateurs et groupes à votre tenant vous également pouvoir être ingérées dans Azure Monitor
    ** *Custom sources* : F5, Fortinet, etc. Ces sources génèrent des logs d'activités au format XML, JSON, etc. qui peuvent également être importées dans Azure Monitor

* Une fois ces logs et métriques récupérées, on va pouvoir les traiter de différentes manières : 
    
    1. phase *Insights* (phase "d'aperçu") : Insights contient une suite d'outils (Application Insights, Container Insights, etc.) qui vont permettre de troubleshooter, de visualiser l'état de votre applicatif sur le service PaaS en terme d'utilisation des ressources, de latence, etc.
        *** Par exemple via Container Insights on va pouvoir monitor les noeuds, donc les VMs, d'un cluster Kubernetes

    2. phase *Visualize* : affichage des métriques et logs sous forme de *dashboards* et *tableaux* compréhensibles pour l'humain
        *** dashboards natif Azure ou tableau PowerBI par exemple (il existe des connecteurs PowerBI pour se connecter à Azure Monitor)

    3. phase *Analyze* : analyse des logs et métriques via Metrics Explorer ou Log Analytics
        *** *Log Analytics* permet de requêter les logs via le *langage KQL* (Kusto Query Language)

    4. phase *Respond* : en fonction de certains métriques (ex : taux d'utilisation d'une VM, à 99% de CPU) : 
        ** *génération d'alertes* et de notifications associées, qui vont pouvoir être envoyées à des équipes d'astreinte
        ** ET *génération d'actions automatisées*.
            *** Exemple : Comme l'exécution d'un script Powershell sur la VM qui est à 99% de CPU afin de redémarrer le service qui contient 99% de CPU d'utilisation de la VM

    5. phase *Integrate* : phase où l'on va *"mapper" Azure Monitor avec des services qui orchestrent* sous forme d'évènements d'autres services Azure.
        ** C'est par exemple le cas de *Logic Apps* (orchestrateur de services Azure) qui, à partir d'un évènement généré sur une VM, permet d'orchestrer, au travers de différents services Azure, la réponse au déclenchement de cet évènement (notion de déclencheur / *trigger*)

*DEMO : Activity log & alerts*

*METRIQUES et DASHBOARDS*

    * Dans le portail Azure, sur une ressource de type VM, on peut accéder aux métriques suivants : 
    image:AZ-104_supervision_02.jpg[]

    * A partir de ces métriques, il est possible de *créer des dashboards* dans le portail Azure à l'aide de la fonctionnalité "Pin to dashboard" : +
    image:AZ-104_supervision_03.jpg[]

    * Ces dashboards peuvent être *privés* (Private) ou *partagés* (Shared)

    * Ils sont accessibles via le *menu "Dashboard"* du portail Azure : +
    image:AZ-104_supervision_04.jpg[width=150]
        ** L'interface de dashboard d'Azure permet de modifier l'affichage des métriques qui y sont épinglées et peut être personnalisée à l'aide de toute une série de widgets (utilisateurs de l'AAD, notes de sécurité liées aux souscriptions Azure, etc.) +
        image:AZ-104_supervision_05.jpg[]

    * Ces dashboards peuvent être *partagés*, *exportés* et *imprimés*
    image:AZ-104_supervision_06.jpg[]

*JOURNAUX D'ACTIVITE*

    * Toute ressource Azure (VM, IP publique, etc.) a un journal d'activité (*Activity log*) qui lui est attribué : +
    image:AZ-104_supervision_07.jpg[]
    * Par défaut, ce journal d'activité tous les évènements survenus sur la ressource durant les 6 dernières heures
        ** Cette durée peut être modifiée et *monter jusqu'à 3 mois gratuitement*
    
    * L'Activity Log est disponible au niveau du *Management Group*, de la *Subscription*, du *Resource Group* et des *ressources* elles-mêmes.
        ** Si mon Management Group contient 2 Subscriptions, son Activity Log va me permettre d'avoir dans une seule vue les logs d'activité de ces 2 abonnements.

    * L'Activity Log n'est *PAS supprimable* (donc ne peut pas se faire supprimer suite à une attaque)

    * Il est possible d'*exporter l'Activity log* dans un compte de stockage (*storage account*) et ainsi dépasser la limite de stockage gratuite de 3 mois : +
    image:AZ-104_supervision_08.jpg[width=500]
    {lb}
    image:AZ-104_supervision_09.jpg[]
    {lb}
    image:AZ-104_supervision_10.jpg[width=600]

*ALERTS et ACTIONS*

    * Imaginons que l'on souhaite monitorer l'utilisation CPU d'une VM : je souhaite être alerter quand on arrive à 90% de CPU, et qu'une action soit alors effectuée pour faire baisser la consommation de CPU (comme l'exécution d'un script PowerShell redémarrant un service).

    * Dans le portail Azure, dans la VM, aller dans le *menu "Alerts"* +
    image:AZ-104_supervision_11.jpg[width=600]

    * Faire un *"Create"* *"Alert Rule"*

        ** Dans *"Scope"*, vous allez pouvoir *définir les ressources qui recevront l'alerte* (le scope de l'alerte) +
        image:AZ-104_supervision_12.jpg[]
            *** -> La même alerte pourrait être appliquée à plusieurs VMs

        ** Ensuite, on définit un *signal*, la condition qui doit être remplie pour que l'alerte soit déclenchée. +
        Ici on cherche le métrique "Percentage CPU" +
        image:AZ-104_supervision_13.jpg[]
            *** On va définir un *seuil d'alerte à 90% d'usage du CPU*, *calculé sur une période de 5 min* avec une *évaluation toutes les minutes* : +
            image:AZ-104_supervision_14.jpg[]

        ** Dans le *menu "Action"*, je vais définir les actions et notifications à envoyer dans une *"Action group"*. +
        image:AZ-104_supervision_15.jpg[width=400]
            *** L'action group va être *mis en place par Azure dès lors que l'alerte est déclenchée*

            *** Dans l'exemple, on va créer un action group pour l'astreinte de l'entreprise toto : +
            image:AZ-104_supervision_16.jpg[]
            
            *** On va définir 2 notifications pour cet action group : +
            image:AZ-104_supervision_17.jpg[]

                **** l'envoi d'un *mail au propriétaire de la ressource*
                **** l'envoi d'un *SMS* (par exemple au téléphone de l'équipe d'astreinte de l'entreprise toto), ainsi qu'un *mail à une adresse spécifique*, ainsi qu'une *notification sur un smartphone* (via l'installation de l'app Azure sur celui-ci, https://play.google.com/store/apps/details?id=com.microsoft.azure)

            *** Puis, dans l'onglet "Actions", on définit les actions devant être réalisées pour mitiger l'impact de cette alerte : 
            image:AZ-104_supervision_18.jpg[width=500]

                **** *Automation Runbook* : permet l'exécution d'un script Python ou PowerShell
                **** *Azure Function* : donc du serverless, qui peut d'ailleurs être de nouveau du PowerShell
                **** *ITSM* : permet le transfert à un ITSM (Jira, ServiceNow, etc.) et donc la création d'un ticket
                **** *Logic App* : orchestrateur de services Azure
                **** *Webhook* : pour l'appel à une URL qui derrière va exécuter du code
                **** etc.

            *** -> Cet Action group pourra être *réutilisé* plus tard pour d'autres alertes
        
        ** Dans l'*onglet "Details"* de l'Alert Rule, je vais pouvoir définir une *sévérité*, un nom et une description à cette alerte : 
            *** 0 : alerte hyper critique, on va perdre des M€ dans les 5 min...
            *** 3 et 4 indiquant qu'il s'agit juste d'une information

    * La *liste de toutes les alertes* va être affichée ainsi dans le portail Azure : +
    image:AZ-104_supervision_19.jpg[width=600]

==== Azure Log Analytics

* Ce service va vous permettre de *requêter vos journaux* et *tout ce qui est remonté dans Azure Monitor* au travers du *langage KQL* (Kusto Query Language)

* Log Analytics se base sur un *"Log Analytics Workspace"* pour fonctionner. +
Le Log Analytics Workspace est le container qui *va contenir tous les logs remontés par vos ressources* +
(On peut le voir comme une piscine vide que l'on va remplir au fur et à mesure)
    ** Le Log Analytics workspace n'est ni plus ni moins qu'un *Storage Account*
    ** Ce logs vont ensuite être gérés au niveau d'Azure Monitor et Log Analytics

* Ces logs, transmis en HTTPS au Log Analytics Workspace, peuvent venir : 
    ** soit de *ressources Azure*
    ** soit de *ressources en provenance d'autres CSP* (des VMs sur AWS, GCP, etc.), via l'installation de l'agent MMA
    ** soit de *ressources on-premises*, en utilisant l'agent MMA et / ou en passant par un serveur SCOM
        *** Le serveur SCOM est l'outil de supervision de Microsoft, chargé de récupérer les logs en provenance des VMs on-premises qu'il administre et supervise, puis d'envoyer ces logs vers le Log Analytics Workspace

*DEMO : Log Analytics*

    * Dans Azure Monitor, aller dans le *menu "Logs"* +
    image:AZ-104_supervision_20.jpg[width=600]

    * Je commence par *définir le scope de ma requête* : +
    image:AZ-104_supervision_21.jpg[]

    * Puis je *définis ma requête*, si besoin en m'aidant des templates fournis par Azure : +
    image:AZ-104_supervision_23.jpg[]
    image:AZ-104_supervision_22.jpg[]

==== Azure Service Health

* Ce service permet de *visualiser l'état des services Azure* : est-ce que tout va bien chez Microsoft, nos data centers sont-ils bien up and running, un service est-il tombé, etc.

* Service heath permet de visualiser la liste de toutes les régions Azure : chaque point correspond à 1 région (plus de 60 régions disponibles) avec au moins 1 data center (vert tout va bien et rouge il y a un pépin...)

* Exemple : si à un moment donné je n'arrive pas à me connecter à ma VM : 
    ** Soit ma VM elle-même a un problème (virus, port fermé, etc.)
    ** Soit le *service Virtual Machine Azure a un problème* -> Service Health va pouvoir vous informer de ce type de problème
        *** Et pour être pro-actif et éviter devoir aller checker Service health tous les X, on peut *créer une alerte* en sélectionnant la souscription, le service à surveiller, la région +
        image:AZ-104_supervision_24.jpg[]
        *** La logique de création de cette alerte est la même que tout à l'heure, avec l'utilisation d'un Action Group.

==== Azure Network Watcher

* Ce service permet de *troubleshooter ce qui se passe sur vos réseaux virtuels Azure* (VNet)
* Il est *automatiquement créé* dès lors que vous créez un VNet, sur la même région que le VNet

* Network Watcher est un "couteau suisse" *regroupant toute une série de services Azure* : 
image:AZ-104_supervision_25.jpg[]

* Service *"Topology"* : 
    ** va permettre de *générer le schéma d'architecture du VNet* sélectionné +
    image:AZ-104_supervision_26.jpg[]
    ** Ce schéma est téléchargeable au format SVG

* Service *"IP Flow verify"* : 
    ** va permettre de diagnostiquer les problèmes de connectivité (accès réseau) à une VM pour un protocole (TCP, UDP), une direction (Inbound, Outbound) et une source qui peut être distante (Internet ou votre réseau on-premises) : +
    image:AZ-104_supervision_27.jpg[]
    ** -> IP Flow verify est donc un bon outil pour diagnostiquer un problème de connectivité entre une VM Azure et votre réseau on-premises ou Internet.

* Service *"Next hop"* : 
    ** Next hop va se baser sur les UDR, les system routes et les tables de routage que vous avez définies pour *déterminer quel sera le prochain hop emprunté pour aller d'une VM azure à une IP cible* (comme l'IP publique d'un site web) +
    image:AZ-104_supervision_28.jpg[]

    ** Next hop ressemble en cela à l'utilitaire *tracert* aux différences prêt qu'il offre une meilleure visibilité (informations détaillées sur le routage interne) MAIS qu'il ne permet pas de mesurer la latence.

* Service *"Effective Security rules"* : 
    ** Ce service va récupérer la carte réseau / NIC d'une VM et *va permettre de visualiser toutes les règles qui s'appliquent RELLEMENT sur le NSG donné* +
    image:AZ-104_supervision_29.jpg[]
    ** C'est utile car quand un NSG contient un grand nombre de règles, il peut être difficile pour un humain de savoir quelles sont les règles qui s'appliquent réellement en fonction des priorités, des protocoles, du allow, du deny, etc. + 
    image:AZ-104_supervision_30.jpg[]
    
* Service *"NSG Flow logs"* :
    ** 1 NSG permet de protéger la NIC de ma VM (donc IP privée et IP publique) en filtrant les flux entrant et sortant sur les VMs MAIS, par défaut, il n'y a PAS de logs qui sont activés sur les NSGs. +
    -> Le service NSG Flow logs permet de pallier cela et de *savoir ce qui transite par les NSGs*.
    
    ** Le principe du NSG Flow Logs est d'*activer dans un Storage Account cette gestion de logs* (cela devient donc payant) +
    image:AZ-104_supervision_31.jpg[width=600]

* Service *"VPN troubleshoot"* :
    ** Rappel : VNG (Virtual Network Gateway) = VPN managé par Microsoft dans Azure qui se connecte à un VPN on-premises ou multi-cloud.
    ** Imaginons qu'on ait une déconnexion sur mon réseau on-premises à partir de mon VPN côté Azure. +
    J'ai besoin de savoir si le problème vient d'Azure (du service PaaS VNG) OU de mon VPN on-premises
        
        *** Le bon réflexe et la 1ere chose à faire est d'aller dans Service Health pour visualiser si sur la région où j'ai déployé mon VPN côté Azure, le service n'est pas tombé.
        
        *** Si ce n'est pas le cas, on peut se demander s'il n'y aurait pas un *problème de configuration du VPN côté Azure* : est-ce que par exemple la PSK de mon VPN Azure ne serait pas différente de celle de mon VPN on-premise ? +
        -> Le service VPN troubleshoot permet de vérifier cela : 
            **** vous sélectionnez la VNG ou connexion que vous voulez tester, 
            **** ainsi qu'un compte de stockage qui va contenir tous les résultats des tests effectués par Microsoft
            **** puis, en cliquant sur "Start troubleshooting", Azure va tester l'efficience du VPN. +
            -> En fonction du résultat, vous pourrez éliminer la piste du problème VPN côté Azure +
            image:AZ-104_supervision_32.jpg[]

=== AZ-104 EP06 : Gouvernance & Réseau (Private Link)

URL vidéo PHILIT : https://www.youtube.com/watch?v=GngtOaDCb_g&list=PLxf9spw2semSHqq8XvRaiT9HNWzO054MT&index=6

.Constat "malheureux" : on s'occupe souvent de la gouvernance trop tard...
[NOTE]
====
* Constat "malheureux" : c'est souvent une fois que les workloads ont été migrés dans le Cloud public que l'entreprise va prendre en compte la gouvernance 😥

* -> Normalement, la *gouvernance* devrait se réfléchir *AVANT la migration*
====

* Entre autres choses, la gouvernance c'est :

    ** réfléchir à *comment administrer la solution* dans le Cloud public ?
    ** comment on va *gérer les accès de nos utilisateurs à nos ressources* dans le Cloud ?
    ** *QUI fait QUOI et A QUEL MOMENT* dans votre entreprise ?
    ** la *maîtrise des coûts*, comment on va gérer les coûts ? (je dois être "accountable" de ce que je déploie dans le Cloud public Azure)
    ** la *maîtrise de l'aspect compliance* (comme le respect des lois et réglementations nationales et régionales)

-> Microsoft met à notre disposition plusieurs outils pour adresser ce sujet de gouvernance.

==== Management Groups

-> Documentation officielle de Microsoft sur les Management Groups : https://learn.microsoft.com/en-us/azure/governance/management-groups/overview

* Les Management Groups sont un *scope de gouvernance* au-dessus des subscriptions : +
Management Groups -> Subscriptions -> Resource Groups -> Resources

image::AZ-104_gouvernance-reseau_01.jpg[]

* Les Managements Groups ont 3 principaux intérêts : 
    
    ** *Diffuser des droits d'accès (RBAC)* sur les subscriptions (et les RG et les ressources) +
    -> Pas besoin de passer sur chaque subscription pour y définir des droits identiques, il suffit de le faire au niveau de leur Management Group d'où ces droits seront *propagés* (par *héritage*) aux niveaux inférieurs.
    
    ** *Gérer les coûts* par service dans mon entreprise
        *** Exemple : dans le schéma précédent, je peux consulter tous les coûts associés au MG Marketing via le portail Azure.

    ** *Diffuser des Policies* : ensemble de paramètres (qui peuvent être contraignants) qui vont être appliqués à des ressources dans Azure

    ** Un autre intérêt en plus des 3 premiers : *accéder aux Activity Logs* au niveau d'un Management Group, donc à tout ce que font les utilisateurs sur les subscriptions contenues.

-> Le *Root Management Group* est associé à votre Tenant Azure, il ne peut y en avoir qu'un et représente le plus haut niveau hiérarchique.

* Il peut y avoir *au maximum 6 niveaux de hiérarchie* entre un Root Management Group et une subscription.
    ** Le Root Management Group et la subscription de plus bas niveau ne comptent pas dans ce total de 6 niveaux (ils font office de "niveau 0" et "niveau 7")

* 1 subscription ne peut PAS faire partie de plusieurs Management Groups

* Dans une entreprise, *par Tenant*, il est possible d'avoir *jusqu'à 10 000 Management Groups*

*DEMO : Management Groups*

image::AZ-104_gouvernance-reseau_02.jpg[]

* Les Management Groups sont disponibles dans le portail Azure en cherchant "Management Groups"
* Dans cet exemple, Philippe est sur son tenant "The Lord of the Rings"
* Le "Root Management Group" de ce tenant est "Tenant Root Group"
* Ce dernier contient : 
    ** 4 subscriptions directement sous lui
    ** 1 Management Group "IT-LOTR" contenant lui-même 2 subscriptions

* Avec "Create" je peux créer un nouveau Management Group, nommé "Marketing" ici : +
image:AZ-104_gouvernance-reseau_03.jpg[]

* Une fois créé, il est possible de lui ajouter des subscriptions déjà existantes via "Add subscription" +
image:AZ-104_gouvernance-reseau_04.jpg[]

    ** Ici, on va ajouter la subscripion "Le Mordor (85)" à notre Management Group "Marketing". +
    -> "Le Mordor (85)" appartenait auparavant au Management Group "Tenant Root Group", il est donc DEPLACE de ce MG vers le MG "Marketing" +
    image:AZ-104_gouvernance-reseau_05.jpg[]
    image:AZ-104_gouvernance-reseau_06.jpg[]

* Au sein d'un Management Group, la *gestion des droits d'accès* (RBAC) est accessible via le *menu "Access Control (IAM)"* +
image:AZ-104_gouvernance-reseau_07.jpg[]

    ** Les droits d'accès que l'on va y définir vont être appliqués aux subscriptions contenues

* La *gestion des coûts* est accessible via le *menu "Cost analysis"* +
image:AZ-104_gouvernance-reseau_08.jpg[]
    ** Tous les coûts associés aux subscriptions contenues sont agrégés ici

* Les *Activity Logs* du Management Group sont accessibles via le *menu "Activity Log"* +
image:AZ-104_gouvernance-reseau_09.jpg[]

* Les *Policies* appliquées au Management Group sont accessibles via le *menu "Compliance"* +
image:AZ-104_gouvernance-reseau_10.jpg[]

==== Azure Policy

image:AZ-104_gouvernance-reseau_11.jpg[]

* Un Active Directory (AD) on-premises est stocké sur des contrôleurs de domaine (Domain Controller "DC")
+
.Définition d'un Domain Controller
[NOTE]
====
A domain controller is the server responsible for managing network and identity security requests. +
It acts as a gatekeeper and authenticates whether the user is authorized to access the IT resources in the domain.
====

* Sur les DC, il va y avoir des objets : 
    ** *User*
    ** *Group*
    ** *Computer*
    ** *UO* pour *Unité d'Organisation* : les UO vont contenir des objets des 3 types précédents

* A ces UO, on va appliquer les *GPO* (*Group Policy Object*), à savoir des stratégies de groupes
    ** Dans un AD on-premises, une GPO est *liée à une UO* et sert à *appliquer un ensemble de paramètres sur les objets* de cette dernière (users, groups et computers)

    ** Ces paramètres peuvent être, par exemple : 
        *** fond d'écran qui doit être le même pour tous les postes de l'entreprise
        *** la stratégie de mot de passe : dans mon domaine AD, tout le monde doit avoir un mdp d'au minimum 10 caractères avec des chiffres, des lettres, etc. Et je retiens les 6 derniers mdp comme n'étant pas disponibles lors d'une réinitialisation de mot de passe.
        *** le déploiement de logiciels

* Les *Policy dans Azure* reposent sur le même principe que les GPO MAIS elles *s'appliquent uniquement* à des ressources Azure : 
    ** Management Group
    ** Subscription
    ** Resource Group
    ** ou des ressources individuelles

* -> Donc une Azure Policy ne s'applique *PAS à des personnes*

* 🔥 Une Azure Policy *ne tient PAS compte de vos droits en tant qu'utilisateur* 🔥
    ** Exemple : Même si vous êtes Owner d'une subscription, donc avoir tous les droits sur celle-ci, une Policy peut vous interdire de créer des VMs en dehors de la région France Central

* *3 comportements* sont possibles à la *création d'une Policy* pour l'appliquer à un MG, une subscription, un RG ou des ressources :

    ** *Audit* : le comportement qu'il est toujours conseillé d'utiliser au préalable
        *** L'Audit va uniquement vérifier si la Policy est respectée, et faire diminuer la note de compliance si ce n'est pas le cas. +
        L'Audit va donc *juste fournir une information*, et n'aura aucun impact sur les resources en cas de non repect d'une Policy.
    
    ** *Deny* : Exemple "Je ne veux pas que les ressources soient créées en dehors de France Central". +
    Cette Policy en Deny empêche la création de ressources même si l'utilisateur en a le droit (ex : même s'il est Owner de la subscription) +
    Le Deny *s'applique donc à la création des ressources*

    ** *Deploy if not exists* : *Toutes les 20 min*, Azure va exécuter cette Policy sur vos ressources existantes. +
    Si la Policy n'est pas respectée, via des *Remediation Tasks*, Azure va faire en sorte de la *rendre compliant*.
        *** Exemple : Policy "Si ma VM n'est pas backupée, alors je veux que tu la backupes" +
        A sa création, ma VM est créée SANS backup. A ce moment, rien ne se passe. +
        Par contre, 20 min plus tard, Azure détecte l'absence de backup et lance une tâche de remédiation qui va créer un backup sur cette VM, pour rendre la ressource compliant.

* Une Policy est décrite par un *fichier JSON*, qui est appelé dans Azure une *Policy Definition*
    ** Une Policy Definition va donc *checker un paramètre* puis appliquer l'un des 3 comportements Audit, Deny ou Deploy if not exist

* Une *Initiative* regroupe un *ensemble de Policy qui ont le même but*. +
C'est un conteneur qui contient plusieurs fichiers JSON représentant vos Policy. +
image:AZ-104_gouvernance-reseau_18.jpg[width=600]

*DEMO : Policy*

    * Les *Azure Policy* et les *Initiatives* sont accessibles via le *menu "Policy"* du portail Azure +
    image:AZ-104_gouvernance-reseau_12.jpg[]

    * Dans Policy, les "Policy Definitions" sont accessibles via le menu "Definitions" : +
    image:AZ-104_gouvernance-reseau_13.jpg[]

    * Je vais pouvoir *ajouter une nouvelle Policy definition* via "+ Policy definition" +
    image:AZ-104_gouvernance-reseau_14.jpg[width=800]

        ** *Definition location* : Le *niveau dans la hiérarchie des Management Groups* où vous allez stocker votre Policy va avoir un impact sur les subscriptions sur lesquelles vous allez pouvoir l'appliquer.
            *** Si vous choisissez le Root Management Group, la Policy sera applicable sur TOUTES les subscriptions du tenant. +
            Si vous choisissez un MG plus bas dans la hiérarchie, la Policy ne pourra être appliquée que sur les subscriptions contenues dans la sous-arborescence de ce MG.

        ** Exemple de contenu JSON de la Policy definition
        image:AZ-104_gouvernance-reseau_15.jpg[width=800]

            *** Microsoft met à disposition 2 moyens de récupérer des *exemples de Policy definition* : 
                **** le *repo GitHub* https://github.com/Azure/azure-policy +
                image:AZ-104_gouvernance-reseau_16.jpg[width=800]
                **** Chercher une Policy "BuiltIn" de Microsoft via le menu "Definition" d'une Azure Policy et la fonctionnalité de *Search* : +
                image:AZ-104_gouvernance-reseau_17.jpg[]

.Explication de ce que représente un SKU (Stock Keeping Unit) dans Azure
[NOTE]
====
* Philippe définit un SKU comme *la "puissance" associée à un service Azure*.

* Par analogie, on peut également le voir comme *les différentes versions / modèles d'un même produit*.
    ** Par exemple, je vais pouvoir acheter ma Google Pixel Tablet soit en version A avec 128 Go de mémoire, soit en version B avec 256 Go +
    -> Un SKU plus "élevé" représente de meilleures caractéristiques pour mon service, et donc également un prix plus élevé.
====

==== Modèle RBAC dans Azure

* L'*Azure Active Directory* (renommé Azure Entra ID) est un *annuaire* contenant des *users* et des *groups*
    ** Les users de l'AAD vont être associés à un certain nombre de subscriptions
    ** Les users déclarés dans votre tenant peuvent recevoir des droits sur ces subscriptions qui sont liées au tenant
    ** Le tenant est donc rattaché à plusieurs subscriptions Azure, et une subscription Azure a comme référentiel d'identités le tenant.

* Il est important de *distinguer* la *gestion des droits RBAC sur les ressources* Azure de *celle sur le tenant* lui-même. +
-> Il s'agit de 2 gestions de droits différentes : rôles sur le tenant ET rôles sur les ressources

.Azure AD roles pour le tenant
image:AZ-104_gouvernance-reseau_19.jpg[width=600]

.Azure RBAC roles pour les ressources Azure
image:AZ-104_gouvernance-reseau_32.jpg[]

* Pra exemple, dans le schéma ci-dessus, les rôles suivant sont *uniquement dédiés au tenant* : 

    ** *Billing admin* : gestion de l'aspect facturation sur le tenant (comme vos licences P1, P2)
    ** *Application admin* : pour pouvoir publier des applicatifs dans l'Azure Active Directory
    ** *Global Admin* : le plus haut niveau de rôle, qui en plus de vous donner les droits des rôles précédents, vous permet de configurer la synchronisation entre votre AD on-premises et l'Azure AD, et d'inviter d'autres utilisateurs (Guest), etc.

* -> Il est très important de comprendre qu'un *user peut être "Global admin" sur le tenant MAIS n'avoir AUCUN accès sur les ressources Azure du tenant*.
    ** Les *rôles sur le tenant* s'appellent des *Azure AD roles*
    ** Les *rôles sur les ressources Azure* s'appellement des *Azure RBAC roles*
        *** Ces droits RBAC se configurent via le *menu "Access control (IAM)"* de la ressource ciblée (Management Group, Subscription, Resource Group, Resource)

*DEMO : RBAC*

    * Dans mon tenant, donc en cherchant "Azure Active Directory" (Azure Entra ID) sur le portail Azure : +
    image:AZ-104_gouvernance-reseau_20.jpg[]

    * je sélectionne un user : +
    image:AZ-104_gouvernance-reseau_21.jpg[]

    * Via le *menu "Assigned roles"*, je vais pouvoir *gérer ses Azure AD roles*, donc ses droits sur l'Azure AD *UNIQUEMENT* : 
    image:AZ-104_gouvernance-reseau_22.jpg[]
    image:AZ-104_gouvernance-reseau_23.jpg[]

    * Via le *menu "Azure role assignments"*, je vais pouvoir *visualiser* (uniquement visualiser) ses *rôles RBAC* sur les ressources Azure : +
    image:AZ-104_gouvernance-reseau_33.jpg[]

        ** Ici je vois que l'utilisateur "philippe.paiola" a un rôle "Owner" sur un Management Group. +
        Si je vais sur une subscription appartenant à ce MG, je retrouve bien, dans la console "Access control (IAM)", onglet "Role assignments", ce rôle "Owner" pour "philippe.paiola" qui est indiqué comme étant *hérité du scope "Management Group"*. +
        image:AZ-104_gouvernance-reseau_34.jpg[]

    * Si à ce même user, je voulais donner des *rôles RBAC sur des ressources Azure*, cela ne se ferait *PAS dans l'Azure AD*, mais, par exemple, dans un Resource Group via la *console "Access control (IAM)"* : +
    image:AZ-104_gouvernance-reseau_24.jpg[width=400]

        ** Via l'*onglet "Roles"* de cette console, je vais pouvoir également accéder aux *rôles built-in pré-créés par Microsoft* (type "BuildInRole") : 
        image:AZ-104_gouvernance-reseau_25.jpg[]
+
.3 rôles RBAC à connaître pour la certification AZ-104
[NOTE]
====
* *Owner* : Grants full access to manage all resources, including the ability to assign roles in Azure RBAC.
    ** Vous avez tous les droits sur cette ressource PLUS le droit de donner les droits RBAC à d'autres personnes de votre tenant

* *Contributor* : 
Grants full access to manage all resources, but does not allow you to assign roles in Azure RBAC, manage assignments in Azure Blueprints, or share image galleries.
    ** Vous avez tous les droits sur cette ressource MAIS vous ne pouvez PAS donner de droits RBAC dessus à des tiers (*ni à vous-même* d'ailleurs)

* *Reader* : View all resources, but does not allow you to make any changes.
    ** Vous n'avez QUE des droits en lecture sur les ressources : vous ne pouvez pas les modifier, ni créer d'autres ressouces MAIS vous pouvez visualiser tous les paramètres d'une ressource
    ** C'est un droit pratique par exemple *pour des auditeurs*.
====

    * Je vais retrouver ces droits quand je fais un *"Add role assignment"* via la console "Access control (IAM)" +
    image:AZ-104_gouvernance-reseau_26.jpg[]
    
    * La *bonne pratique* est de *définir des droits RBAC sur des groups* plutôt que sur des users individuels car plus facile à manager.

    * Si les rôles built-in proposés par Microsoft ne me conviennent pas, je peux *créer mes propres rôles custom* via un *"Add custom role"* dans la console "Access control (IAM)" +
    image:AZ-104_gouvernance-reseau_27.jpg[] +
    {sb}
    Exemple avec la *création d'un custom role "adminsap"* auquel : 

        ** Je vais *ajouter les permissions* dont j'ai besoin pour administrer des composants SAP : +
        image:AZ-104_gouvernance-reseau_28.jpg[]
        image:AZ-104_gouvernance-reseau_29.jpg[]

        ** Je vais *définir un scope* à mon rôle : +
        image:AZ-104_gouvernance-reseau_30.jpg[]
            *** Par défaut le scope proposé est la subscription, mais on peut en choisir d'autres via "Add assignable scopes"

        ** Dans l'*onglet "JSON"*, Azure m'a créé le fichier JSON correspondant à mon nouveau rôle custom : +
        image:AZ-104_gouvernance-reseau_31.jpg[]

+
.Custom roles à utiliser avec parcimonie
[WARNING]
====
* Microsoft conseille d'utiliser les *custom roles* avec *parcimonie* car il *ne tient PAS ces derniers à jour*. 

* Si demain un nouveau service Azure concernant SAP devait sortir, Microsoft mettrait à jour les built-in roles et ajouterait le rôle SAP requis MAIS il ne toucherait pas aux rôles custom. +
-> C'est une des *limitations des custom roles*, *c'est à VOUS de les tenir à jour* dans le temps.
====

==== Cost Management

* Menu "Subscriptions" du portial Azure : coût actuel pour chaque subscription depuis le début du mois +
image:AZ-104_gouvernance-reseau_35.jpg[]

* Pour une *subscription spécifique*, le menu "Overview" donne le *coût mensuel courant* et une *prévision* du coût à la fin du mois : +
image:AZ-104_gouvernance-reseau_36.jpg[]

* Pour plus de détails, aller dans le *menu "Cost analysis"* qui propose des graphiques supplémentaires : +
image:AZ-104_gouvernance-reseau_37.jpg[]

    
    ** *consommation par service* (service et NON ressource) : une ressource c'est par exemple Windows 2019, mais le service lui est Azure Virtual Machine et plusieurs VMs peuvent tourner dans la subscription
    ** *coût par région*
    ** *coût par resource group*

    ** Il est également possible de *filtrer les coûts affichés par tag* : +
    image:AZ-104_gouvernance-reseau_40.jpg[]

* Via le *menu "Budgets"*, on peut *définir un budget* qui, quand un certain prorata est atteint (ici 100%), va donner lieu à la *création d'une alerte* (ici l'envoi d'un mail) +
image:AZ-104_gouvernance-reseau_38.jpg[]
image:AZ-104_gouvernance-reseau_39.jpg[]

* Le *Cost Management* est maintenant disponible en tant qu'*App sur smartphone* (App "Azure" https://play.google.com/store/apps/details?id=com.microsoft.azure), Philippe a créé une vidéo YouTube Short pour l'expliquer :

ifdef::env-github[]
https://www.youtube.com/watch?v=IjSRjZk7ms4[vidéo de la présentation sur YouTube]
endif::[]
ifdef::env-browser[]
video::IjSRjZk7ms4[youtube, width=640, height=480]
endif::[]

* Via le *menu "Billing profile invoices"*, on peut *configurer différents types d'alertes de facturation* que l'on peut ensuite recevoir par mail.

==== Service Private Link (réseau)

IMPORTANT: Il est très courant d'avoir des questions sur ce service lors de la certification AZ-104 !

* Rappels : +
image:AZ-104_gouvernance-reseau_41.jpg[width=600]

    ** Quand on déploie une *VM dans Azure* (IaaS), elle a *TOUJOURS une NIC*, donc *obligatoirement une IP privée* et *facultativement une IP publique*

    ** Les *services PaaS* ont eux : 
        *** *toujours des IP publiques* : c'est la raison pour laquelle on ne peut pas leur donner n'importe quels noms, car Azure va créer des noms de domaine associés aux services PaaS, et ces noms de domaine vont être accessibles depuis une IP publique
        *** *presque jamais une IP privée* : à l'exception des SQL Managed Instance et des Web App sur ASE (App Service Environment), soit 2 services sur les centaines de services PaaS disponibles sur Azure qui peuvent avoir une IP privée native en tant que service PaaS... +
        Il y a toujours quelques exceptions, mais ce comportement est la norme.

* *Azure Private Link* regroupe *3 fonctions en 1* : +
image:AZ-104_gouvernance-reseau_42.jpg[]

    1. *Customer Owned Services*
    2. *Azure PaaS Services* : nous allons ici nous concentrer sur ce service *lié aux Private Endpoint*
        *** C'est ce service qui est particulièrement ciblé par la certification AZ-104
    3. *Partner Services*

* La plupart des *services PaaS* (Storage Account, une BDD SQL, etc.) ont (quasi) toujours une *IP publique* et pas d'IP privée
* Comme ils ont des IPs publiques, ils ont des *noms de domaine (NDD) publics*, rattachés à celles-ci.
    ** Exemple : Un blob dans un Storage Account va avoir comme URL "xxx.blob.core.windows.net", pour une BDD managée l'URL sera "xxx.database.windows.net" 

* DONC, quand un client crée une BDD managée, elle a une *portée publique*. +
Et un client qui crée un Storage Account va avoir des données dessus qui potentiellement ont une portée publique puisqu'il y a un domaine de domaine public et une IP publique au service PaaS. +
-> Pour adresser cette problématique, Microsoft a créé le service *Azure Private Link*

    ** L'une des fonctions de Private Link est dédiée aux services PaaS (2️⃣ du schéma) et concerne les Private Endpoint. 

.Définition d'un Private Endpoint
[NOTE]
====
Un Private Endpoint est une *carte réseau*, donc une *NIC* (et donc une IP privée), à qui on a *adjoint une zone DNS privée* qui *pointe sur le nom de domaime public* de vos services PaaS.

-> Le Private Endpoint est une fonctionnalité supplémentaire qui va permettre de rendre accessible des services PaaS via des IP privées.

C'est la "révolution" apportée par le Private Endpoint : là où les services PaaS Microsoft étaient auparavant accessibles via des IP publiques et PAS des IP privées, avec le Private Endpoint ces services sont maintenant accessibles depuis des NIC, donc des IP privées positionnées dans des subnets qui eux-mêmes font partie de VNet.
====

[WARNING]
====
Le Private Endpoint *n'attribut PAS une IP privée* à un service PaaS !

* -> Il permet juste à votre réseau on-premises ou à une ressource Azure d'accéder à un service PaaS via une IP privée MAIS cette IP privée n'est PAS rattachée à ce service.
* Cette IP privée *rend accessible le service PaaS depuis celle-ci* en passant par la zone DNS privée qui pointe sur le nom de domaine public du service PaaS.
====

* Cela va permettre à une VM ou à votre réseau on-premises qui est raccordé, par exemple par une ligne ExpressRoute, d'accéder à l'IP privée représentée par la NIC (10.1.1.5 dans le schéma), et cette IP privée a une zone DNS privée qui pointe sur le nom de domaine public du service PaaS.

[WARNING]
====
-> Tout ceci ne change rien à la portée publique par défaut du service PaaS (son IP publique existe toujours).

* Pour supprimer cette portée publique, il faudra, dans le cas d'une Web App par exemple, désactiver l'accès public à la Web App dans le Firewall.
    ** On va désactiver l'accès public MAIS cela ne va PAS supprimer l'IP publique du service.
====

*DEMO : Private Link*

    * Quand je crée un *nouveau Storage Account*, comme expliqué précédemment, je ne peux pas renseigner n'importe quel "Storage Account Name" (je ne peux PAS commencer par une majuscule ou des caractères de ponctuation par exemple) +
    image:AZ-104_gouvernance-reseau_43.jpg[width=800]

    * Si on fait un *nslookup* de l'URL associée à ce Storage Account, ici "sademopp69.blob.core.windows.net" (nom de domaine associé aux services blob dans Azure), on voit que celui-ci a bien une IP publique : +
    image:AZ-104_gouvernance-reseau_44.jpg[width=800]

    * Si on se connecte en RDP à la VM Azure que l'on a utilisé dans les précédents exemples (w2k19) : +
    image:AZ-104_gouvernance-reseau_45.jpg[width=600]
    image:AZ-104_gouvernance-reseau_46.jpg[]

    * cette VM se connecte au Storage Account via son IP publique, ce que l'on peut de nouveau vérifier à l'aide d'un nslookup depuis la VM.

    * Via le *menu "Private link services"* du "Private Link Center" du portail Azure, *créons maintenant un Private Endpoint*, donc une carte réseau (NIC), qui va être déposé dans le même subnet que ma VM, pour lui permettre d'accéder au Storage Account *QUE par son IP privée* : +
    image:AZ-104_gouvernance-reseau_48.jpg[]

        ** Je fais attention de *créer la NIC dans la même région que ma VM* : +
        image:AZ-104_gouvernance-reseau_49.jpg[width=800]

        ** Parmi la liste de tous les services PaaS concernés par le Private Endpoint, je choisis les "Storage Account" (Resource type) : +
        image:AZ-104_gouvernance-reseau_50.jpg[width=800]
        
        ** Et dans ces Storage Account, celui qui m'intéresse est "sademopp69" (Resource), créé à l'instant, et plus particulièrement l'hébergement de blob (Target sub-resource) : +
        image:AZ-104_gouvernance-reseau_51.jpg[width=800]

        ** Il faut ensuite indiquer *OU mettre la carte réseau* (NIC), à savoir *dans le VNet de ma VM* : +
        image:AZ-104_gouvernance-reseau_52.jpg[width=800]

        ** Là Azure va proposer de *créer dans mon Resource Group la zone DNS privée* qui servira pour la résolution de nom : +
        image:AZ-104_gouvernance-reseau_53.jpg[width=800]

    * -> Créer un Private Endpoint prend plusieurs minutes

    * Maintenant que le *Private Endpoint est créé*, on va *créer une nouvelle VM* dans Azure (très rapide) que l'on va mettre *dans les mêmes VNet et subnet que ce dernier* : 
    image:AZ-104_gouvernance-reseau_54.jpg[width=800]
+
[NOTE]
====
Se connecter la 1ere fois à une VM qui vient d'être créée est toujours plus long car il faut *créer le profil utilisateur*.
====
    
    * Une fois sur cette nouvelle VM, quand je ferai un nslookup sur le nom de domaine public de mon Storage Account (xxx.blob.core.windows.net), celui-ci va me *renvoyer l'IP privée du Private Endpoint*

        ** Mais pour d'autres machines, en dehors du VNet du Private Endpoint, ce sera toujours l'IP publique qui sera remontée par un nslookup sur le nom de domaine public du Storage Account : +
        image:AZ-104_gouvernance-reseau_55.jpg[width=600]
            *** Sur ce dernier screenshot, le nslookup est toujours fait "depuis chez Philippe", donc hors du VNet du Private Endpoint, raison pour laquelle c'est toujours l'IP publique qui est remontée (car je n'accède pas à la carte réseau du Private Endpoint)
            *** PAR CONTRE, maintenant que le *private link a été créé*, on voit qu'un *2nd alias (2nd nom de domaine) pour le service blob du Storage Account* est apparu *"sademopp69.privatelink.blob.core.windows.net"*

    * Maintenant, pour *fermer l'accès public au Storage Account*, aller dans le portail Azure sur le Storage Account, dans le *menu "Networking"* où il est possible de *désactiver le "Public network access"* +
    image:AZ-104_gouvernance-reseau_56.jpg[]
        
        ** Il est également possible d'*utiliser un firewall*, qui est associé au Storage Account, en choisissant *"Enabled from selected virtual networks IP addresses"* comme "Public network access" : +
        image:AZ-104_gouvernance-reseau_57.jpg[]
            
            *** Ce dernier permet de *préciser les accès externes qui sont autorisés*

[NOTE]
====
-> Dans *tous les services PaaS* il existe des *firewall configurables*.
====

    * De nombreux clients préfèrent, principalement pour des raisons de sécurité / confidentialité, accéder à les services PaaS à l'aide d'IP privées plutôt que d'IP publiques.
        ** Exemple avec un BDD SQL managée par Microsoft (SQL Database), préférez-vous y accéder par une IP publique ou une IP privée ? Plutôt une IP privée non ? 😉

    * CONCLUSION de la démo :

        ** Souvent on dit qu'on *"fait du Private Endpoint dans Azure"*. C'est un *abus de langage*.

            *** -> Pour être précis sur les termes, *on utilise le service Private Link*
            *** qui *regroupe plusieurs fonctionnalités*, 
            *** dont celle d'*accéder à un service PaaS via une NIC*, 
            *** et cette possibilité vous est *offerte par la création d'un Private Endpoint*

        ** Dans le Resource Group déclaré, on va pouvoir retrouver : +
        image:AZ-104_gouvernance-reseau_58.jpg[]

            *** Le *Private Endpoint*
            *** *La NIC de celui-ci*, NIC qui correspond à une IP privée, celle qui va être renvoyée par le nslookup une fois que le Private Endpoint aura été déployé +
            image:AZ-104_gouvernance-reseau_59.jpg[]

            *** et *la zone DNS privée*, qui pointe vers le nom de domaine public de mon service PaaS (ici notre Storage Account) +
            image:AZ-104_gouvernance-reseau_60.jpg[]

=== AZ-104 EP07 : Storage Account

URL vidéo PHILIT : https://www.youtube.com/watch?v=VnVkfxUF1JQ&list=PLxf9spw2semSHqq8XvRaiT9HNWzO054MT&index=7

Sommaire du cours : 

    * *Storage Account* : services, réplications, performances
        ** le "disque dur" de vos données dans le Cloud public Azure

    * *Blob* : niveau d'accès, lifecycle, immutable
    * *Sécurité des données* : SSE, SAS, SAT, RBAC, etc.
    * *Azure Files*
    * *AZCopy*, *Import / Export* & *Storage Explorer*
        ** AZCopy est le successeur de RoboCopy et XCopy

==== Azure Storage Account

* *3 types de données* peuvent être stockées dans un *compte de stockage* : +
image:AZ-104_storage-account_01.jpg[]

    ** des *données structurées* : typequement, les tables d'une BDD, avec un format qui est toujours le même
    ** des *données semi-structurées* : comme du XML, JSON, YAML
    ** des *données non-structurées* : tout ce qui est blob (jpg, Powerpoint, Word, etc.) et qui est toujours stocké dans un container au sens de dossier / répertoire et NON de container Docker. +
    Le blob peut lui être vu comme l'équivalent d'un fichier.
        *** On a donc : +
        Blob (~*fichier*) CONTENU DANS un container (~*dossier / répertoire*) CONTENU DANS un Storage Account (l'équivaleut du *"C:\"* de l'Explorateur Windows)

* Le Storage Account propose *4 services* (plus un 5e, les *managed disks* dont nous ne parlerons pas tout de suite) : +
image:AZ-104_storage-account_02.jpg[]

    1. *Service Container* (dossier) à base de *blobs* (fichier) : images, documents, audio, les Activity Logs de votre OS, etc.

    2. *Service Table* : à base de clés, valeur et en lien avec tout ce qui SQL

    3. *Service Queue* : j'ai des images uploadées sur un site web, et au fur et à mesure qu'elles sont uploadées, j'ai un traitement qui va les redimensionner pour les faire correspondre au site web. +
    J'ai donc ici une queue, ou *file d'attente*. Plus la file est remplie, plus il y a de temps d'attente pour le traitement des images. +
    -> Donc plus la file d'attente est faible meilleure est l'expérience utilisateur.
        ** Avec des concepts comme le *FIFO* (First In First Out) : la 1ere image uploadée va être la 1ere à être redimensionnée.

    4. *Service Azure Files* : Tout ce qui est partage réseau, avec les protocoles *SMB* (Server Message Block) ou *NFS* (Network File System). +
    Ce qui permet, derrière un path du type *"\\<nom du Storage Account>\<nom du partage>"*, d'accéder en SMB ou en NFS à votre Storage Account au *format Azure Files*. +
    -> Il s'agit donc d'un *service de partage réseau managé par Microsoft*.

-> Pour la *certification AZ-104*, il faut connaître le *Service Container* et le *Service Azure Files*.

.Question : Peut-on monter un lecteur réseau sur un blob dans un container ? 
[NOTE]
====
* C'est possible si le blob est un VHD (Virtual Hard Disk) qui contient une VM. +
Dans ce cas, sur cette VM il est possible de monter un partage réseau (un partage SMB).

* Par contre, en faisant ainsi, on ne bénéficiera PAS du service PaaS. +
-> Si on veut avoir un *service managé dans Azure à base de SMB ou de NFS*, il faut passer par *Azure Files*.
====

* Suivant nos use cases, il ne sera pas systématiquement nécessaire d'avoir un Storage Account proposant les 4 (5) services précédents. +
Aussi Azure propose-t-il *différents types de Storage Account* pour *cibler uniquement les besoins identifiés* : +
image:AZ-104_storage-account_03.jpg[]

    ** *StorageV2* : le choix *par défaut* à la création du Storage Account : une technologie qui va contenir les 4 (5) précédents services.
        *** Ce type de Storage Account permet donc de gérer des données de tous types : structurées, semi-structurées, non structurées

    ** *BlobStorage* et *Block blog storage* pour utiliser uniquement les *blobs du service Container*

        *** Les blobs peuvent être soit page blob, soit block blob, soit append blob
        *** Un *appenb blob* est un blob auquel Azure va typiquement devoir *accéder à haute fréquence en lecture et écriture* : par exemple, pour tout ce qui est *Activity Logs* du Storage Account, ou d'une VM (Azure est toujours en train d'écrire dedans)
        *** Les *block blobs* sont les blobs les plus communs, pour des *tailles de fichiers standards*
        *** Les *page blobs* sont réservés aux *fichiers très volumineux*, plusieurs Go ou plusieurs To

    ** *File Storage* quand on va veut faire uniquement du *partage réseau*

    ** *Différence entre Storage (general purpose v1) et StorageV2 (general purpose v2)* : 
        *** Storage v1 est l'ancienne technologie historique dans Azure, que l'on ne devrait normalement plus rencontrée et qui est beaucoup plus limitante que la v2 : 
            **** Il y a par exemple beaucoup plus de type de réplications possibles avec un storage v2
        *** -> Moralité : *choisissez toujours du StorageV2 à la place du v1*

.Question : Quel serait le service le plus approprié pour du transfert de fichiers via SFTP ?
[NOTE]
====
-> Azure propose du SFTP sur un Storage Account au format Blob
====

    ** La technologie du compte de stockage va également permettre de disposer de *plus ou moins d'options de réplication*

.Rappel : Availability Zone (AZ)
[NOTE]
====
* 1 région Azure possède *soit 3 Availability Zones (AZ) soit PAS DU TOUT*.
* Les AZ sont *distantes de plusieurs kms* et *regroupent chacune plusieurs data centers* (DC). +
* Le principe est que si 1 AZ entière tombe (incendie, inondation, etc.), les 2 autres zones ne sont pas forcément touchées.
====

* Les *6 méthodes de réplication* dans un Storage Account : +
image:AZ-104_storage-account_06.jpg[]

    ** *LRS* (*Locally Redundant Storage*) : 3 copies synchrones de vos données dans le même data center d'une région
        *** C'est Microsoft qui choisit le data center, PAS le client
    {lb}

    ** *ZRS* (*Zone-Redundant Storage*) : 3 copies synchrones de la donnée dans 3 data centers chacun dispatché dans l'1 des 3 AZ de la région.
        *** C'est de nouveau Microsoft que choisit le data center où vos données seront copiées dans chacune des 3 AZ
    {lb}

    ** *GRS* (*Geo-Redundant Storage*) : 6 copies de la donnée dont : 
        *** 3 copies synchrones en LRS dans 1 DC de la région primaire
        *** ET 3 copies synchrones en LRS dans 1 data center de ma 2nd région
            **** Cette 2nd région est souvent la région "pair" de la 1ere, à savoir la région dite "de bascule". On parlera également de "Primary region" et de "Secondary Region"  +
            -> Par exemple, la région "pair" de North Europe est West Europe (et réciproquement)
        *** *Ces 2 séries de 3 copies étant asynchornes* l'une par rapport à l'autre.
    {lb}

    ** *GZRS* (*Geo-zone-redundant storage*) : 6 copies de la donnée dont : 
        *** 3 copies synchrones en ZRS dans la région primaire
        *** ET 3 copies synchrones en LRS dans la 2e région
        *** *Ces 2 séries de 3 copies étant asynchornes* l'une par rapport à l'autre.
    {lb}

    ** *RA-GRS* (*Read-Access Geo-Redundant Storage*) et *RA-GZRS* (*Read-Access Geo-zone-redundant storage*) : Il s'agit des méthodes GRS et GZRS en "Read-Access" (RA)
        
        *** Ce *"Read-Access"* signifie qu'*à tout moment on a accès en lecture seule à la 2nd région*, via une URL communiquée par Microsoft.
        *** Contrairement au *GRS* et *GZRS* où ce n'est *QUE quand vous basculez (lors d'un failover) dans la 2nd région* que vous aurez *accès en lecture ET en écriture* à vos données dans celle-ci.

            **** Le failover de la région primaire vers la région secondaire est déclenché soit par les équipes de Microsoft si on a détecté que la région est tombée (par exemple), soit manuellement par le client.
            **** Une fois que la région primaire est de nouveau up, on peut alors effectuer un *failback*, à savoir de repasser les données dans la région primaire.

        *** Cas d'usage : 

            **** Vous avez un *audit* sur un logiciel de compatibilité et les auditeurs ont besoin d'accéder en lecture aux informations de celui-ci. +
            Plutôt que d'accéder au Storage Account de la région primaire, *vous leur donnerez accès au Storage Account de la région secondaire* qui contient les données répliquées de manière asynchrone depuis la région primaire. +
            -> Cela permet de ne pas impacter l'environnement de PROD des utilisateurs.

            **** Vous voulez une *haute disponibilité* de votre application et qu'au cas où la région primaire tombe, on puisse basculer les utilisateurs sur la région secondaire afin qu'ils puissent *accéder à l'application en lecture seule* (fonctionnement dégradé) *SANS avoir besoin de déclencher un failover*.
{lb}

* Plus la méthode de réplication va contenir de réplicas de vos données, plus la donnée va être chère à répliquer.
    ** Car on va devoir payer la lecture / écriture d'un 2e Storage Account dans une 2nd région, la bande passante, etc.
    ** Donc la *méthode de réplication la moins chère* dans Azure est bien le *LRS* : que 3 copies de la données dans 1 seul data center.
        *** Avec le LRS, on a donc une moins bonne disponibilité des données, le SLA sera moins élevé, MAIS le coût sera plus faible par rapport aux données brutes stockées dans les data center Microsoft.

[TIP]
====
Voir également la documentation Learn Microsoft sur le Azure Storage redundancy pour plus d'informations : +
https://learn.microsoft.com/en-us/azure/storage/common/storage-redundancy
====

TO BE COMPLETED



















== Définitions et explications diverses

* Pour un *service en "Preview"* sur Azure : 
    ** *Pas de SLA associé* : en cas d'indisponibilité du service, il n'y a pas de pénalité financière côté Microsoft, aucun avoir n'est dû au client
    ** *Pas d'engagement de support* de Microsoft (c'est du "best effort") : il est donc déconseillé d'utiliser le service en PROD.
    ** *Le service est souvent gratuit* durant toute la durée de la Preview.

    ** -> Après cette phase de Preview le *service "confirmé"* passera en *General Availability*, et deviendra dès lors payant (très souvent) avec un SLA associé.

== Ressources

D'autres sites permettant de préparer la certification :

    * Le cours Udemy de Alan Rodrigues (payant) : https://www.udemy.com/course/microsoft-certified-azure-administrator/
    * Ce site d'un personne ayant réussi les anciens examens 303 et 304 et donnant quelques conseils et ressources : https://www.programmingwithwolfgang.com/how-to-pass-az-303-and-az-304-certification-exams/

    * Learning paths on MS Learn : https://learn.microsoft.com/en-us/certifications/azure-administrator/
    * MS Learn : https://docs.microsoft.com/en-us/learn/browse/?roles=administrator&products=azure
    * Azure Code Samples : https://azure.microsoft.com/en-us/resources/samples/?sort=0
    * Official Azure Documentation : https://docs.microsoft.com/en-us/azure/
    * Official Microsoft Azure YouTube Channel : https://www.youtube.com/user/windowsazure
    * L'excellent cours YouTube de PHILIT qui couvre l'AZ-104 et l'AZ-305 : https://www.youtube.com/playlist?list=PLxf9spw2semSHqq8XvRaiT9HNWzO054MT

Sites de *labs* et *workshops* pour pratiquer : 

    * Azure Citadel - Labs and Workshops : https://azurecitadel.com/
    * Microsoft Cloud Workshop - More labs and workshops : https://microsoftcloudworkshop.com/
    * Labs from Microsoft Training on GitHub : 
        ** https://github.com/MicrosoftLearning/AZ-303-Microsoft-Azure-Architect-Technologies : *LA* ressource officielle de Microsoft pour pratiquer l'AZ-303
        ** https://github.com/MicrosoftLearning/AZ-104-MicrosoftAzureAdministrator/
        ** Ces labs de Microsofts sont vraiment des guides "step by step" permettant de manipuler les technologies Azure autour d'un thème donné.

Sites d'examens blancs (*mock exams*), questions / réponses pour s'entraîner : 

    * ExamTopics AZ-104 : https://www.examtopics.com/exams/microsoft/az-104/

Site pour se familiariser avec le site de certification de Microsoft : https://aka.ms/examdemo

== Mock exams

=== Free exam from XXX

----
Q1) Some question

 ✅ good
 ❌ bad


Q2) Some other question
----

== Lexique

[glossary]
ABS:: Azure Backup Server
ACU:: Azure Compute Units. Notion used for Web Apps service plans to "give a number" to the pair processing speed / memory (like 100 ACU, 200 ACU, etc.)
ARS:: Azure Route Server
ASA:: Adaptive Security Appliances is a piece of cybersecurity hardware sold by Cisco
ASE:: App Service Environment
ASR:: Azure Site Recovery
BGP:: Border Gateway Protocol
CSP:: Cloud Service Provider
DC:: Domain Controller (pour un AD)
DRP:: Data Recovery Plan
FIFO:: First In First Out
FQDN:: Fully Qualified Domain Name
GPO:: Group Policy Object
GRS:: Geo-Redundant Storage
IAM:: Identity and Access Management
IKE:: Internet Key Exchange. Le protocole IKE est chargé de négocier la connexion. Avant qu'une transmission IPSec puisse être possible, IKE est utilisé pour authentifier les deux extrémités d'un tunnel sécurisé en échangeant des clés partagées.
IPAM:: IP Address Management
IPSec:: Internet Protocol Security
ISMS:: Information Security Management Systems
ITSM:: IT Service Management
KQL:: Kusto Query Language
LNG:: Local Network Gateway
LRS:: Locally Redundant Storage
MACsec:: Media Access Control Security
MARS:: Microsoft Azure Recovery Services
MMA:: Microsoft Monitoring Agent
MMC:: Microsoft Management Console
MX:: Mail eXchanger. A mail exchanger record (MX record) specifies the mail server responsible for accepting email messages on behalf of a domain name. It is a resource record in the Domain Name System (DNS).
NDD:: Nom De Domaine
NFS:: Network File System
NIC:: Network Interface
NSG:: Network Security Group
NVA:: Network Virtual Appliance
PCA:: Plan de Continuité d'Activité
PDCA:: an acronym for Plan-Do-Check-Act
PRA:: Plan de Reprise d'Activité
PSK:: Pre-shared key
RADIUS:: Remote Authentication Dial-In User Service. RADIUS est un protocole client-serveur permettant de centraliser des données d'authentification.
RBAC:: Role-Based Access Control
RPO:: Recovery Point Objective
RTO:: Recovery Time Objective
RSV:: Recovery Service Vault
SA:: Security Association
SCOM:: System Center Operations Manager
SKU:: *Stock-Keeping Unit* (SKU) is a generic inventory term, that allows to represent the different shapes of the product.
SMB:: Server Message Block
SNAT:: Source Network Address Translation
SSPR:: Self-Service Password Reset
SSTP:: Secure Socket Tunneling Protocol
UDR:: User Defined Route
UO:: Unité d'Organisation
UPN:: User Principal Name
VIP:: Virtual IP Address
VHD:: Virtual Hard Drive
VMSS:: Virtual Machines Scale Set
VNG:: Virtual Network Gateway
WAF:: Web Application Firewall
WAN:: Wide Area Network. Désigne le réseau informatique connectant les sites d'une entreprise entre eux et à Internet. +
le SD WAN est évolution du WAN lui conférant davantage d'agilité et de flexibilité. +
Pour plus de détails, voir https://www.pyxya.fr/le-wan-intelligent/wan-sd-wan-et-limites-actuelles/





























