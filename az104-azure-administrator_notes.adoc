= Microsoft Azure Administrator Associate AZ-104
Thomas SCHWENDER <icon:github[] https://github.com/Ardemius/[GitHub] / icon:twitter[role="aqua"] https://twitter.com/thomasschwender[@thomasschwender]>
// Handling GitHub admonition blocks icons
ifndef::env-github[:icons: font]
ifdef::env-github[]
:status:
:outfilesuffix: .adoc
:caution-caption: :fire:
:important-caption: :exclamation:
:note-caption: :paperclip:
:tip-caption: :bulb:
:warning-caption: :warning:
endif::[]
:imagesdir: ./images
:resourcesdir: ./resources
:source-highlighter: highlightjs
:highlightjs-languages: asciidoc
// We must enable experimental attribute to display Keyboard, button, and menu macros
:experimental:
// Next 2 ones are to handle line breaks in some particular elements (list, footnotes, etc.)
:lb: pass:[<br> +]
:sb: pass:[<br>]
// check https://github.com/Ardemius/personal-wiki/wiki/AsciiDoctor-tips for tips on table of content in GitHub
:toc: macro
:toclevels: 4
// To number the sections of the table of contents
//:sectnums:
// Add an anchor with hyperlink before the section title
:sectanchors:
// To turn off figure caption labels and numbers
:figure-caption!:
// Same for examples
//:example-caption!:
// To turn off ALL captions
// :caption:

toc::[]

== Examen et ressources de pr√©paration

Microsoft AZ-104 examen : https://learn.microsoft.com/en-us/certifications/exams/az-104/

Exam plan : 

    * Manage Azure identities and governance (20-25%)
    * Implement and manage storage (15-20%)
    * Deploy and manage Azure compute resources (20-25%)
    * Implement and manage virtual networking (15-20%)
    * Monitor and maintain Azure resources (10-15%)

D√©roulement de la certification :

    * Exam Duration 120 mins
    * Number of Questions 40-60 Questions
    * Pass Score 700 (on a scale of 1-1000)

Description pr√©cise des connaissances √† poss√©der pour la certification par Microsoft : +
https://query.prod.cms.rt.microsoft.com/cms/api/am/binary/RE4pCWy

[NOTE]
==== 
Pour plus d'informations sur la certification AZ-104 (nombre de questions, passing score, etc.), voir la description faite par *testprep training* : +
https://www.testpreptraining.com/microsoft-azure-administrator-associate-az-104

Le site propose √©galement un *AZ-104 Online Tutorial* : https://www.testpreptraining.com/tutorial/exam-az-104-microsoft-azure-administrator-associate/
====

[NOTE]
====
Pour un *poster des certifications Microsoft*, tr√®s r√©guli√®rement mis √† jour, voir https://aka.ms/certificationsposter
====

== Cours de PHILIT sur les certifications AZ-104 et l'AZ-305

De mon c√¥t√©, je vais commencer par suivre les cours en ligne de PHILIT : https://www.youtube.com/playlist?list=PLxf9spw2semSHqq8XvRaiT9HNWzO054MT +
-> Il s'agit en fait de Philippe PAIOLA (philippe.paiola@gmail.com)

[TIP]
====
Philippe fait partie du Club Azure Insiders et poste r√©guli√®rement sur le Teams associ√© üòâ

-> Et pour ce que j'en vois, Philippe doit maintenant faire partie de Microsoft, il a une adresse interne : philippe.paiola@microsoft.com
====

Ressources conseill√©es par PHILIT pour se pr√©parer √† la certification : 

    * La *documentation Microsoft Learn* : https://docs.microsoft.com/fr-FR/learn/certifications/roles/administrator
        ** Parcours de formation Microsoft Learn AZ-104 Microsoft Azure Administrator : +
        https://learn.microsoft.com/fr-FR/credentials/certifications/exams/az-104/

    * Le blog de Thomas MAURER : https://www.thomasmaurer.ch/2020/03/az-104-study-guide-azure-administrator/

=== AZ-104 EP01 : Azure AD (AAD) & VNet

URL vid√©o PHILIT : https://www.youtube.com/watch?v=JoGL_Q7ihG8&list=PLxf9spw2semSHqq8XvRaiT9HNWzO054MT&index=1

==== Identit√© et ADD

* les identit√©s sont stock√©es dans l'*Azure Active Directory* (*AAD*) : ce service va permettre de g√©rer nos identit√©s Cloud

* 3 formes d'identit√© : 

    ** *Identit√© membre* (ou Cloud Native) : elle est issue de notre instance de l'AAD 
        
        *** Rappel : *instance de l'AAD = tenant*.

            **** 1 *tenant* est une *instance de l'AAD* qui est d√©di√©e √† un client.
            **** Chaque client de Microsoft a 1 tenant qui lui est d√©di√© et qui est unique. +
            -> 2 clients ne peuvent pas avoir le m√™me tenant
            **** Ce tenant est souvent repr√©sent√© par un nom de domaine qui correspond souvent au nom du client. +
            Exemple : "laposte.onmicrosoft.com" ou "toto.onmicrosoft.com"
        
        *** Donc, l'identit√© va √™tre de type "user@toto.onmicrosoft.com"

    ** *Identit√© synchronis√©e* : elle est issue de votre AD on-premises (ce dernier est souvent repr√©sent√© par un triangle)
        *** cet AD on-premises est bien souvent au nom de la soci√©t√© : toto.com
        *** cet AD va contenir : 
            **** des DC : Domain Controller / contr√¥leurs de domaines
                ***** un DC est une version server de notre syst√®me d'exploitation (OS). +
                Donc Windows server 2016 / 2019 peut devenir un contr√¥leur de domaine en ajoutant le r√¥le.
            **** des groupes
            **** des ordinateurs

        *** un utilisateur va ici √™tre "user@toto.com"
            **** donc cela peut √™tre notre email professionnel

        *** On se retrouve avec un Domain Active Directory qui va avoir plusieurs DC
            
            **** On va cr√©er une VM sur l'AD, et sur cette VM on va installer le produit *AAD Connect* (Azure AD Connect). +
            Le but de AAD Connect va √™tre de se connecter √† mon DC, de r√©cup√©rer la liste des users et des groupes, et de transf√©rer ces users et groupes dans votre tenant AAD. +
            image:AZ-104_AAD-VNet_01.jpg[]

            **** Et pour permettre que ces identit√©s on-premises soient bien synchronis√©es sur l'AAD, je vais aller dans le portail Azure, dans l'AAD, et dans *Custom domain names* je vais rajouter le nom de domaine "toto.com" (le nom de domain venant du on-premises)

    ** *Identit√© Guest* : un "invit√©" est un utilisateur qui vient d'un autre tenant
        *** "qui vient d'un autre tenant" : attention √† cette expression, d'apr√®s mes recherches, cela *peut tout simplement √™tre un utilisateur externe* qui n'a encore aucun compte sur un AD ou AAD.
        *** Exemple d'un prestataire d'ESN qui va √™tre embauch√© pour travailler avec le tenant de la soci√©t√© toto.com. +
        Pour que cela se fasse, il va avoir besoin d'une *invitation* : une personne chez toto.com va devoir inviter l'utilisateur √† se joindre au tenant de toto.onmicrosoft.com, ce qui va lui permettre d'avoir acc√®s √† un abonnement (subscription)

.Pour r√©sumer sur les identit√©s
[NOTE]
====
* Le *tenant* est la *repr√©sentation des identit√©s d'une entreprise dans le Cloud Azure*
* Ce tenant est livr√© en "xxx.onmicrosoft.com"
* Dans ce tenant, on va retrouver 3 types d'identit√©s : membre / identit√© synchronis√©e / Guest


* Un tenant va toujours √™tre rattach√© √† 1 ou plusieurs abonnements / subscriptions
    ** L'abonnement / subscription est ce qui va contenir nos ressources Cloud : VMs, BDDs, storage account, IA, etc.
    ** Cet abonnement / subscription est une fronti√®re d'administration et de facturation des ressources Cloud de la soci√©t√©
    ** Pour *acc√©der √† ces ressources*, on va avoir besoin d'un *syst√®me d'identit√©s*, et ce dernier c'est le *tenant Azure Active Directory*
* Un abonnement / subscription Azure a toujours une r√©f√©rence √† un tenant.
* Et ce tenant contient des identit√©s qui permettront, via l'Access Control (IAM) de donner des droits √† des utilisateurs ou √† des groupes.
* Et ces utilisateurs sont soit membre (cloud natif), soit synchronis√©, soit invit√© (guest).
====

WARNING: Un utilisateur qui est dans mon tenant n'a, par d√©faut, aucun acc√®s sur mes ressources Azure

.Tenant vs Directory vs Domain in AAD
[NOTE]
====
FAIRE VRAIMENT TRES ATTENTION, on trouve souvent de tr√®s mauvaises explications des relations entre ces 3 concepts, surtout entre tenant et directory. +
-> Certaines sont m√™mes tout simplement fausses, alors m√™me qu'elles sont donn√©es par un IT de Microsoft... üòì

N√©anmoins, voici un post de 2020/08 d'un IT de Microsoft sur les forums tech de Microsoft qui r√©pond bien et pr√©cis√©ment √† la question : +
https://techcommunity.microsoft.com/t5/azure/relationship-between-azure-active-directory-and-directory-tenant/m-p/1607755/highlight/true#M5873 

--
I understand your confusion. I agree there are several "terms" in Azure that seem to overlap or could be synonyms. In addition, you might see these terms used inconsistently in the Portal UI or documentation.

I always try to approach it from the practical point of view, for example:

    * Can I create a new Azure AD tenant and if yes, how is it related to my existing environment?
    * Can I create several directories under that tenant?
    * Can I have several domains under my tenant?

I like to use this article written for AAD developers as a reference: https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-create-new-tenant#use-an-...

I saw some confusing or even wrong replies in the "linked" topic like someone claiming you can have several directories under one AAD tenant.

I see it this way : *Azure AD tenant = directory*, and *there is a strict 1:1 relationship between them* (you cannot create several directories under a tenant). Each tenant has it's globally unique '*tenant ID*' (in some places in the Portal referred as '*directory ID*', but *the ID is the same*)

*When you use 'Switch directories'* option in the Portal, *you are authenticating to a different AAD tenant* (your account was invited as a guest there via Azure AD B2B Collaboration), so you will see different subscriptions and resources, and have different permissions, when you do so. Since most organizations have one production tenant (but some like ISVs can have more), you are switching to a different "company". That's how I see it.

You can, however, have several domains under one tenant / directory. You always get a default one {something}.onmicrosoft.com, but you can onboard custom domains (like contoso.com) upon proving you own that domain.
--

-> J'ai demand√© des pr√©cisions √† Microsoft sur ce point via les Q&A de Microsoft Learn : +
https://learn.microsoft.com/en-us/answers/questions/1457968/help-me-to-understand-the-concepts-of-tenant-direc
====

* Cr√©ation d'un *custom role*
    ** le *scope* est vraiment la *port√©e* du r√¥le
    ** le r√¥le est repr√©sent√© par un fichier JSON

[WARNING]
====
La maintenance d'un *custom role* est r√©put√©e compliqu√©e. +
-> Contrairement √† un *built-in role*, les custom role ne sont PAS mis √† jour automatiquement lors des mises √† jour des services.
====

* Les utilisateurs d'un tenant peuvent avoir des r√¥les RBAC sur les ressources Azure *ET* sur le tenant lui-m√™me. +
Donc au final sur *Azure*, il y a *2 types de r√¥les* : ceux *sur le tenant*, et ceux *sur vos ressources Azure* : 

    ** *r√¥les dit "RBAC"* -> r√¥les sur vos ressources Azure

    ** *r√¥les sur le tenant* -> r√¥les qui vous permettent de g√©rer vos identit√©s
        *** exemple : "Billing administrator" pour g√©rer la facturation des logiciels, des licences que vous avez install√©s sur votre tenant

NOTE: On peut ajouter des licences √† un tenant pour lui ajouter des fonctionnalit√©s suppl√©mentaires

* L'*Azure Active Directory* sert √©galement √† la *publication de vos applications*.
    ** voir https://myapps.microsoft.com/[] pour visualiser les applications publi√©es sur votre tenant

* Les *applications publi√©es dans le tenant*, pour qu'elles fonctionnent et soient trust√©es par le tenant et vos utilisateurs, *doivent √™tre inscrites dans le tenant*.
    ** Pour ce faire, on passe par le Portail Azure, "Azure AD / Enterprise applications / All applications", puis "create your own application"
    ** Pour cette inscription dans le tenant, Azure va cr√©er un *compte de service* qui repr√©sente cette application, ce dernier est appel√© *service principal*.
        *** Le service principal est un compte d'application qui repr√©sente votre application dans le tenant.
        *** Le service principal est un compte manag√© par Microsoft : il a une dur√©e de vie, un certificat associ√©, et va permettre, quand vous publiez une application, de la rendre disponible √† vos utilisateurs.

* Auparavant, pour *acc√©der √† un AD on-premises*, on utilisait le protocole *LDAP*. +
Et pour *s'authentifier √† cet AD on-premises*, il y avait 2 moyens : 
    ** utiliser le protocole *Kerberos*
    ** utiliser le protocole *NTLM* (un vieux protocol d'authentification apparu avec Windows NT ou Windows 2000)

    ** -> Ces 2 m√©thodes d'authentification permettaient via des requ√™tes LDAP d'acc√©der √† votre AD on-premises.

* Aucun de ces protocols, LDAP, Kerberos ou NTLM n'est utilis√© dans l'Azure AD.
* Pour pouvoir acc√©der √† l'Azure AD, pour pouvoir vous y connecter, vous allez au pr√©alable passer par du HTTPS. +
Puis, une fois connect√©, vous allez pouvoir utiliser l'un des protocoles suivants pour pouvoir interroger l'Azure AD :  
    ** SAML
    ** WS Federation
    ** OAuth 2.0 et OpenID Connect

* Je vais √©galement pouvoir d√©l√©guer l'authentification de mes utilisateurs √† des tiers comme Google, Facebook, ou utiliser le protocole SAML / WS-fed
    ** Pour faire, aller dans son tenant, dans "external identities" puis "all identity providers"
* Donc il ne faut pas croire que le tenant AAD va permettre de g√©rer tous les cas de figures, on peut *d√©l√©guer l'authentification de certains types d'utilisateurs pour certaines applications √† des fournisseurs d'identit√©s externes*.
    ** C'est tr√®s utile lors de la cr√©ation d'une *web app* qui a *par d√©faut* un *acc√®s anonyme* : n'importe qui connaissant son IP publique ou son nom de domaine peut y acc√©der. Avec ce syst√®me, on va pouvoir rajouter une surcouche d'authentification √† la web app pour lui permettre d'√™tre authentifi√©e par des utilisateurs particuliers

* *DEMO* de la cr√©ation de cette *surcouche d'authentification pour une Web app* : https://youtu.be/JoGL_Q7ihG8?t=3069[] 
+
video::JoGL_Q7ihG8?t=3069[youtube, width=800, height=600]

    ** Pour ce faire, on va utiliser un service principal qui va repr√©senter cette web app dans l'Azure AD
    ** Cr√©ation d'une *web app* : 1 √† 2 min et *par d√©faut elle va avoir un acc√®s public*

.Rappel sur les web apps
[NOTE]
====
Une web app est un service web (une application web ou un site web) qui est h√©berg√© ET manag√© par Microsoft. +
La logique est de ne PAS avoir √† g√©rer le syst√®me d'exploitation. +
On peut faire du SSH dessus ou utiliser des commandes PowerShell, mais cela a lieu dans un environnement tr√®s cloisonn√© et tr√®s ferm√©.

Et comme tout service Azure PaaS, *par d√©faut*, la *web app* a une *IP publique* et un *nom de domaine* qui lui sont associ√©s.
====

    ** Pour "casser" cette logique d'acc√®s anonyme √† la web app, dans la web app, dans "authentication", je vais rajouter un fournisseur d'identit√© ("add identity provider") : je veux que ceux qui acc√®dent √† ma web app aient un compte dans mon tenant.
    ** Et je vais choisir "require authentication" plut√¥t que "allow unauthenticated access"

==== VNet, subnet, NIC, NSG

.VNet, subnet, NIC, VM, NSG
image:AZ-104_AAD-VNet_02.jpg[]

* VNet = espace d'adressage, voir RFC 1918 "Adress Allocation for Private Internets" : https://datatracker.ietf.org/doc/html/rfc1918[]
    ** Cette RFC d√©finit 3 espaces d'adressage (plages d'adresses) qui ne sont pas accessibles directement depuis Internet, des adressages dits *"non routables"* ; aucun serveur sur Internet ne peut utiliser ces adresses, qu'on appelle √©galement des *adresses IP priv√©es* : 
        *** 192.168
        *** 10.0
        *** 172.16
    ** Par d√©faut, 2 VNets (par exemple, un en 192.168 et un en 10.0) ne peuvent PAS communiquer ensemble. +
    Les subnets de ces VNets ne pourront pas communiquer ensemble.

* Un m√™me VNet peut contenir ces 3 espaces d'adressage, il n'est PAS limit√© √† 1 seul

* Un VNet va √™tre compartiment√© en 1 ou plusieurs *subnets* (sous-r√©seaux), comme un pizza que l'on couperait en morceaux avant de la manger
    ** *On ne peut PAS prendre les 3 premi√®res IP d'un subnet*, car r√©serv√©es par Microsoft √† la gestion DNS et la gestion des passerelles. +
    Toute la couche r√©seau et toute la couche IPAM dans Azure est d√©volu √† Microsoft
        *** Exemple : si mon subnet est en 10.0.0.0/24, je ne pourrais pas utiliser les IP 10.0.0.1, 10.0.0.2, 10.0.0.3. +
        Donc, ma NIC, si c'est la 1ere du subnet, sera en 10.0.0.4
    ** Dans les faits, les IPs 0 et 255 sont √©galement r√©serv√©es par Microsoft : 
        *** la *"0"* (10.0.0.0 dans l'exemple pr√©c√©dent) est l'*adresse de r√©seau* : c'est l'adresse IP de base du subnet qui est utilis√©e pour l'identifier.
        *** la *"255"* est l'IP de broadcast (Network broadcast address) : elle est utilis√©e pour envoyer des paquets √† tous les appareils du sous-r√©seau
    
* A tout moment, *on peut changer l'espace d'adressage d'un VNet*
    ** mais on ne peut pas r√©duire la taille d'un VNet en-dessous de la taille d'un de ses subnets
* On ne peut modifier la taille d'un subnet qu'AVANT de lui avoir ajout√© une ressource (comme une NIC), cela devient impossible apr√®s
    ** et la modification d'un subnet ne peut se faire qu'en respectant la limite de taille du VNet

* Dans un Subnet, on va souvent retrouver une *NIC* (*Network Interface Card*). +
Une NIC est une carte r√©seau qui va contenir : 
    ** *obligatoirement* une *IP priv√©e*
        *** Les adressages IP priv√©s sur Azure sont toujours *gratuites*
    ** *facultativement* une *IP publique*
        *** Les adressages IP publiques sont payantes (de l'ordre de 1‚Ç¨ par mois √† v√©rifier)

    ** ces 2 IPs peuvent √™tre : 
        *** *dynamique* : elle risque de changer √† chaque red√©marrage de la VM
        *** *statique*

* Cette NIC va souvent √™tre associ√©e √† une VM, et une VM doit TOUJOURS avoir une NIC : *une VM Azure sans NIC, cela n'existe pas*
    ** Donc une VM dans Azure a toujours une IP priv√©e, mais pas syst√©matiquement une IP publique

TIP: Donc, cf explication pr√©c√©dente, si on trouve une NIC dans un subnet, on ne peut donc plus modifier la taille de ce subnet

* Les *subnets* peuvent *par d√©faut communiquer en entrant et en sortant entre eux*.
    ** Ces communications sont autoris√©es pour 2 raisons : 

        *** les routes sont automatiquement propag√©es dans les subnets via un syst√®me appel√© les *system routes* +
        Les system routes : possibilit√© offerte par Azure de g√©rer les nouveaux subnets qui seraient cr√©√©s dans votre VNet de fa√ßon √† leur permettre de communiquer avec les autres subnets (propagation des routes automatis√©e)
            **** ‚ö†Ô∏è Attention ! Les system routes g√®rent *les subnet d'un MEME VNet*.
            **** Voir la doc Microsoft sur les system routes : https://learn.microsoft.com/en-us/azure/virtual-network/virtual-networks-udr-overview#system-routes
            **** Donc il y a des routes qui sont automatiquement g√©r√©es par Azure et que l'on ne peut PAS modifier

        *** Entre les subnets, il n'y a PAS de firewall. Donc, si on veut filtrer les flux, il va falloir ajouter un *NSG* (*Network Security Group*)
            **** *Le NSG est un firewall* qui va servir √† filtrer les flux entrants et sortants.

        *** Le NSG peut √™tre attribu√© √† une *NIC ET / OU √† un subnet* (ou √† plusieurs subnets) : 
            **** *attribu√© √† une NIC* : dans ce cas il va prot√©ger l'IP priv√©e et l'IP publique de votre VM
            **** *attribu√© √† un subnet* : il va alors filtrer les communications entre les diff√©rents subnets et entre les subnets et les r√©seaux distants (que ce soit Internet, ou une liaison VPN, ou une ExpressRoute)
            **** En l'absence de NSG associ√©e √† la carte r√©seau / NIC de ma VM, cette derni√®re devra √™tre prot√©g√©e par le firewall de l'OS (Windows avec les pare-feu fonctions avanc√©es, ou Linux avec IPTables)
        
        *** Seule limitation du NSG : il doit √™tre dans la m√™me r√©gion que les ressources √† prot√©ger. +
        Pour un VNet en North Europe, il faut obligatoirement cr√©er un NSG en North Europe pour le prot√©ger

* Dans la section "Virtual Network" du portal Azure, il est possible de faire *g√©n√©rer un diagramme r√©seau du VNet* via le menu *"Diagram"* : +
image:AZ-104_AAD-VNet_03.jpg[]
    ** Dans le diagramme donn√© en exemple, on peut voir que : 
        *** le VNet a 3 subnets
        *** que le subnet "Production" a une NIC
        *** que cette NIC est rattach√©e √† une VM, √† une IP publique et √† un NSG

.Toujours une NIC "primary" pour une VM
[NOTE]
====
Toute VM Azure a obligatoirement une NIC "primary" : +
image:AZ-104_AAD-VNet_04.jpg[]

Cela parce qu'une VM peut avoir plusieurs NIC, et donc autant d'adresses IP diff√©rentes. +
Mais m√™me si une VM a 200 NICs, et donc 200 IPs diff√©rentes, il y aura toujours une NIC "primary"

Cette NIC primary va surtout *servir pour tout ce qui est routage*, pour *"avoir le dernier mot"*.
====

* "Bon √† savoir" de Philippe : m√™me si on laisse l'IP publique d'une VM en dynamique (donc changement √† chaque arr√™t / red√©marrage), on peut y associer un DNS g√©r√© par Microsoft pour pouvoir toujours y acc√©der via un m√™me nom DNS.

* Les *NSG* sont dot√©s de *r√®gles de filtrage par d√©faut*, *class√©es par priorit√©* et que l'*on ne peut pas supprimer* : 

    ** *Flux entrants* : 
        *** prio 65000 - "AllowVnetInBound" : toutes les communications au sein d'un VNet entre les subnets sont autoris√©es
        *** prio 65001 - "AllowAzureLoadBalancerInBound" : un load balancer Azure doit pouvoir acc√©der aux VMs qui sont dans un subnet (logique, c'est le principe d'un load balancer)
        *** prio 65500 - "DenyAllInBound" : "on refuse tout"

    ** -> On peut pas supprimer ces r√®gles MAIS on peut en cr√©er d'autres avec une plus forte priorit√© (priorit√© plus forte = nombre plus petit)

    ** *Flux sortants* : 
        *** On retrouve 2 r√®gles similaires aux flux entrants : "AllowVnetOutBound" et "DenyAllOutBound"
        *** et 1 nouvelle r√®gle "AllowInternetOutbound" en prio 65001 : le trafic sortant sur une VM Azure est autoris√© vers internet
            **** Exemple : si on lance un navigateur sur une VM Azure et qu'on tape www.google.fr, on pourra s'y connecter via Internet

.Effective Security Rules : Comment s'y retrouver parmi un trop grand nombre de r√®gles NSG ? Qu'est-ce qui s'applique r√©ellement au final ?
[NOTE]
====
Dans votre NSG, vous avez un menu *"Effective security rules"* correspondant √† une fonctionnalit√© d'Azure qui va "r√©fl√©chir pour vous", en fonction des priorit√©s des r√®gles, du deny et du allow, √† celles qui s'appliquent r√©ellement au final. +
Celles-ci seront fournies sont forme de tableau.
====

* Le menu *"NSG Flow logs"* de votre NSG vous permet de visualiser √† tout moment les logs de ses flux entrant et sortant.
    ** Cela n√©cessite de mapper son NSG √† un storage account et de d√©finir une r√©tention pour les logs
+
WARNING: Par d√©faut, rien n'est conserv√©, c'est √† nous d'activer et de configurer ces logs

=== AZ-104 EP02 : Hub & Spoke et Azure Backup

URL vid√©o PHILIT : https://www.youtube.com/watch?v=EbZLEcDVF8g&list=PLxf9spw2semSHqq8XvRaiT9HNWzO054MT&index=2

==== Hub & spoke (peering, UDR, NVA...)

Rappel : Par d√©faut, 2 VNets (par exemple, un en 192.168 et un en 10.0) ne peuvent PAS communiquer ensemble. +
image:AZ-104_Hub-Spoke-backup_01.jpg[] +
(Dans l'exemple du sch√©ma, chaque VNet n'a qu'un seul subnet, qui occupe tout l'espace d'adressage du VNet)

* Si je veux permettre la communication entre ces VNets, je vais avoir 2 options : 

    ** le *peering* : beaucoup d'avantages pour cette solution, dont un faible co√ªt et simple √† mettre en oeuvre. +
    Le peering consiste √† raccorder entre eux les 2 VNets de fa√ßon √† montrer √† Azure qu'ils ne forment en fait qu'1 seul VNet "logique" (avec 2 subnets dans notre exemple)
        *** Pour que cela fonctionne, il faut que *les espaces d'adressage des 2 VNets soient diff√©rents* / ne se chevauchent pas.

    ** le *"VNet to VNet"* : dans cette solution, Azure va cr√©er un *VPN site √† site entre les 2 VNets*. +
    Le protocole *IPSec* (Internet Protocol Security) va √™tre utilis√© par ce VPN pour assurer le chiffrement des flux qui circulent entre les 2 VNets.
        *** Contrairement au peering, le VNet to VNet est cher, long √† mettre en place, pas forc√©ment tr√®s compliqu√©, mais c'est une techno qui "date un peu". +
        -> Tr√®s souvent en entreprise, *on lui pr√©f√®re le peering*.

image:AZ-104_Hub-Spoke-backup_02.jpg[]
    
.En quoi la connectivit√© VNet to VNet est-elle plus ch√®re que le peering ?
[NOTE]
====
* *Moins de ressources r√©seau* :

    ** Le *peering VNet* utilise l'*infrastructure dorsale Microsoft* (fait partie du r√©seau mondial Microsoft) pour √©tablir une connexion directe entre les r√©seaux virtuels.
    ** La *connectivit√© VNet √† VNet*, en revanche, n√©cessite des *passerelles VPN virtuelles* et des *tunnels VPN* pour acheminer le trafic entre les r√©seaux virtuels. Cela implique une utilisation accrue des ressources r√©seau, ce qui se traduit par des co√ªts plus √©lev√©s.

* *Pas de frais de transfert de donn√©es* :

    ** Le peering VNet ne facture pas de frais de transfert de donn√©es pour le trafic entre les r√©seaux virtuels pairs.
    ** La connectivit√© VNet √† VNet, en revanche, facture des frais de transfert de donn√©es pour le trafic transitant par les passerelles VPN.

* *Facilit√© d'utilisation* : Le peering VNet est simple √† configurer et √† g√©rer, l√† o√π la connectivit√© VNet √† VNet est plus complexe √† mettre en place et √† administrer, ce qui peut entra√Æner des co√ªts suppl√©mentaires.
====

.R√©seau mondial Microsoft et WAN Microsoft, Infrastructure dorsale et frontale
[NOTE]
====
* *R√©seau mondial Microsoft* :
    ** D√©finition: Il s'agit de l'infrastructure physique et logicielle qui connecte les centres de donn√©es Microsoft √† travers le monde.
    ** Composants: Il inclut l'*infrastructure dorsale Microsoft*, les *centres de donn√©es*, les points de pr√©sence et les r√©seaux m√©tropolitains.
        
        *** *Infrastructure dorsale* (Backhaul, le "c≈ìur" du r√©seau) : Transporte les donn√©es sur de longues distances entre les centres de donn√©es, les points de pr√©sence et les r√©seaux m√©tropolitains.
        *** *Infrastructure frontale* (Fronthaul,  la "p√©riph√©rie" du r√©seau) : Relie les utilisateurs finaux aux r√©seaux de communication, g√©n√©ralement sur la derni√®re portion du trajet.

    ** Fonction: Il achemine le trafic entre les services Microsoft et les clients √† travers le monde.

* *WAN mondial Microsoft* (r√©seau √©tendu mondial Microsoft) :
    ** D√©finition: Il s'agit d'un service Azure qui permet aux entreprises de cr√©er et de g√©rer un r√©seau priv√© virtuel (VPN) mondial.
    ** Composants: Il utilise le r√©seau mondial Microsoft comme infrastructure sous-jacente.
    ** Fonction: Il permet aux entreprises de connecter leurs sites distants et leurs utilisateurs √† leurs applications et donn√©es dans le cloud Azure.

En r√©sum√©:

    * Le r√©seau mondial Microsoft est l'infrastructure physique et logicielle qui permet aux services Microsoft de fonctionner.
    * Le WAN mondial Microsoft est un service Azure qui utilise le r√©seau mondial Microsoft pour cr√©er un VPN mondial pour les entreprises.
====

*PEERING* :

image:AZ-104_Hub-Spoke-backup_03.jpg[]

    * *Tr√®s facile √† mettre en place* : le mettre en place entre 2 VNets prend *2 min*
    * *Pas cher* : Microsoft va juste facturer la bande passante entre  les 2 VNets
        ** et le *co√ªt de la bande passante entre 2 VNets*, surtout dans une m√™me r√©gion, n'est pas tr√®s √©lev√© 0.01‚Ç¨ / Go pour de l'inbound ou outbound data transfer (voir https://azure.microsoft.com/en-us/pricing/details/virtual-network/ et https://azure.microsoft.com/en-us/pricing/details/bandwidth/)

    * Peering regional : entre 2 VNets dans la m√™me r√©gion
    * Peering global : entre 2 VNets dans 2 r√©gions diff√©rentes (donc le peering peut √™tre *multi-r√©gion*)
        ** co√ªt plus √©lev√© que le peering regional, voir les 2 liens pr√©c√©dents
    
    * Le peering est *multi-abonnement* (*multi-suscription*) : une entreprise poss√©dant plusieurs souscriptions peut raccorder des VNets dans ces diff√©rentes souscriptions.
    
    * Le peering est *multi-tenant* : On va pouvoir *raccorder 2 VNets de 2 clients diff√©rents* (donc 2 clients diff√©rents vont pouvoir communiquer entre eux)
        ** Rappel : 1 tenant repr√©sente les identit√©s d'un client. +
        Si on a 2 tenants, c'est qu'on est face √† 2 clients diff√©rents
        ** Pour faire ce raccordement multi-tenant, il faut avoir un compte autoris√© dans les 2 tenants, il y a plusieurs manips √† faire, MAIS c'est possible
    
    * Le peering utilise le *protocole MACsec* (Media Access Control security), et permet de *chiffrer les flux* traversant les √©quipements Microsoft
        ** MAIS le chiffrement n'est *PAS activ√© par d√©faut*.
        ** MACsec ne chiffre que les flux entre les deux VNets. Il ne chiffre pas les flux entre les VNets et Internet ou entre les VNets et d'autres r√©seaux.
+
.Des d√©tails sur le protocol MACsec
[NOTE]
====
* MACsec uses a combination of *data integrity checks* and *encryption* to secure traffic traversing the link
    ** Voir https://www.juniper.net/documentation/us/en/software/junos/security-services/topics/topic-map/understanding_media_access_control_security_qfx_ex.html[]

* Media Access Control Security (MACsec) is a *layer2 security protocol* standardized by the IEEE that operates on Ethernet frames. It uses *AES GCM cryptography* with 128-bit key and 256-bit key versions. MACsec is designed to provide *authentication*, *confidentiality* and *integrity* for data transported on *point-to-point links in the enterprise Local Area Network (LAN)* using the Advanced Encryption Standard with Galois/Counter Mode (AES-GCM) data cryptography algorithm.
    ** Voir https://www.comcores.com/what-is-macsec/
====

*DEMO : cr√©ation de peering entre VNet Hub et VNet Spoke*
 
image:AZ-104_Hub-Spoke-backup_06.jpg[width=700]

    * on commence par cr√©er les 2 VNets
    * puis, sur l'un d'eux, on va dans "peerings", puis "add" pour ajouter un peering dans les 2 sens : VNet Hub vers VNet Spoke ET VNet Spoke vers VNet Hub

    * Option "Traffic to remote virtual network" : doit toujours √™tre activ√©e, le trafic devant se faire dans les 2 sens. +
    Si on bloque l'un des sens, le peering ne pourra PAS se faire (raison pour laquelle la valeur par d√©faut est "allow")

    * Option "*Traffic forwarded* from remote virtual network"
        ** Si j'ai cr√©√© 2 VNet spoke, tous 2 reli√©s √† un m√™me VNet hub, si mon hub re√ßoit un flux qui ne lui est pas destin√©, MAIS qui est destin√© √† un VNet avec lequel il est peer√©, *le hub va laisser passer le flux*.
        ** Donc, dans le mon exemple, le trafic forwarding permet √† VNet Hub, s'il re√ßoit un flux de VNet spoke √† destination de VNet spoke 2, de le laisser passer : (fl√®che verte sur le sch√©ma ci-dessous)
        image:AZ-104_Hub-Spoke-backup_04.jpg[]

    * Option "Virtual Network Gateway or Route Server" pour le *partage de la VNG* (Virtual Network Gateway) ou de l'ARS (Azure Route Server)
        ** En tant que VNet Hub, si on a une liaison VPN site √† site (S2S) avec son r√©seau on-premises, on va pouvoir partager cette liaison site √† site avec ses VNets spoke. +
        Un VNet spoke va donc pouvoir passer par le VNet hub pour acc√©der au r√©seau on-premises, et le r√©seau on-premises va pouvoir passer par le VNet hub pour acc√©der √† un VNet spoke : +
        image:AZ-104_Hub-Spoke-backup_05.jpg[]
        ** Le partage de la VNG vous permet, en tant que hub, de partager votre connexion VPN avec vos spoke et votre r√©seau on-premises
    
        ** La VNG est la repr√©sentation de mon VPN dans Azure : c'est un VPN avec une IP publique qui est manag√© par Microsoft

    * Les m√™mes options sont disponibles pour la connexion entre le Hub et le Spoke que pour celle entre le Spoke et le Hub.

    * Lorsque l'on clique sur "Add", on voit bien que Azure *cr√©e le peering dans les 2 sens* : +
    image:AZ-104_Hub-Spoke-backup_07.jpg[]
        ** Il faut 20 √† 30 sec pour que le peering soit effectif (peering status "connected")

[WARNING]
====
L√†, on vient de voir une d√©mo "th√©orique" de peering car entre 2 VNets uniquement, mais dans la *"vraie vie"* le *"Hub and Spoke"* n'est pas entre 2 VNets uniquement mais entre *plusieurs VNets* : 3 (minimum), 4, voire des centaines de VNets.

-> Quand on a plusieurs VNets de raccord√©s avec le Hub, on rentre dans une *topologie d'architecture* appel√©e le *"Hub and Spoke"*. +
On retrouve cette topologie d'architecture chez la plupart des Cloud providers (AWS, GCP) : +
Une "√©toile" avec un point central, le hub, raccord√© √† toutes ses extr√©mit√©s, les spokes : UN hub et DES spokes.
====

*HUB and SPOKE* (pour une infra 100% Azure uniquement, et PAS hybride) :

* le *hub* : va contenir tous les "services partag√©s" (que l'on ne va donc pas avoir besoin de red√©ployer dans les diff√©rents spokes) : 
    ** DC : les contr√¥leurs de domaines
    ** LB : les load balancers
    ** FW : les firewalls
    ** mon bastion

* le *spoke* : un spoke est d√©j√† un VNet. 

    ** Il va pouvoir *repr√©senter un environnement* : DEV, PROD, etc. +
    A chacun d'eux va √™tre associ√© un subnet, on va donc avoir *un VNet et plusieurs subnets*.

    ** un spoke peut √©galement *√™tre un VNet h√©berg√© chez un tiers*.
        *** Exemple : imaginez que vous travaillez avec une soci√©t√© partenaire qui √©dite un soft de notes de frais, h√©berg√© sur Azure. +
        Vous souhaitez peut-√™tre que vos collaborateurs acc√®dent √† ce soft directement au travers d'un IP priv√©e. +
        Pour ce faire, on va peerer notre hub avec un spoke qui contient l'infrastructure de gestion de notes de frais propos√©e par la soci√©t√© partenaire.

En r√©sum√© : 

    * *Le peering* est fait pour *peerer des environnements d'applicatifs* h√©berg√©s dans Azure, en PROD, PrePROD, etc. qui sont repr√©sent√©s par des spokes
    * Mais cela peut aussi √™tre *peerer un VNet distant* d'un partenaire d'une autre soci√©t√© pour pouvoir exploiter le logiciel qu'elle nous met √† disposition en *mode PaaS*.
    * le peering est la jonction de 2 VNets entre eux et le Hub and Spoke est une topologie d'architecture qui va nous permettre de faire des √©conomies.

Comment le *Hub and Spoke* permet-il de *faire des √©conomies* ?

    * Tous les services partag√©s du Hub vont pouvoir √™tre partag√©s via le peering avec les spokes.
        ** Sans cela, si par exemple dans le spoke Dev du pr√©c√©dent sch√©ma on avait eu besoin d'authentification AD, il aurait fallu d√©ployer nos DC dans le spoke. Idem pour tous les autres spokes ayant besoin d'acc√©der √† l'AD.

*Focus sur le peering dans le cas de la topologie d'architecture Hub and Spoke* : 

    * Pour fonctionner, le Hub and Spoke a *besoin d'autres services Azure* que le seul peering : +
    image:AZ-104_Hub-Spoke-backup_08.jpg[width=600]

        ** des *UDR*, User Defined Routes : une *table de routage* statique que l'on va appliquer √† des subnets
            *** Une UDR peut √™tre associ√©e √† plusieurs subnets MAIS un subnet ne peut √™tre associ√© qu'√† une seule UDR
        ** la fonctionnalit√© de *Traffic Forwarded*
        ** une *NVA*, Network Virtual Appliance : soit c'est une VM sur laquelle on a install√© le r√¥le "Routing and remote access", soit un Azure Firewall (ou un autre firewall comme du F5, du Fortinet, etc. L'avantage de l'Azure Firewall est d'√™tre un service manag√© par Microsoft, c'est du PaaS)

    * -> Tout ceci permet de *faire transiter les flux* entre un hub et un spoke qui veut communiquer avec un autre spoke
    
    * Dans le cas de l'exemple pr√©c√©dent, si VNet-Spoke veut communiquer avec VNet-Spoke2, il va falloir : +
    image:AZ-104_Hub-Spoke-backup_09.jpg[width=600]

        ** appliquer une *UDR* au subnet de VNet-Spoke
            *** cette UDR, une table de routage, va dire que, pour acc√©der √† 172.16.0.0/24 (correspond √† VNet-Spoke2), il va falloir que le prochain *bond* soit l'IP priv√©e de ma NVA, donc ici de l'Azure Firewall qui va √™tre cr√©√© dans le hub
        ** La *NVA*, Azure Firewall ou VM Windows, va √™tre d√©ploy√©e dans le Hub et va faire office de router : elle va router les paquets entre les diff√©rents spokes.
        ** le *Traffic Forwarded* : son r√¥le est de laisser les paquets transiter entre vos VNet-Spoke et VNet-Spoke2 en passant par le hub
    
    * -> Tout ceci va rendre le hub capable de faire transiter des paquets qui passent par lui mais ne lui sont pas destin√©s, mais sont destin√©s √† un VNet qu'il conna√Æt.

.Bond = liaison d'agr√©gation
[NOTE]
====
Un bond est une fonctionnalit√© permettant de regrouper plusieurs cartes r√©seau physiques en une seule interface r√©seau logique. +
Cela permet d'augmenter la bande passante et la redondance du r√©seau.
====

*DEMO : cr√©ation d'une UDR*

    * L'*UDR* est une table de routage venant *supplanter* l'autre table de routage d'Azure, √† savoir les *system routes*

        ** En fait, *les system routes peuvent vite √™tre supplant√©es* par 2 services Azure : 

            *** les *UDR* : table de routage toujours prioritaire par rapport aux system routes
            *** le *protocole BGP*, Border Gateway Protocol, qui va permettre de propager des routes dynamiquement. +
            Si le protocole BGP dit le contraire d'un system route, c'est lui qui prend le pas sur les chemins par d√©faut par les system routes
        ** donc l'ordre de priorit√© est 1) UDR -> 2) protocole BGP -> 3) System routes

    * Pour cr√©er une UDR, on recherche sur le Portal Azure "*Route tables*" +
    image:AZ-104_Hub-Spoke-backup_10.jpg[]
        ** Les UDR doivent toujours √™tre appliqu√©es √† des *subnets qui sont dans la m√™me r√©gion qu'elle*
        ** une fois l'UDR cr√©√©e, je vais lui ajouter une route : +
        image:AZ-104_Hub-Spoke-backup_11.jpg[]
        ** les "next hop type" et "next hop address" correspondent au type et √† l'IP du prochain bond r√©seau, √† savoir une NVA qui sera ici un Azure Firewall et qui sera sur l'IP priv√©e 10.0.0.4, ce qui correspond √† la 1ere IP disponible dans un subnet (voir chapitre "VNet, subnet, NIC, NSG")
    
    * L√†, j'ai cr√©√© mon UDR et sa route, mais je ne l'ai appliqu√©e √† rien. +
    -> Je vais donc dans la section "subnets" de mon UDR, et je lui associe le subnet voulu (ici d'un de mes spokes) : +
    image:AZ-104_Hub-Spoke-backup_12.jpg[]

    * On pourrait √©galement cr√©er un Azure Firewall pour compl√©ter la mise en place de notre topologie Hub and Spoke. +
    Cr√©er un Azure Firewall est simple, mais prend une bonne 10e de minutes.
        ** L'Azure Firewall va avoir un subnet d√©di√© dans le hub et va permettre de faire communiquer les spokes entre eux en passant par le hub.
        ** Tout ceci va me permettre de router des paquets entre mes spokes tout en les faisant transiter par un point unique, le hub, et son Azure Firewall qui va filtrer les paquets et √™tre utilis√© comme routeur pour router les paquets entre les spokes.

==== Azure Backup : Mars agent, ABS et Recovery Service Vault

*Azure Backup* est un service PaaS permettant de *backuper 3 types de ressources* : 

    * 1Ô∏è‚É£ *VMs sur Azure* : que l'on va pouvoir backuper dans un *RSV*, *Recovery Service Vault*, le "coffre-fort" de vos backups +
    image:AZ-104_Hub-Spoke-backup_14.jpg[width=400]
        ** Ce RSV a une r√©tention th√©orique de 99 ann√©es
        ** Ce RSV va stocker votre backup dans un *storage account*, par d√©faut en *GRS* (Geo-Redondant Storage, votre backup sera donc redond√© dans une autre r√©gion)
            *** Ce storage account est manag√© par Microsoft, vous n'y aurez pas acc√®s et ne le verrez m√™me pas dans la console Azure MAIS il existera bien.

            *** Ce storage account est par d√©faut en GRS MAIS si jamais on ne veut pas de r√©plication dans une 2nd r√©gion, par exemple pour des contraintes r√©glementaires, on peut toujours AVANT le 1er backup, le passer √† ZRS (Zone-redundant storage) ou en LRS (Locally-redundant storage), et dans ce cas il n'y a PAS r√©plication dans une 2nd r√©gion. Mais d√®s lors si on perd sa SEULE r√©gion, on perd √©galement son backup. +
            -> Mais üî• *attention* üî•, une fois que le *1er backup a √©t√© effectu√©*, il n'est *PLUS possible de changer* le type de r√©plication +
            image:AZ-104_Hub-Spoke-backup_31.jpg[] +
            _-> Une fois effectu√©e la 1ere sauvegarde, les choix de "Storage replication type" seront gris√©s dans les propri√©t√©s du RSV_

+
.GRS, LRS, ZRS
[NOTE]
====
* *LRS* : *Locally-redundant storage*. Maintain 3 copies of my files in the same datacenter
* *ZRS* : *Zone-redundant storage*. Distributes data across multiple data centers in the same region 
* *GRS* : *Geo-redundant storage*. Distributes 6 copies of your files across 2 data centers (3 in the primary region, and 3 in the secondary one).
====

        ** Le RSV est obligatoirement dans la *m√™me r√©gion que la VM √† backuper*
        ** Ce storage account en GRS va permettre d'avoir une *copie du backup dans une autre r√©gion* ("Cross Region Restore") : +
        Si ma VM est en North Europe (NE), mon RSV doit obligatoirement √™tre cr√©√© en NE et son storage account va automatiquement √™tre r√©pliqu√© dans la r√©gion Pair de NE qui est West Europe (WE)

        ** Gros avantage de ce syst√®me, il va permettre la *mise en place d'un PCA* (Plan de Continuit√© d'Activit√©)
            *** Le jour o√π il y a une rupture de la normalit√© en NE, on va pouvoir restaurer notre VM en WE, ce qui va permettre le PCA : "j'ai un probl√®me sur une r√©gion A, je restaure ma sauvegarde dans une r√©gion B"
            *** Il ne s'agit *PAS de PRA* (Plan de Reprise d'Activit√©) : il n'est pas ici question de basculement, de failover ou de failback
+
.Failover et failback
[NOTE]
====
Voir : https://www.rubrik.com/insights/the-difference-between-failover-and-failback

* *Failover* is the ability to switch automatically and seamlessly to a reliable backup system. +
The failover operation switches production from a primary site to a backup (recovery) site.

* *Failback* returns production to the original (or new) primary location after a disaster (or a scheduled event) is resolved.

-> When an error is detected a failover workflow changes data sources to a recovery system while a failback workflow restores data back to the original state after a ransomware event or other corporate data loss.
====

        ** possibilit√© de faire des sauvegardes "FULL"
        ** *Soft Delete* √† 14 jours : il s'agit d'une corbeille ; quand on supprime une sauvegarde de VM, cette sauvegarde pourra toujours √™tre restaur√©e pendant 14 jours, apr√®s elle sera d√©finitivement supprim√©e.
            *** Le Soft Delete peut √™tre activ√© / d√©sactiv√© dans les Security Settings du RSV. +
            Si on le d√©sactive, on recevra dans la foul√©e un mail de Microsoft m'informant que la corbeille du RSV a √©t√© d√©sactiv√©e. +
            image:AZ-104_Hub-Spoke-backup_32.jpg[]

        ** Le backup peut √™tre configur√© *soit √† la cr√©ation* de la VM, *soit apr√®s*.

            *** *Backup configur√© lors de la cr√©ation de la VM* : +
            image:AZ-104_Hub-Spoke-backup_13.jpg[width=800]

            *** Backup configur√© APRES la cr√©ation de la VM -> *cr√©ation d'un Recovery Services Vault (RSV)* : 
            image:AZ-104_Hub-Spoke-backup_15.jpg[] 
            image:AZ-104_Hub-Spoke-backup_16.jpg[]
                **** Ce RSV doit √™tre cr√©√© dans la m√™me r√©gion que la VM √† backuper
                **** Une fois le RSC cr√©√©, il reste √† la configurer : +
                image:AZ-104_Hub-Spoke-backup_17.jpg[]
                image:AZ-104_Hub-Spoke-backup_18.jpg[]
                {lb}
                Ici on indique que l'on souhaite backuper une VM tournant sur Azure. +
                -> On pourrait backuper d'autres types de ressources h√©berg√©es sur d'autres types d'environnement, comme du on-premises
                image:AZ-104_Hub-Spoke-backup_19.jpg[]
                **** Il faut ensuite d√©finir une *strat√©gie de backup* : r√©tention par semaine, par mois, par ann√©e, fr√©quence 
                image:AZ-104_Hub-Spoke-backup_20.jpg[]
                **** Il est possible de ne backuper QUE l'OS de la VM (son disque) sans les disques de donn√©es (probl√©matique de confidentialit√© par exemple) via l'option "OS Disk Only"

    * 2Ô∏è‚É£ Backup des infra *on-premises* - *Agent MARS* : *QUE pour des fichiers et dossiers sur Windows* +
    image:AZ-104_Hub-Spoke-backup_22.jpg[] +
    Si on a un serveur de fichiers sur Windows contenant des fichiers et des dossiers, on va pouvoir les backuper sur Azure, dans un RSV, via l'installation d'un logiciel appel√© l'*agent MARS* (Microsoft Azure Recovery Services)
        ** En installant l'agent, on va s√©lectionner les fichiers √† backuper Azure va se charger d'externaliser le backup dans un RSV
        ** Exemple : tous les mercredis Philippe s'en sert pour backuper son poste de travail Windows dans Azure. Pour ce faire, il a installer sur sa machine l'agent Azure Backup, et cet agent, repr√©sent√© par le fichier *mars.exe*, va permettre de sauvegarder vos ressources dans Azure +
        image:AZ-104_Hub-Spoke-backup_21.jpg[]
+
[NOTE]
====
Tout ce qui est *envoy√© VERS Azure* est *gratuit* en termes de flux r√©seau : tout mon backup externalis√©, toute la bande passante utilis√©e pour envoyer mes donn√©es dans mon RSV n'est pas factur√© par Microsoft. +
-> Microsoft ne *facture* que la bande passante *EN SORTIE* d'Azure, *au-del√† des premiers 5 Go*.

Attention ! Pour le backup dont parlait Philippe, la bande passante n'est pas factur√©e, mais il est factur√© pour la volum√©trie de stockage de son backup dans son RSV, donc dans son storage account.
====

        ** Si je choisis dans Azure Backup de backuper des "Files and folders" sur du "On-Premises", Azure va directement me proposer de t√©l√©charger l'agent MARS. +
        image:AZ-104_Hub-Spoke-backup_23.jpg[]
        image:AZ-104_Hub-Spoke-backup_24.jpg[]
            *** L'agent MARS va pouvoir conna√Ætre mon RSV via un fichier "VaultCredentials", t√©l√©chargeable sur la page et valable 10 jours : +
            image:AZ-104_Hub-Spoke-backup_25.jpg[]
                **** Ce fichier ne contient ni plus ni moins que le chemin vers votre RSV

    * 3Ô∏è‚É£ Backup des infra *on-premises* - *VM ABS* (Azure Backup Server) : *pour des VMs on-premises* +
    image:AZ-104_Hub-Spoke-backup_26.jpg[] +
    Si sur son infra on-premises on a des VMs, sur des hypervisuers Hyper-V ou VMWare, et des machines physiques, il est possible de les sauvegarder dans Azure en installant une VM dite "ABS" (Azure Backup Server) dans notre r√©seau on-premises.
        1. Cette VM va d√©ployer un agent sur nos machines physiques ou virtuelles, 
        2. agent qui va permettre de backuper nos machines physiques ou virtuelles sur la VM ABS 
        3. qui va ensuite externaliser ce backup dans votre RSV

        ** DEMO avec le backup de VMs sur Hyper-V et VMWare : +
        image:AZ-104_Hub-Spoke-backup_27.jpg[]
        ** Azure va alors vous proposer de t√©l√©charger le logiciel ABS pour l'installer sur un serveur on-premises : +
        image:AZ-104_Hub-Spoke-backup_28.jpg[]
        image:AZ-104_Hub-Spoke-backup_29.jpg[]
            *** Ce logiciel n√©cessite un Windows Server 2016 ou 2019 et la taille de son fichier d'install est de 4.2 Go +
            image:AZ-104_Hub-Spoke-backup_30.jpg[]

-> Il s'agit l√† des 3 m√©thodes de backup propos√©es par Azure, mais on peut √©galement parfaitement backuper avec du *Vim* ou du *Netbackup*

    * Ces services sont d'ailleurs propos√©s dans Azure
    * MAIS l'avantage d'*Azure Backup*, via les 3 m√©thodes propos√©es, est qu'il s'agit d'un *service PaaS* -> On ne manage PAS de VM. 
        ** Tout est g√©r√© au niveau de Microsoft dans le RSV.

=== AZ-104 EP03 : VPN S2S (Site √† Site), VNET-TO-VNET & PRA

URL vid√©o PHILIT : https://www.youtube.com/watch?v=cuWs3E1Zmm8&list=PLxf9spw2semSHqq8XvRaiT9HNWzO054MT&index=3

==== VPN S2S (Site √† Site dans Azure)

* *Plusieurs composants* sont requis pour cr√©er une *connexion VPN Site √† Site* avec Azure : 

    ** 1Ô∏è‚É£ le plus important, un *VNet* Azure : 
        *** un composant sp√©cifique va √™tre attribu√© √† ce VNET, le *Gateway subnet* : ce subnet va √™tre d√©di√© √† *recevoir les connexions distantes depuis vers VPN on-premises*.
        *** Ce VNET doit √™tre conforme √† la RFC 1918 "Adress Allocation for Private Internets" : https://datatracker.ietf.org/doc/html/rfc1918[]
        *** L'espace d'adressage de ce VNet doit √™tre diff√©rent de celui de votre espace d'adressage on-premises
    
    ** Dans votre r√©seau *on-premises*, il va y avoir un *composant VPN* (F5, Fortinet, Juniper, Checkpoint, etc.) qui *DOIT avoir une IP publique* afin que Azure puisse l'utiliser pour de se connecter au r√©seau on-premises.
        *** On peut √©galement utiliser comme VPN un Windows Server avec le r√¥le "Routing and Remote Access".

    ** Entre les 2, il faut cr√©er *une connexion VPN* qui va passer par le *r√©seau Internet*. +
    Pour cr√©er cette connexion VPN, on utilise 2 composants Azure : 
        
        *** 2Ô∏è‚É£ une *VNG*, Virtual Network Gateway : 
            **** C'est la *repr√©sentation du VPN Azure dans Azure*
            **** Elle a forc√©ment une *IP publique*

        *** 3Ô∏è‚É£ une *LNG*, Local Network Gateway : 
            **** C'est la *repr√©sentation de votre VPN on-premises*
            **** Elle a une IP publique qui correspond √† celle de votre VPN on-premises pour indiquer √† Azure √† quelle IP publique il doit se connecter pour atteindre votre r√©seau on-premises.
            
    ** 4Ô∏è‚É£ une *cl√© PSK* (Pre-shared key)
        *** Wikipedia : In cryptography, a pre-shared key (PSK) is a shared secret which was previously shared between the two parties using some secure channel before it needs to be used.
        *** Il s'agit d'une cl√© commune d√©finie √† la fois dans mon VPN on-premises et dans ma VNG afin de leur permettre de communiquer, s'authentifier et ainsi permettre la cr√©ation du tunnel IPsec entre eux.

.Tunnel IPSec, protocole IKE et cl√©s PSK
[NOTE]
====
* *What is IKE ?* (https://www.linkedin.com/advice/0/how-do-you-choose-between-ikev1-ikev2-ipsec[]) : 

    ** IKE (Internet Key Exchange) is a protocol that establishes a secure association between two peers, called Security Associations (SAs), that define how to encrypt and authenticate IPsec traffic. IKE also exchanges cryptographic keys and negotiates other parameters, such as the encryption algorithm, the authentication method, and the lifetime of the SAs. +
    IKE has two phases:

        *** phase 1 creates a secure channel between the peers, called the IKE SA
            **** Gemini : *Phase 1 de IKE* (Authentification) : *Utilise les cl√©s PSK* pour la v√©rification mutuelle de l'identit√© des participants.

        *** phase 2 creates one or more IPsec SAs to protect the actual data traffic.
            **** Gemini : *Phase 2 IKE* (√âchange de cl√©s et chiffrement) : *N√©gocie, g√©n√®re et √©change des cl√©s de chiffrement dynamiques* (comme des cl√©s AES), qui sont ensuite utilis√©es par IPSec pour prot√©ger les communications VPN.

* *Gemini* : 

    ** Le *protocole IKE* intervient en amont du processus IPSec, en √©tablissant une connexion s√©curis√©e et en n√©gociant les cl√©s de chiffrement n√©cessaires : 

        1. Une fois qu'IKE a r√©ussi l'*authentification entre les 2 parties*, soit par l'usage de certificats num√©riques, soit par l'utilisation d'une cl√© PSK partag√©e (alternative plus simple mais moins s√©curis√©e) 
        2. et qu'il a r√©ussi l'*√©change des cl√©s de chiffrement dynamiques* n√©cessaires √† la s√©curisation la communication VPN, 
        3. alors IPSec peut commencer √† chiffrer et √† authentifier les paquets de donn√©es qui traversent le tunnel VPN.

    ** IKE √©tablit une SA (*Security Association*) pour chaque canal de communication (entrant et sortant) du tunnel VPN. +
    -> La SA d√©finit les algorithmes de chiffrement, d'authentification et de mode de fonctionnement √† utiliser pour prot√©ger les communications.
        *** Les algorithmes d'authentification SA (Security Association) sont utilis√©s pour authentifier l'origine et l'int√©grit√© des paquets de donn√©es qui traversent le tunnel VPN. Ils font partie de la phase 2 d'IKE et de la n√©gociation IPSec.

    ** Les *cl√©s PSK*, quant √† elles, jouent un r√¥le crucial dans l'*authentification* mutuelle entre les parties prenantes dans le processus IKE. Elles permettent d'√©tablir une confiance mutuelle avant que les cl√©s de chiffrement IPSec ne soient n√©goci√©es et √©chang√©es. +
    Les cl√©s PSK doivent √™tre partag√©es de mani√®re s√©curis√©e entre les parties prenantes AVANT l'√©tablissement de la connexion VPN.
====

[NOTE]
====
Documentation Microsoft listant les principaux fournisseurs de *p√©riph√©riques VPN* : https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpn-devices

    * Pour chaque VPN, cette documentation donne le lien vers les informations de l'√©diteur pour la configuration de son VPN, y compris la partie configuration dans Azure.
    * Les param√®tres IKE phase 1 et phase 2 sont √©galement donn√©s en fin de page
====

* Le VPN on-premises peut √™tre configur√© soit en PolicyBased soit en RouteBased : 
    ** *RouteBased* : *√† pr√©f√©rer*, on gal√®re moins, car il va y avoir un *routage dynamique de propagation de routes* qui va √™tre utilis√© par le VPN Site √† Site
    ** *PolicyBased* : 
        *** tout doit √™tre d√©fini manuellement
        *** on aura en phase d'authentification QUE de l'IKE v1, et non le choix entre de la v1 ou de la v2
        *** sur un m√™me VPN, on ne pourra pas faire du Site √† Site et du Point √† Site. Les connexions VPN seront SOIT en Site √† Site SOIT en Point √† Site
+
.VPN Point √† Site vs VPN Site √† Site
[NOTE]
====
* Un *VPN Point √† Site* se configure au niveau du poste de travail. +
Il s'agit d'un *client lourd* √† installer et qui va permettre √† celui-ci de se connecter √† votre r√©seau virtuel Azure √† distance.

* Dans le cas d'un VPN Site √† Site, c'est l'int√©gralit√© de votre espace d'adressage on-premises que vous mettez potentiellement √† disposition pour se connecter √† votre VNet.
====

*DEMO* de configuration du *router Synology RT2600ac*, qui *fait aussi VPN*, de la cave de Philippe üòâ

    * Je commence par cr√©er un nouveau Resource group : RG-SYNO-VPN
        
    * Puis je cr√©e dans ce RG une 2Ô∏è‚É£ *nouvelle Virtual Network Gateway* (VNG)
        ** op√©ration que prend du temps sur Azure
        ** L'IP publique de cette VNG est l'IP que je vais devoir renseigner dans mon RT2600ac
        ** La VNG est un service manag√© par Azure, il y a donc peu d'options de configuration :

            *** cr√©ation d'une *connexion Point √† Site*
            *** *choix du SKU* (Basic, Standard, High Performance) qui va correspondre √† la bande passante associ√©e au VPN
                **** Plus le SKU est √©lev√© plus le VPN va co√ªter cher, mais plus la bande passante propos√©e par Microsoft va √™tre √©lev√©e
            *** *activer le mode "actif-actif"* pour le VPN : c'est √† dire avoir 2 liaisons VPN vers 2 p√©riph√©riques VPN on-premises en √©toile.
                **** Donc si l'un des 2 tombe, l'autre prend le relais

    * Cette VNG a besoin d'un 1Ô∏è‚É£ *VNet* pour fonctionner, ici VNET-AZURE
        ** parmi ses subnets, on voit un  *GatewaySubnet* (cr√©√© via le bouton "+ Gateway subnet") et qui est manag√© par Microsoft (/28 ou /29 minimum pour √™tre cr√©√© par Azure) +
        image:AZ-104_VPN-S2S-VNet-to-VNet-PRA_01.jpg[]

    * On va maintenant cr√©er la 3Ô∏è‚É£ *Local Network Gateway* (LNG) qui va contenir 2 informations importantes : 
        ** l'*IP publique* de notre VPN
        ** les *espaces d'adressage* qui auront le *droit d'acc√©der √† Azure* +
        image:AZ-104_VPN-S2S-VNet-to-VNet-PRA_02.jpg[]
            *** Sans ces derniers, quand bien m√™me notre connexion VPN serait effective (marqu√©e comme "connected"), on ne recevrait aucun flux du r√©seau on-premise car Azure les dropperait car non appartenant √† un espace autoris√©

    * On termine en cr√©ant une connexion VPN qui va utiliser : +
    image:AZ-104_VPN-S2S-VNet-to-VNet-PRA_03.jpg[]

        ** VNet : VNET-AZURE
        ** VNP
        ** LNG
        ** Shared key (cl√© PSK)

    * Pour information, dans ma VNG, je retrouve la configuration de la connexion Point √† Site que je peux d√©finir si besoin

{sb}

Quelques pr√©cisions sur le *VPN Point √† Site* : 

    * Le Point √† Site vous permet de t√©l√©charger un *client lourd* depuis le portail Azure
    * Une fois install√©, quand vous allez vous authentifier, celui-ci va utiliser un *syst√®me de certificats client / serveur* et donc c'est bien *votre poste de travail lui-m√™me qui va pouvoir se connecter √† Azure* +
    -> Ce client lourd ne va pas vous demander un login / mot de passe correspondant √† votre email professionnel, il va juste authentifier votre poste de travail.
        ** Pratique car cela permet d'*automatiser* d'une certaine fa√ßon une *connexion vers Azure √† base de certificats*, auto-g√©n√©r√©s sur votre poste de travail puis rajout√©s dans le magasin de certificats, via une console MMC (Microsoft Management Console), ou dans votre poste de travail Windows.

    * Plusieurs protocoles sont utilis√©s par le VPN Point √† Site :

        ** *SSTP* (Secure Socket Tunneling Protocol) de Microsoft : fonctionne sur le port 443
        ** *OpenVPN* : fonctionne lui aussi sur le port 443

        ** L'usage du *port 443* permet de *passer les pare-feux beaucoup plus facilement*, y compris sur votre poste de travail.
            *** G√©n√©ralement le HTTPS sur le port 443 est ouvert en sortie dans les entreprises

    * Avec un *VPN Point √† Site*, il est possible de *s'authentifier* : 
        ** soit *directement √† l'aide de son poste de travail* (comme expliqu√© plus haut)
        ** soit avec son *compte Azure Active Directory*
        ** soit avec son *compte Active Directory*, mais dans ce cas il vous faut un serveur RADIUS on-premises pour mapper le tout
+
.Protocole RADIUS
[NOTE]
====
RADIUS (Remote Authentication Dial-In User Service) est un *protocole client-serveur* permettant de *centraliser des donn√©es d'authentification*.
Le serveur RADIUS (install√© par exemple sur Linux) communique avec un client, appel√© NAS (network access server, par exemple un routeur CISCO).

image::AZ-104_VPN-S2S-VNet-to-VNet-PRA_04.png[width=600]
====

    * Si on utilise des certificats, il est possible de les auto-g√©n√©rer sur son poste de travail depuis une simple commande Powershell

==== TO BE COMPLETED









== Ressources

D'autres sites permettant de pr√©parer la certification :

    * Le cours Udemy de Alan Rodrigues (payant) : https://www.udemy.com/course/microsoft-certified-azure-administrator/
    * Ce site d'un personne ayant r√©ussi les anciens examens 303 et 304 et donnant quelques conseils et ressources : https://www.programmingwithwolfgang.com/how-to-pass-az-303-and-az-304-certification-exams/

    * Learning paths on MS Learn : https://learn.microsoft.com/en-us/certifications/azure-administrator/
    * MS Learn : https://docs.microsoft.com/en-us/learn/browse/?roles=administrator&products=azure
    * Azure Code Samples : https://azure.microsoft.com/en-us/resources/samples/?sort=0
    * Official Azure Documentation : https://docs.microsoft.com/en-us/azure/
    * Official Microsoft Azure YouTube Channel : https://www.youtube.com/user/windowsazure
    * L'excellent cours YouTube de PHILIT qui couvre l'AZ-104 et l'AZ-305 : https://www.youtube.com/playlist?list=PLxf9spw2semSHqq8XvRaiT9HNWzO054MT

Sites de *labs* et *workshops* pour pratiquer : 

    * Azure Citadel - Labs and Workshops : https://azurecitadel.com/
    * Microsoft Cloud Workshop - More labs and workshops : https://microsoftcloudworkshop.com/
    * Labs from Microsoft Training on GitHub : 
        ** https://github.com/MicrosoftLearning/AZ-303-Microsoft-Azure-Architect-Technologies : *LA* ressource officielle de Microsoft pour pratiquer l'AZ-303
        ** https://github.com/MicrosoftLearning/AZ-104-MicrosoftAzureAdministrator/
        ** Ces labs de Microsofts sont vraiment des guides "step by step" permettant de manipuler les technologies Azure autour d'un th√®me donn√©.

Sites d'examens blancs (*mock exams*), questions / r√©ponses pour s'entra√Æner : 

    * ExamTopics AZ-104 : https://www.examtopics.com/exams/microsoft/az-104/

Site pour se familiariser avec le site de certification de Microsoft : https://aka.ms/examdemo

== Mock exams

=== Free exam from XXX

----
Q1) Some question

 ‚úÖ good
 ‚ùå bad


Q2) Some other question
----

== Lexique

[glossary]
ABS:: Azure Backup Server
ACU:: Azure Compute Units. Notion used for Web Apps service plans to "give a number" to the pair processing speed / memory (like 100 ACU, 200 ACU, etc.)
ARS:: Azure Route Server
ASA:: Adaptive Security Appliances is a piece of cybersecurity hardware sold by Cisco
BGP:: Border Gateway Protocol
DC:: Domain Controller (pour un AD)
FQDN:: Fully Qualified Domain Name
GPO:: Group Policy Object
GRS:: Geo-Redundant Storage
IAM:: Identity and Access Management
IKE:: Internet Key Exchange. Le protocole IKE est charg√© de n√©gocier la connexion. Avant qu'une transmission IPSec puisse √™tre possible, IKE est utilis√© pour authentifier les deux extr√©mit√©s d'un tunnel s√©curis√© en √©changeant des cl√©s partag√©es.
IPAM:: IP Address Management
IPSec:: Internet Protocol Security
LNG:: Local Network Gateway
MACsec:: Media Access Control Security
MARS:: Microsoft Azure Recovery Services
MMC:: Microsoft Management Console
MX:: Mail eXchanger. A mail exchanger record (MX record) specifies the mail server responsible for accepting email messages on behalf of a domain name. It is a resource record in the Domain Name System (DNS).
NIC:: Network Interface
NSG:: Network Security Group
NVA:: Network Virtual Appliance
PCA:: Plan de Continuit√© d'Activit√©
PRA:: Plan de Reprise d'Activit√©
PSK:: Pre-shared key
RADIUS:: Remote Authentication Dial-In User Service. RADIUS est un protocole client-serveur permettant de centraliser des donn√©es d'authentification.
RBAC:: Role-Based Access Control
RCO:: Recovery Time Objectives
RPO:: Recovery Point Objectives
RSV:: Recovery Service Vault
SA:: Security Association
SKU:: *Stock-Keeping Unit* (SKU) is a generic inventory term, that allows to represent the different shapes of the product.
SSPR:: Self-Service Password Reset
SSTP:: Secure Socket Tunneling Protocol
UDR:: User Defined Route
UO:: Unit√© d'Organisation
UPN:: User Principal Name
VNG:: Virtual Network Gateway
WAN:: Wide Area Network. D√©signe le r√©seau informatique connectant les sites d'une entreprise entre eux et √† Internet. +
le SD WAN est √©volution du WAN lui conf√©rant davantage d'agilit√© et de flexibilit√©. +
Pour plus de d√©tails, voir https://www.pyxya.fr/le-wan-intelligent/wan-sd-wan-et-limites-actuelles/





























